# Build an image that can serve mlflow models.
FROM ubuntu:22.04

RUN apt-get -y update && DEBIAN_FRONTEND=noninteractive TZ=Etc/UTC apt-get install -y --no-install-recommends wget curl nginx ca-certificates bzip2 build-essential cmake git-core

# Setup Python via python-build-standalone (PBS)
ARG PY_VER=3.10.19
ARG PBS_REL=20260114
ARG PBS_BASE=https://github.com/astral-sh/python-build-standalone/releases/download
RUN ARCH=$(uname -m) && \
    PBS_FILE="cpython-${PY_VER}+${PBS_REL}-${ARCH}-unknown-linux-gnu-install_only.tar.gz" && \
    curl -fsSL -o /tmp/python.tar.gz "${PBS_BASE}/${PBS_REL}/${PBS_FILE}" && \
    mkdir -p /opt/python && \
    tar -xzf /tmp/python.tar.gz -C /opt/python --strip-components=1 && \
    rm /tmp/python.tar.gz && \
    ln -s /opt/python/bin/python3 /usr/bin/python && \
    ln -s /opt/python/bin/pip3 /usr/bin/pip
ENV PATH="/opt/python/bin:$PATH"
RUN pip install virtualenv




WORKDIR /opt/mlflow

# Install MLflow from local source
COPY mlflow-project /opt/mlflow
RUN pip install /opt/mlflow

# Install minimal serving dependencies
RUN python -c "from mlflow.models.container import _install_pyfunc_deps;_install_pyfunc_deps(None, False)"

ENV MLFLOW_DISABLE_ENV_CREATION=False
ENV ENABLE_MLSERVER=False

# granting read/write access and conditional execution authority to all child directories
# and files to allow for deployment to AWS Sagemaker Serverless Endpoints
# (see https://docs.aws.amazon.com/sagemaker/latest/dg/serverless-endpoints.html)
RUN chmod o+rwX /opt/mlflow/

# clean up apt cache to reduce image size
RUN rm -rf /var/lib/apt/lists/*

ENTRYPOINT ["python", "-c", "import sys; from mlflow.models import container as C; C._init(sys.argv[1], 'virtualenv')"]
