name: Remove Experimental Decorators

on:
  schedule:
    # Run on the 1st day of every month at 00:00 UTC
    - cron: "0 0 1 * *"
  workflow_dispatch: # Allow manual triggering

defaults:
  run:
    shell: bash

jobs:
  remove-decorators:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Only run on the main repository
    if: github.repository == 'mlflow/mlflow'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/create-github-app-token@d72941d797fd3113feb6b93fd0dec494b13a2547 # v1.12.0
        id: app-token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          token: ${{ steps.app-token.outputs.token }}
          ref: master

      - name: Configure git
        run: |
          git config user.name 'mlflow-app[bot]'
          git config user.email 'mlflow-app[bot]@users.noreply.github.com'

      - uses: ./.github/actions/setup-python

      - name: Create branch for changes
        id: branch
        run: |
          BRANCH_NAME="automated/remove-experimental-decorators-$(date +%Y-%m-%d-%H-%M-%S)"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          git checkout -b $BRANCH_NAME

      - name: Run remove_experimental_decorators script
        id: remove
        run: |
          python dev/remove_experimental_decorators.py > /tmp/removal_output.txt 2>&1
          SCRIPT_EXIT_CODE=$?
          cat /tmp/removal_output.txt

          if [ "$SCRIPT_EXIT_CODE" -ne 0 ]; then
            echo "WARNING: dev/remove_experimental_decorators.py failed with exit code ${SCRIPT_EXIT_CODE}" >&2
          fi

          # Check if any files were modified
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.remove.outputs.has_changes == 'true'
        env:
          BRANCH_NAME: ${{ steps.branch.outputs.branch_name }}
        run: |
          git add -A
          git commit -m "Remove experimental decorators older than 6 months

          This is an automated commit that removes @experimental decorators
          from functions and classes that have been marked as experimental
          for more than 6 months.

          Generated by: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          git push origin $BRANCH_NAME

      - name: Check for existing PR
        if: steps.remove.outputs.has_changes == 'true'
        id: check_pr
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const PR_TITLE = "Remove experimental decorators older than 6 months";
            const { repo, owner } = context.repo;
            const { data: searchResults } = await github.rest.search.issuesAndPullRequests({
              q: `repo:${owner}/${repo} is:pr is:open base:master "${PR_TITLE}" in:title`,
              per_page: 1,
            });

            if (searchResults.total_count > 0) {
              console.log(`An open PR already exists: ${searchResults.items[0].html_url}`);
              core.setOutput('pr_exists', 'true');
            } else {
              core.setOutput('pr_exists', 'false');
            }

      - name: Create Pull Request
        if: steps.remove.outputs.has_changes == 'true' && steps.check_pr.outputs.pr_exists == 'false'
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          BRANCH_NAME: ${{ steps.branch.outputs.branch_name }}
        run: |
          # Create the PR body from the removal output
          PR_BODY="This automated PR removes @experimental decorators that have been marked as experimental for more than 6 months.

          ## Changes

          \`\`\`
          $(cat /tmp/removal_output.txt)
          \`\`\`

          ---
          Generated by [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

          gh pr create \
            --title "Remove experimental decorators older than 6 months" \
            --body "$PR_BODY" \
            --base master \
            --head "$BRANCH_NAME" \
            --label "automated"

      - name: Upload removal output
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: removal-output
          path: /tmp/removal_output.txt
          if-no-files-found: ignore
