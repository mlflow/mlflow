name: Remove Experimental Decorators

on:
  schedule:
    # Run on the 1st day of every month at 00:00 UTC
    - cron: "0 0 1 * *"
  workflow_dispatch: # Allow manual triggering

defaults:
  run:
    shell: bash

jobs:
  remove-decorators:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Only run on the main repository
    if: github.repository == 'mlflow/mlflow'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/create-github-app-token@d72941d797fd3113feb6b93fd0dec494b13a2547 # v1.12.0
        id: app-token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          token: ${{ steps.app-token.outputs.token }}
          ref: master

      - name: Configure git
        run: |
          git config user.name 'mlflow-app[bot]'
          git config user.email 'mlflow-app[bot]@users.noreply.github.com'

      - uses: ./.github/actions/setup-python

      - name: Create branch for changes
        id: branch
        run: |
          BRANCH_NAME="automated/remove-experimental-decorators-$(date +%Y-%m-%d-%H-%M-%S)"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          git checkout -b $BRANCH_NAME

      - name: Run remove_experimental_decorators script
        id: remove
        run: |
          python dev/remove_experimental_decorators.py > /tmp/removal_output.txt 2>&1
          SCRIPT_EXIT_CODE=$?
          cat /tmp/removal_output.txt

          if [ "$SCRIPT_EXIT_CODE" -ne 0 ]; then
            echo "WARNING: dev/remove_experimental_decorators.py failed with exit code ${SCRIPT_EXIT_CODE}" >&2
            exit $SCRIPT_EXIT_CODE
          fi

          # Check if any files were modified
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.remove.outputs.has_changes == 'true'
        env:
          BRANCH_NAME: ${{ steps.branch.outputs.branch_name }}
        run: |
          git add -A
          git commit -m "Remove experimental decorators older than 6 months

          This is an automated commit that removes @experimental decorators
          from functions and classes that have been marked as experimental
          for more than 6 months.

          Generated by: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          git push origin $BRANCH_NAME

      - name: Create Pull Request
        if: steps.remove.outputs.has_changes == 'true'
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          BRANCH_NAME: ${{ steps.branch.outputs.branch_name }}
        run: |
          # Create the PR body from the removal output using a heredoc
          cat > /tmp/pr_body.txt <<'EOFBODY'
          This automated PR removes @experimental decorators that have been marked as experimental for more than 6 months.

          ## Changes

          ```
          EOFBODY
          cat /tmp/removal_output.txt >> /tmp/pr_body.txt
          cat >> /tmp/pr_body.txt <<'EOFBODY'
          ```

          ---
          Generated by [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOFBODY

          gh pr create \
            --title "Remove experimental decorators older than 6 months" \
            --body-file /tmp/pr_body.txt \
            --base master \
            --head "$BRANCH_NAME" \
            --label "automated"
