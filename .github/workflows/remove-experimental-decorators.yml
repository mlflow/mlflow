name: Remove Experimental Decorators

on:
  schedule:
    # Run on the 1st day of every month at 00:00 UTC
    - cron: "0 0 1 * *"
  workflow_dispatch: # Allow manual triggering

defaults:
  run:
    shell: bash

jobs:
  remove-decorators:
    runs-on: ubuntu-slim
    timeout-minutes: 5
    # Only run on the main repository
    if: github.repository == 'mlflow/mlflow'
    permissions:
      contents: write
      pull-requests: write
    env:
      RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
    steps:
      - uses: actions/create-github-app-token@d72941d797fd3113feb6b93fd0dec494b13a2547 # v1.12.0
        id: app-token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          token: ${{ steps.app-token.outputs.token }}

      - uses: ./.github/actions/setup-python

      - name: Run remove_experimental_decorators script
        id: remove
        run: |
          python dev/remove_experimental_decorators.py

          [[ -n $(git status --porcelain) ]] && has_changes=true || has_changes=false
          echo "has_changes=$has_changes" >> $GITHUB_OUTPUT

      - name: Create branch, commit and push changes
        if: steps.remove.outputs.has_changes == 'true'
        id: branch
        run: |
          git config user.name 'mlflow-app[bot]'
          git config user.email 'mlflow-app[bot]@users.noreply.github.com'

          TIMESTAMP=$(date +%Y-%m-%d-%H-%M-%S)
          BRANCH_NAME="automated/remove-experimental-decorators-${TIMESTAMP}"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          git checkout -b $BRANCH_NAME

          git add -A
          git commit -m "Remove expired experimental decorators

          Generated by: ${RUN_URL}"
          git push origin $BRANCH_NAME

      - name: Create Pull Request
        if: steps.remove.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          BRANCH_NAME: ${{ steps.branch.outputs.branch_name }}
        run: |
          gh pr create \
            --title "Remove expired experimental decorators" \
            --body "Generated by [workflow run](${RUN_URL})" \
            --base master \
            --head "$BRANCH_NAME"
