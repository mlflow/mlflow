name: codex

on:
  issue_comment:
    types: [created]
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  codex:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      models: read
      pull-requests: write
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: actions/setup-python@8d9ed9ac5c53483de85588cdf95a591a75ab9f55 # v5.5.0
      - name: Install codex
        run: |
          curl -L -o codex.tar.gz https://github.com/openai/codex/releases/download/rust-v0.25.0/codex-x86_64-unknown-linux-musl.tar.gz
          tar -xzf codex.tar.gz
          mv codex-x86_64-unknown-linux-musl codex
          chmod +x codex
          ./codex --version

      - name: Set up config
        run: |
          # https://github.com/openai/codex/blob/main/codex-rs/config.md
          mkdir -p ~/.codex
          cat <<'EOF' > ~/.codex/config.toml
          # https://github.com/marketplace/models/azure-openai/gpt-4-1
          # model = "openai/gpt-4.1"
          # model_provider = "github-models"
          model_verbosity = "high"
          approval_policy = "never"

          [model_providers.github-models]
          # https://docs.github.com/en/github-models/use-github-models/prototyping-with-ai-models#rate-limits
          name = "GitHub Models"
          base_url = "https://models.github.ai/inference"
          env_key = "GITHUB_TOKEN"
          wire_api = "chat"

          [mcp_servers.github]
          command = "docker"
          args = [
            "run",
            "-i",
            "--rm",
            "-e",
            "GITHUB_PERSONAL_ACCESS_TOKEN",
            "ghcr.io/github/github-mcp-server",
          ]
          env = { "GITHUB_PERSONAL_ACCESS_TOKEN" = "${{ secrets.GITHUB_TOKEN }}" }
          EOF

      - name: Fetch diff
        run: |
          python dev/better_diff.py --pr ${{ github.event.pull_request.html_url }} > PR_DIFF.txt
          head -n 100 PR_DIFF.txt

      - name: Prompt
        run: |
          cat <<'EOF' > AGENTS.md
          You're a helpful assistant to review PRs. Your task is to follow the instructions below
          and review the given PR.

          # Instructions
          1. Read `PR_DIFF.txt` and `dev/guides/python.md`.
          2. Carefully review the changes in the PR and identify the lines violating the style guide.
          3. If you find any issues, proceed to the next step without approval, otherwise skip the rest of the instructions.
          4. Use the `create_pending_pull_request_review` tool to start a review.
          5. Use the `add_comment_to_pending_review` tool to add comments to the review.
             - When commenting on a specific line, set the `subjectType` parameter to `LINE`.
               For multi-line comments, set both the `startLine` and `line` parameters.
             - Please remember to include `ðŸ¤– Generated by Codex` in your comments.
          6. Use the `submit_pending_pull_request_review` tool to submit the review.
          EOF

      - name: Run codex
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # codex sometimes hangs. Use timeout to prevent this.
          timeout 5m ./codex exec --skip-git-repo-check "Can you review ${{ github.event.pull_request.html_url }}?" || true
