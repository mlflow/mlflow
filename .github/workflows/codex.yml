name: codex

on:
  pull_request:

jobs:
  codex:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      models: read
      pull-requests: write
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: actions/setup-python@8d9ed9ac5c53483de85588cdf95a591a75ab9f55 # v5.5.0
      - name: Install codex
        run: |
          npm install -g @openai/codex

      - name: Set up confgi
        run: |
          # https://github.com/openai/codex/blob/main/codex-rs/config.md
          mkdir -p ~/.codex
          cat <<EOF > ~/.codex/config.toml
          model = "openai/gpt-4.1"
          model_provider = "github-models"

          [model_providers.github-models]
          # https://docs.github.com/en/github-models/use-github-models/prototyping-with-ai-models#rate-limits
          name = "GitHub Models"
          base_url = "https://models.github.ai/inference"
          env_key = "GITHUB_TOKEN"
          wire_api = "chat"

          [mcp_servers.github]
          command = "docker"
          args = [
            "run",
            "-i",
            "--rm",
            "-e",
            "GITHUB_PERSONAL_ACCESS_TOKEN",
            "ghcr.io/github/github-mcp-server",
          ]
          env = { "GITHUB_PERSONAL_ACCESS_TOKEN" = "${{ secrets.GITHUB_TOKEN }}" }
          EOF

      - name: Prompt
        run: |
          cat <<'EOF' > AGENTS.md
          You're a helpful assistant to review PRs.

          # Instructions

          1. Run `python dev/better_diff.py --pr <PR_URL>` to get the PR diff.
          2. Carefully analyze the PR diff and identify issues and improvements.
          3. Use the `create_pending_pull_request_review` tool to start a review.
          4. Use the `add_comment_to_pending_review` tool to add comments to the review.
            When commenting on a specific line, please remember to set the `subjectType` parameter to `LINE`.
            When commenting on a file, please remember to set the `subjectType` parameter to `FILE`.
            Please remember to include `ðŸ¤– Generated by Codex` in your comments to indicate that they were generated by the AI.
          5. Use the `submit_pending_pull_request_review` tool to submit the review.

          # Tips

          - Before starting your review, please remember to read the `.python-version` file
            and check what python version is used in the project.
          - It's perfectly fine to leave no comments. Do not feel obligated to provide feedback on every change.
          EOF

      - name: Run codex
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          codex --ask-for-approval=never exec --skip-git-repo-check --sandbox=danger-full-access "Can you review https://github.com/mlflow/mlflow/pull/17335?"
