name: codex

on:
  pull_request:

jobs:
  codex:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      models: read
      pull-requests: write
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: actions/setup-python@8d9ed9ac5c53483de85588cdf95a591a75ab9f55 # v5.5.0
      - name: Install codex
        run: |
          npm install -g @openai/codex

      - name: Set up confgi
        run: |
          # https://github.com/openai/codex/blob/main/codex-rs/config.md
          mkdir -p ~/.codex
          cat <<EOF > ~/.codex/config.toml
          model = "openai/gpt-4.1"
          model_provider = "github-models"

          [model_providers.github-models]
          name = "GitHub Models"
          base_url = "https://models.github.ai/inference"
          env_key = "GITHUB_TOKEN"
          wire_api = "chat"

          [mcp_servers.github]
          command = "docker"
          args = [
            "run",
            "-i",
            "--rm",
            "-e",
            "GITHUB_PERSONAL_ACCESS_TOKEN",
            "ghcr.io/github/github-mcp-server",
          ]
          env = { "GITHUB_PERSONAL_ACCESS_TOKEN" = "${{ secrets.GITHUB_TOKEN }}" }
          EOF

      - name: Run codex
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          codex --ask-for-approval=never exec --skip-git-repo-check --sandbox=workspace-write "Can you review https://github.com/mlflow/mlflow/pull/17335 and leave comments using create_pending_pull_request_review, add_comment_to_pending_review, and submit_pending_pull_request_review tools provided by the GitHub MCP server? When using add_comment_to_pending_review, make sure to set the subjectType parameter to 'LINE'. To get the PR diff, use 'python dev/better_diff.py --pr <PR_URL>'."
