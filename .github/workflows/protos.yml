name: Protos

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review
    paths:
      - .github/workflows/protos.yml
      - mlflow/protos/**
      - mlflow/java/client/src/main/java/com/databricks/api/proto/**
      - mlflow/server/graphql/** # graphql related code changes could trigger changes in the autogenerated schema
      - requirements/skinny-requirements.txt
      - requirements/core-requirements.txt

env:
  MLFLOW_HOME: /home/runner/work/mlflow/mlflow

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash --noprofile --norc -exo pipefail {0}

jobs:
  protos:
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.repository }}
          ref: ${{ github.event.inputs.ref }}
          submodules: recursive
      - name: Test building Docker image
        working-directory: dev
        env:
          DOCKER_BUILDKIT: 1
        run: |
          docker build -t gen-protos -f Dockerfile.protos .
          docker run --rm gen-protos protoc --version
      - name: Install dependencies
        run: |
          wget https://github.com/protocolbuffers/protobuf/releases/download/v3.19.4/protoc-3.19.4-linux-x86_64.zip -O /tmp/protoc.zip
          sudo unzip /tmp/protoc.zip -d /tmp/protoc
          sudo chmod -R 777 /tmp/protoc
          echo "/tmp/protoc/bin" >> $GITHUB_PATH
          pip install --upgrade pip
          pip install .
      - name: Run tests
        run: |
          ./dev/test-generate-protos.sh

      - name: Test
        run: |
          python -c "from google.protobuf.internal import api_implementation; assert api_implementation.Type() != 'python'"
          python -c "import mlflow"

          # Ensure mlflow works fine with the python backend. See the following link for more details:
          # https://github.com/protocolbuffers/protobuf/tree/main/python#implementation-backends
          export PROTOCOL_BUFFERS_PYTHON_IMPLEMENTATION=python
          python -c "from google.protobuf.internal import api_implementation; assert api_implementation.Type() == 'python'"
          python -c "import mlflow"
