name: PR Size Labeling

on:
  pull_request_target:
    # Only trigger on opened and closed to avoid excessive label churn
    types:
      - opened
      - closed
      - ready_for_review

defaults:
  run:
    shell: bash

jobs:
  label-pr-size:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-slim
    permissions:
      pull-requests: write
    timeout-minutes: 5
    steps:
      - env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          PR_LABELS: ${{ join(github.event.pull_request.labels.*.name, '\n') }}
        run: |
          size_label=$(node -e '
          const { GH_REPO: repo, PR_NUMBER: pr, PR_HEAD_SHA: sha, GH_TOKEN: token } = process.env;

          const GENERATED = [
            /^mlflow\/protos\/.*\.pyi$/,
            /_pb2(_grpc)?\.py$/,
            /^uv\.lock$/,
            /package-lock\.json$/,
            /yarn\.lock$/,
            /^docs\/api_reference\/source\/rest-api\.rst$/,
          ];

          const THRESHOLDS = {
            XS: 9,
            S: 49,
            M: 199,
            L: 499,
            XL: Infinity,
          };

          async function isGenerated(filename) {
            if (GENERATED.some((p) => p.test(filename))) return true;
            if (filename.endsWith(".java")) {
              try {
                const resp = await fetch(
                  `https://raw.githubusercontent.com/${repo}/${sha}/${filename}`,
                  { headers: { Range: "bytes=0-255" } }
                );
                if (resp.ok) {
                  const text = await resp.text();
                  if (text.includes("Generated by the protocol buffer compiler")) return true;
                }
              } catch (e) { console.warn(filename, e.message); }
            }
            return false;
          }

          function getSize(total) {
            return Object.entries(THRESHOLDS).find(([, max]) => total <= max)[0];
          }

          async function main() {
            let total = 0;
            const maxThreshold = Math.max(...Object.values(THRESHOLDS).filter(isFinite));
            for (let page = 1; ; page++) {
              const resp = await fetch(
                `https://api.github.com/repos/${repo}/pulls/${pr}/files?per_page=100&page=${page}`,
                { headers: { Authorization: `token ${token}` } }
              );
              const files = await resp.json();
              const done = files.length < 100;
              for (const f of files) {
                if (!(await isGenerated(f.filename))) {
                  total += f.additions + f.deletions;
                }
              }
              if (done || total > maxThreshold) break;
            }
            console.log(`size/${getSize(total)}`);
          }

          main();
          ')
          echo "Label: ${size_label}"

          # Update labels using gh CLI (existing labels from event payload)
          while read -r label; do
            [[ "$label" == size/* && "$label" != "$size_label" ]] && \
              gh pr edit "$PR_NUMBER" --remove-label "$label"
          done <<< "$PR_LABELS"

          if ! grep -qx "$size_label" <<< "$PR_LABELS"; then
            gh pr edit "$PR_NUMBER" --add-label "$size_label"
          fi
