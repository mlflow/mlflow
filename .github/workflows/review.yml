name: review

on:
  issue_comment:
    types: [created]
  pull_request:
    paths:
      - .github/workflows/review.yml
      - .claude/commands/pr-review.md
      - dev/mcps/review.py

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      models: read
      pull-requests: write
    timeout-minutes: 30
    if: >
      (github.event_name == 'pull_request' &&
       github.event.pull_request.head.repo.full_name == github.repository &&
       contains(fromJson('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.pull_request.author_association))
      ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(fromJson('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.issue.author_association) &&
       contains(fromJson('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association) &&
       startsWith(github.event.comment.body, '/pr-review'))
    steps:
      - name: Check authorization
        if: ${{ github.event_name == 'issue_comment' }}
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const { comment } = context.payload;

            // Check user association - only allow OWNER, MEMBER, or COLLABORATOR
            const authorAssociation = comment.author_association;
            const isAllowed = ['OWNER', 'MEMBER', 'COLLABORATOR'].includes(authorAssociation);

            let message;
            if (isAllowed) {
              const workflowUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
              message = `üöÄ [Review workflow started](${workflowUrl})`;
            } else {
              message = `‚ö†Ô∏è Only repository maintainers and collaborators are allowed to trigger this workflow. Your association: ${authorAssociation}`;
            }

            const updatedBody = `${comment.body}\n\n---\n${message}`;

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: comment.id,
              body: updatedBody,
            });

            if (!isAllowed) {
              throw new Error(`User not allowed to trigger workflow: ${comment.user.login} (association: ${authorAssociation})`);
            }
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: refs/pull/${{ github.event.pull_request.number || github.event.issue.number }}/merge
      - uses: astral-sh/setup-uv@f0ec1fc3b38f5e7cd731bb6ce540c5af426746bb # v6.1.0
      - name: Install Claude CLI
        run: |
          npm install -g @anthropic-ai/claude-code@2.0.24

      - name: Set up MCP servers
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          claude mcp add --transport stdio review --env "GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}" -- uv run --no-project dev/mcps/review.py

      - name: Review
        id: review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number || github.event.issue.number }}
        run: |
          OUTPUT=$(timeout 20m claude --print --verbose "/pr-review" || true)
          echo "output<<EOF" >> $GITHUB_OUTPUT
          echo "$OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Report review results
        if: ${{ github.event_name == 'issue_comment' }}
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          REVIEW_OUTPUT: ${{ steps.review.outputs.output }}
        with:
          script: |
            const { owner, repo } = context.repo;
            const { comment } = context.payload;
            const output = (process.env.REVIEW_OUTPUT || '').trim();

            if (!output) {
              console.log('Output is empty, skipping comment update');
              return;
            }

            const { data: currentComment } = await github.rest.issues.getComment({
              owner,
              repo,
              comment_id: comment.id,
            });

            const updatedBody = `${currentComment.body}\n\n---\n\n<details>\n<summary>Review results</summary>\n\n${output}\n\n</details>`;

            await github.rest.issues.updateComment({
              owner,
              repo,
              comment_id: comment.id,
              body: updatedBody
            });
