name: Collect Test Durations (Temporary)
on:
  workflow_dispatch:
  push:
    branches:
      - 'temp-durations-1756989960'

jobs:
  collect-durations:
    name: Collect test durations
    runs-on: ubuntu-latest
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix:
        group: [1, 2]
        include:
          - splits: 2
    steps:
      - uses: actions/checkout@v4
      - name: Install uv
        uses: astral-sh/setup-uv@v6
      - uses: ./.github/actions/free-disk-space
      - uses: ./.github/actions/setup-python
      - uses: ./.github/actions/setup-pyenv
      - uses: ./.github/actions/setup-java
      
      - name: Install ALL dependencies
        run: |
          # Clean up space before installing
          sudo apt clean
          df -h
          # Use the exact same dependency installation as master.yml jobs
          source ./dev/install-common-deps.sh --ml
          # Add all additional dependencies in a single uv pip install command for speed
          uv pip install --system -c requirements/constraints.txt             tf-keras '.[mlserver]' '.[genai]' pyspark             langchain langchain-community langchain-experimental             torch transformers 'shap<0.47.0' lightgbm xgboost             uvicorn 'litellm>=1.52.9' openai dspy 'optuna>=4'             typing_extensions 'pydantic<2'
          # Clean up after installation
          sudo apt clean
          df -h
      
      - name: Run tests
        run: |
          # Test with a small subset first - just version and basic tests
          pytest --splits=${ matrix.splits } --group=${ matrix.group }             --store-durations --durations-path=group_${ matrix.group }_durations.json             tests/test_version.py tests/utils/test_*.py -v || true
      
      - name: Verify duration file exists and show stats
        if: always()
        run: |
          echo "=== Duration file verification for group ${ matrix.group } ==="
          duration_file="group_${ matrix.group }_durations.json"
          if [ -f $duration_file ]; then
            echo "âœ“ Duration file exists: $duration_file"
            echo "File size: $(ls -lh $duration_file | awk '{print $5}')"
            echo "Number of test durations: $(python -c "import json; print(len(json.load(open('$duration_file'))))")"
            echo ""
            echo "=== First 20 lines of duration file ==="
            head -20 $duration_file
          else
            echo "ERROR: Duration file $duration_file not found!"
            echo "Current directory contents:"
            ls -la
          fi
      
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-durations-group-${ matrix.group }
          path: group_${ matrix.group }_durations.json
          retention-days: 7
