name: Kubernetes Workspace Provider Tests

on:
  pull_request:
    paths:
      - "kubernetes-workspace-provider/**"
      - ".github/workflows/kubernetes-workspace-provider-tests.yml"
  push:
    paths:
      - "kubernetes-workspace-provider/**"
      - ".github/workflows/kubernetes-workspace-provider-tests.yml"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

env:
  MLFLOW_HOME: ${{ github.workspace }}
  PIP_EXTRA_INDEX_URL: https://download.pytorch.org/whl/cpu
  PIP_CONSTRAINT: ${{ github.workspace }}/requirements/constraints.txt

jobs:
  tests:
    permissions:
      contents: read
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11"]
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
      - uses: ./.github/actions/setup-python
        with:
          python-version: ${{ matrix.python-version }}
      - name: Upgrade pip
        run: python -m pip install --upgrade pip
      - name: Install mlflow
        run: pip install -e . --progress-bar off
      - name: Install kubernetes workspace provider
        run: pip install -e "kubernetes-workspace-provider[dev]" --progress-bar off
      - name: Run provider tests
        working-directory: kubernetes-workspace-provider
        run: pytest
