name: Start MLflow Tracking Server in Background
description: Run MLflow tracking server with volume-mounted local repo

runs:
  using: composite
  steps:
    - name: Create Dockerfile for MLflow server
      shell: bash
      run: |
        cat > Dockerfile.mlflow << EOF
        FROM python:3.9-slim

        RUN apt-get update && apt-get install -y git

        WORKDIR /app

        EXPOSE 5000

        CMD pip install -e /app/mlflow-repo && mlflow server --host 0.0.0.0 --port 5000
        EOF

    - name: Build MLflow tracking server image
      shell: bash
      run: |
        docker build -t mlflow-tracking-server -f Dockerfile.mlflow .

    - name: Run MLflow tracking server container
      shell: bash
      run: |
        docker run -d --name mlflow-server -p 5000:5000 -v $(pwd):/app/mlflow-repo mlflow-tracking-server

    - name: Wait for server to start
      shell: bash
      run: |
        echo "Waiting for MLflow server to start..."
        for i in {1..30}; do
          if curl -s http://localhost:5000 > /dev/null; then
            echo "MLflow server is up!"
            exit 0
          fi
          echo "Waiting... ($i/30)"
          sleep 1
        done
        echo "Failed to start MLflow server"
        docker logs mlflow-server
        exit 1