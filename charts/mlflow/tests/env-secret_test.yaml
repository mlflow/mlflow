suite: Test MLflow environment secret

templates:
  - env-secret.yaml

release:
  name: mlflow

tests:
  - it: Should contain `MLFLOW_BACKEND_STORE_URL` if no existing secret is specified and backendStoreUrl is specified
    set:
      backendStore:
        existingSecret: ""
        createSecret:
          backendStoreUri: file:/my/local/dir
    asserts:
      - equal:
          path: data.MLFLOW_BACKEND_STORE_URI
          value: ZmlsZTovbXkvbG9jYWwvZGly

  - it: Should contain `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY` and `ca-bundle.crt`. if use S3 as artifact store
    set:
      artifactStore:
        enabled: true
        s3:
          enabled: true
          createSecret:
            accessKeyId: myAccessKeyId
            secretAccessKey: mySecretAccessKey
          createCaSecret:
            caBundle: xxxxxxx
    asserts:
      - equal:
          path: data.AWS_ACCESS_KEY_ID
          value: bXlBY2Nlc3NLZXlJZA==
      - equal:
          path: data.AWS_SECRET_ACCESS_KEY
          value: bXlTZWNyZXRBY2Nlc3NLZXk=
      - equal:
          path: data.AWS_CA_BUNDLE
          value: eHh4eHh4eA==

  - it: Should contain `keyfile.json` if use Google Cloud Storage as artifact store
    set:
      artifactStore:
        enabled: true
        gcp:
          enabled: true
          createSecret:
            keyFile: /path/to/keyfile.json
    asserts:
      - equal:
          path: data["keyfile.json"]
          value: L3BhdGgvdG8va2V5ZmlsZS5qc29u

  - it: Should contain `AZURE_STORAGE_CONNECTION_STRING` and `AZURE_STORAGE_ACCESS_KEY` if use Azure Blog Storage as artifact store
    set:
      artifactStore:
        enabled: true
        azure:
          enabled: true
          createSecret:
            azureStorageConnectionString: myAzureStorageConnectionString
            azureStorageAccessKey: myAzureStorageAccessKey
    asserts:
      - equal:
          path: data.AZURE_STORAGE_CONNECTION_STRING
          value: bXlBenVyZVN0b3JhZ2VDb25uZWN0aW9uU3RyaW5n
      - equal:
          path: data.AZURE_STORAGE_ACCESS_KEY
          value: bXlBenVyZVN0b3JhZ2VBY2Nlc3NLZXk=

  - it: Should contain `MLFLOW_OSS_KEY_ID` and `MLFLOW_OSS_KEY_SECRET` if use Alibaba Cloud OSS as artifact store
    set:
      artifactStore:
        enabled: true
        oss:
          enabled: true
          createSecret:
            accessKeyId: myAccessKeyId
            accessKeySecret: myAccessKeySecret
    asserts:
      - equal:
          path: data.MLFLOW_OSS_KEY_ID
          value: bXlBY2Nlc3NLZXlJZA==
      - equal:
          path: data.MLFLOW_OSS_KEY_SECRET
          value: bXlBY2Nlc3NLZXlTZWNyZXQ=
