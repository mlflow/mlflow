apiVersion: v1
kind: Secret
metadata:
  name: {{ include "mlflow.envSecretName" . }}
  labels:
    {{- include "mlflow.labels" . | nindent 4 }}
type: Opaque
data:
  {{- /* Backend Store */}}
  {{- $modes := list "serve-artifacts" "no-serve-artifacts" }}
  {{- if has .Values.trackingServer.mode $modes }}
  {{- if not .Values.backendStore.existingSecret }}
  {{- with .Values.backendStore.createSecret.backendStoreUri }}
  MLFLOW_BACKEND_STORE_URI: {{ . | b64enc }}
  {{- end }}
  {{- end }}
  {{- end }}
  
  {{- /* Use AWS S3 as aftifact store */}}
  {{- if .Values.artifactStore.s3.enabled }}
  {{- if not .Values.artifactStore.s3.existingSecret }}
  {{- with .Values.artifactStore.s3.createSecret.accessKeyId }}
  AWS_ACCESS_KEY_ID: {{ . | b64enc }}
  {{- end }}
  {{- with .Values.artifactStore.s3.createSecret.secretAccessKey }}
  AWS_SECRET_ACCESS_KEY: {{ . | b64enc }}
  {{- end }}
  {{- end }}
  {{- if not .Values.artifactStore.s3.existingCaSecret }}
  {{- with .Values.artifactStore.s3.createCaSecret.caBundle }}
  AWS_CA_BUNDLE: {{ . | b64enc }}
  {{- end }}
  {{- end }}
  {{- end }}

  {{- /* Use Google Cloud Storage as artifact store */}}
  {{- if .Values.artifactStore.gcp.enabled }}
  {{- if not .Values.artifactStore.gcp.existingSecret }}
  {{- with .Values.artifactStore.gcp.createSecret.keyFile }}
  keyfile.json: {{ . | b64enc }}
  {{- end }}
  {{- end }}
  {{- end }}

  {{- /* Use Azure Blog Storage as artifact store */}}
  {{- if .Values.artifactStore.azure.enabled }}
  {{- if not .Values.artifactStore.azure.existingSecret }}
  {{- with .Values.artifactStore.azure.createSecret.azureStorageConnectionString }}
  AZURE_STORAGE_CONNECTION_STRING: {{ . | b64enc }}
  {{- end }}
  {{- with .Values.artifactStore.azure.createSecret.azureStorageAccessKey }}
  AZURE_STORAGE_ACCESS_KEY: {{ . | b64enc }}
  {{- end }}
  {{- end }}
  {{- end }}

  {{- /* Use Alibaba Cloud Storage as artifact store */}}
  {{- if and .Values.artifactStore.oss.enabled }}
  {{- if not .Values.artifactStore.oss.existingSecret }}
  {{- with .Values.artifactStore.oss.createSecret.accessKeyId }}
  MLFLOW_OSS_KEY_ID: {{ . | b64enc }}
  {{- end }}
  {{- with .Values.artifactStore.oss.createSecret.accessKeySecret }}
  MLFLOW_OSS_KEY_SECRET: {{ . | b64enc }}
  {{- end }}
  {{- end }}
  {{- end }}
