"""
Fetch PR diff with filtering and line numbers.

Filters out auto-generated and non-reviewable files, then adds line numbers
for easier review comment placement. Supports stacked PRs by detecting the
"ðŸ¥ž Stacked PR" section and fetching only incremental changes.

Example:
    uv run .claude/skills/fetch-diff/fetch_diff.py https://github.com/<owner>/<repo>/pull/<number>
"""
# ruff: noqa: T201

import argparse
import json
import os
import re
import subprocess
import sys
from pathlib import Path
from typing import Any
from urllib.error import HTTPError
from urllib.request import Request, urlopen


def get_github_token() -> str:
    if token := os.environ.get("GITHUB_TOKEN"):
        return token
    try:
        return subprocess.check_output(["gh", "auth", "token"], text=True).strip()
    except (subprocess.CalledProcessError, FileNotFoundError):
        print("Error: GITHUB_TOKEN not found (set env var or install gh CLI)", file=sys.stderr)
        sys.exit(1)


def github_api_request(
    url: str, token: str, accept_header: str = "application/vnd.github.v3+json"
) -> str:
    headers = {
        "Accept": accept_header,
        "Authorization": f"token {token}",
    }

    req = Request(url, headers=headers)

    try:
        with urlopen(req) as response:
            return response.read().decode("utf-8")
    except HTTPError as e:
        body = e.read().decode("utf-8")
        raise RuntimeError(f"GitHub API error: {e.code} {e.reason} {body}") from e


def get_pr(owner: str, repo: str, pull_number: int, token: str) -> dict[str, Any]:
    url = f"https://api.github.com/repos/{owner}/{repo}/pulls/{pull_number}"
    response = github_api_request(url, token)
    return json.loads(response)


def extract_stacked_pr_base_sha(pr_body: str | None, head_ref: str) -> str | None:
    """Extract the base SHA from the stacked PR incremental diff link.

    In stacked PR descriptions, the current PR is marked with bold (double
    asterisks). Example stack tree::

        ## ðŸ¥ž Stacked PR
        - [branch_a](url) [Files changed](url)
          - [**branch_b**](url) [Files changed](url/files/abc123..def456)
            - [branch_c](url) [Files changed](url/files/def456..789ghi)

    We find the bold entry matching the branch name and extract the base SHA
    from ``/files/<base>..<head>``.
    """  # clint: disable=markdown-link
    if not pr_body or "Stacked PR" not in pr_body:
        return None

    # Find the line with bold branch name [**<branch>**], then extract /files/<base>..<head>
    marker = f"[**{head_ref}**]"
    for line in pr_body.split("\n"):
        if marker in line:
            if m := re.search(r"/files/(?P<base>[a-f0-9]{40})\.\.(?P<head>[a-f0-9]{40})", line):
                return m.group("base")

    return None


def fetch_compare_diff(owner: str, repo: str, base: str, head: str, token: str) -> str:
    url = f"https://api.github.com/repos/{owner}/{repo}/compare/{base}...{head}"
    return github_api_request(url, token, accept_header="application/vnd.github.v3.diff")


def fetch_pr_diff(owner: str, repo: str, pull_number: int, token: str) -> str:
    pr = get_pr(owner, repo, pull_number, token)
    head_sha = pr["head"]["sha"]
    head_ref = pr["head"]["ref"]
    if base_sha := extract_stacked_pr_base_sha(pr.get("body"), head_ref):
        # Stacked PR: fetch incremental diff from parent's head to current head
        print(
            f"Detected stacked PR, fetching incremental diff: {base_sha[:7]}..{head_sha[:7]}",
            file=sys.stderr,
        )
        return fetch_compare_diff(owner, repo, base_sha, head_sha, token)

    # Regular PR: fetch full diff
    url = f"https://api.github.com/repos/{owner}/{repo}/pulls/{pull_number}"
    return github_api_request(url, token, accept_header="application/vnd.github.v3.diff")


def should_exclude_file(file_path: str) -> bool:
    """Exclude auto-generated (protobuf, lock files) and large files (notebooks)."""
    path = Path(file_path)

    if path.suffix in {".py", ".pyi"} and path.is_relative_to("mlflow/protos"):
        return True

    if path.name in {"uv.lock", "yarn.lock", "package-lock.json"}:
        return True

    if path.suffix == ".java" and path.exists():
        with path.open() as f:
            first_line = f.readline()
        if "Generated by the protocol buffer compiler" in first_line:
            return True

    if path.suffix == ".ipynb":
        return True

    return False


def filter_diff(full_diff: str) -> str:
    lines = full_diff.split("\n")
    filtered_diff: list[str] = []
    in_included_file = False

    for line in lines:
        if line.startswith("diff --git"):
            if match := re.match(r"diff --git a/(.*?) b/(.*?)$", line):
                file_path = match.group(2)
                if file_path == "dev/null":
                    in_included_file = False
                else:
                    in_included_file = not should_exclude_file(file_path)
            else:
                in_included_file = False

            if in_included_file:
                filtered_diff.append(line)
        elif in_included_file:
            filtered_diff.append(line)

    # Add line numbers
    result_lines: list[str] = []
    old_line = 0
    new_line = 0

    for line in filtered_diff:
        if line.startswith("@@"):
            if match := re.match(r"@@ -(\d+)(?:,\d+)? \+(\d+)(?:,\d+)? @@", line):
                old_line = int(match.group(1))
                new_line = int(match.group(2))
            result_lines.append(line)
        elif line.startswith("diff --git"):
            if result_lines:
                result_lines.append("")
            result_lines.append(line)
        elif line.startswith("index ") or line.startswith("---") or line.startswith("+++"):
            result_lines.append(line)
        elif line.startswith("-"):
            result_lines.append(f"{old_line:5d}       | {line}")
            old_line += 1
        elif line.startswith("+"):
            result_lines.append(f"      {new_line:5d} | {line}")
            new_line += 1
        else:
            result_lines.append(f"{old_line:5d} {new_line:5d} | {line}")
            old_line += 1
            new_line += 1

    return "\n".join(result_lines)


def parse_pr_url(url: str) -> tuple[str, str, int]:
    if m := re.match(r"https://github\.com/([^/]+)/([^/]+)/pull/(\d+)", url):
        return m.group(1), m.group(2), int(m.group(3))
    raise ValueError(f"Invalid PR URL: {url}")


def main() -> None:
    parser = argparse.ArgumentParser(description="Fetch PR diff with filtering and line numbers")
    parser.add_argument(
        "pr_url", help="GitHub PR URL (e.g., https://github.com/owner/repo/pull/123)"
    )
    args = parser.parse_args()
    token = get_github_token()
    owner, repo, pull_number = parse_pr_url(args.pr_url)
    full_diff = fetch_pr_diff(owner, repo, pull_number, token)
    filtered = filter_diff(full_diff)
    print(filtered)


if __name__ == "__main__":
    main()
