"""
Fetch PR diff with filtering and line numbers.

Filters out auto-generated and non-reviewable files, then adds line numbers
for easier review comment placement.
"""
# ruff: noqa: T201

import argparse
import json
import os
import re
import subprocess
import sys
from pathlib import Path
from urllib.error import HTTPError
from urllib.request import Request, urlopen


def get_github_token() -> str:
    if token := os.environ.get("GITHUB_TOKEN"):
        return token
    try:
        return subprocess.check_output(["gh", "auth", "token"], text=True).strip()
    except (subprocess.CalledProcessError, FileNotFoundError):
        print("Error: GITHUB_TOKEN not found (set env var or install gh CLI)", file=sys.stderr)
        sys.exit(1)


def github_api_request(
    url: str, token: str, accept_header: str = "application/vnd.github.v3+json"
) -> str:
    headers = {
        "Accept": accept_header,
        "Authorization": f"token {token}",
    }

    req = Request(url, headers=headers)

    try:
        with urlopen(req) as response:
            return response.read().decode("utf-8")
    except HTTPError as e:
        body = e.read().decode("utf-8")
        raise RuntimeError(f"GitHub API error: {e.code} {e.reason} {body}") from e


def fetch_pr_diff(owner: str, repo: str, pull_number: int, token: str) -> str:
    url = f"https://api.github.com/repos/{owner}/{repo}/pulls/{pull_number}"
    return github_api_request(url, token, accept_header="application/vnd.github.v3.diff")


def should_exclude_file(file_path: str) -> bool:
    """Exclude auto-generated (protobuf, lock files) and large files (notebooks)."""
    path = Path(file_path)

    if path.suffix in {".py", ".pyi"} and path.is_relative_to("mlflow/protos"):
        return True

    if path.name in {"uv.lock", "yarn.lock", "package-lock.json"}:
        return True

    if path.suffix == ".java" and path.exists():
        with path.open() as f:
            first_line = f.readline()
        if "Generated by the protocol buffer compiler" in first_line:
            return True

    if path.suffix == ".ipynb":
        return True

    return False


def filter_diff(full_diff: str) -> str:
    lines = full_diff.split("\n")
    filtered_diff: list[str] = []
    in_included_file = False

    for line in lines:
        if line.startswith("diff --git"):
            if match := re.match(r"diff --git a/(.*?) b/(.*?)$", line):
                file_path = match.group(2)
                if file_path == "dev/null":
                    in_included_file = False
                else:
                    in_included_file = not should_exclude_file(file_path)
            else:
                in_included_file = False

            if in_included_file:
                filtered_diff.append(line)
        elif in_included_file:
            filtered_diff.append(line)

    # Add line numbers
    result_lines: list[str] = []
    old_line = 0
    new_line = 0

    for line in filtered_diff:
        if line.startswith("@@"):
            if match := re.match(r"@@ -(\d+)(?:,\d+)? \+(\d+)(?:,\d+)? @@", line):
                old_line = int(match.group(1))
                new_line = int(match.group(2))
            result_lines.append(line)
        elif line.startswith("diff --git"):
            if result_lines:
                result_lines.append("")
            result_lines.append(line)
        elif line.startswith("index ") or line.startswith("---") or line.startswith("+++"):
            result_lines.append(line)
        elif line.startswith("-"):
            result_lines.append(f"{old_line:5d}       | {line}")
            old_line += 1
        elif line.startswith("+"):
            result_lines.append(f"      {new_line:5d} | {line}")
            new_line += 1
        else:
            result_lines.append(f"{old_line:5d} {new_line:5d} | {line}")
            old_line += 1
            new_line += 1

    return "\n".join(result_lines)


def parse_pr_url(url: str) -> tuple[str, str, int]:
    match = re.match(r"https://github\.com/([^/]+)/([^/]+)/pull/(\d+)", url)
    if not match:
        raise ValueError(f"Invalid PR URL: {url}")
    return match.group(1), match.group(2), int(match.group(3))


def main() -> None:
    parser = argparse.ArgumentParser(description="Fetch PR diff with filtering and line numbers")
    parser.add_argument(
        "pr_url", help="GitHub PR URL (e.g., https://github.com/owner/repo/pull/123)"
    )
    args = parser.parse_args()

    try:
        token = get_github_token()
        owner, repo, pull_number = parse_pr_url(args.pr_url)
        full_diff = fetch_pr_diff(owner, repo, pull_number, token)
        filtered = filter_diff(full_diff)
        print(filtered)
    except Exception as e:
        print(json.dumps({"error": str(e)}), file=sys.stderr)
        sys.exit(1)


if __name__ == "__main__":
    main()
