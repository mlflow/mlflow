# ruff: noqa: T201
"""Fetch PR diff with filtering and line numbers for code review."""

from __future__ import annotations

import argparse
import asyncio
import re
import sys
from pathlib import Path

from skills.github import GitHubClient, parse_pr_url


def extract_stacked_pr_base_sha(pr_body: str | None, head_ref: str) -> str | None:
    """Extract the base SHA from the stacked PR incremental diff link.

    In stacked PR descriptions, the current PR is marked with bold (double
    asterisks). Example stack tree::

        ## Stacked PR
        - [branch_a](url) [Files changed](url)
          - [**branch_b**](url) [Files changed](url/files/abc123..def456)
            - [branch_c](url) [Files changed](url/files/def456..789ghi)

    We find the bold entry matching the branch name and extract the base SHA
    from ``/files/<base>..<head>``.
    """  # clint: disable=markdown-link
    if not pr_body or "Stacked PR" not in pr_body:
        return None

    # Find the line with bold branch name [**<branch>**], then extract /files/<base>..<head>
    marker = f"[**{head_ref}**]"
    for line in pr_body.split("\n"):
        if marker in line:
            if m := re.search(r"/files/(?P<base>[a-f0-9]{7,40})\.\.(?P<head>[a-f0-9]{7,40})", line):
                return m.group("base")

    return None


def should_exclude_file(file_path: str) -> bool:
    """Exclude auto-generated (protobuf, lock files) and large files (notebooks)."""
    path = Path(file_path)

    if path.suffix in {".py", ".pyi"} and path.is_relative_to("mlflow/protos"):
        return True

    if path.name in {"uv.lock", "yarn.lock", "package-lock.json"}:
        return True

    if path.suffix == ".java" and path.exists():
        with path.open() as f:
            first_line = f.readline()
        if "Generated by the protocol buffer compiler" in first_line:
            return True

    if path.suffix == ".ipynb":
        return True

    return False


def filter_diff(full_diff: str) -> str:
    """Filter out excluded files and add line numbers to diff."""
    lines = full_diff.split("\n")
    filtered_diff: list[str] = []
    in_included_file = False

    for line in lines:
        if line.startswith("diff --git"):
            if match := re.match(r"diff --git a/(.*?) b/(.*?)$", line):
                file_path = match.group(2)
                if file_path == "dev/null":
                    in_included_file = False
                else:
                    in_included_file = not should_exclude_file(file_path)
            else:
                in_included_file = False

            if in_included_file:
                filtered_diff.append(line)
        elif in_included_file:
            filtered_diff.append(line)

    # Add line numbers
    result_lines: list[str] = []
    old_line = 0
    new_line = 0

    for line in filtered_diff:
        if line.startswith("@@"):
            if match := re.match(r"@@ -(\d+)(?:,\d+)? \+(\d+)(?:,\d+)? @@", line):
                old_line = int(match.group(1))
                new_line = int(match.group(2))
            result_lines.append(line)
        elif line.startswith("diff --git"):
            if result_lines:
                result_lines.append("")
            result_lines.append(line)
        elif line.startswith("index ") or line.startswith("---") or line.startswith("+++"):
            result_lines.append(line)
        elif line.startswith("-"):
            result_lines.append(f"{old_line:5d}       | {line}")
            old_line += 1
        elif line.startswith("+"):
            result_lines.append(f"      {new_line:5d} | {line}")
            new_line += 1
        else:
            result_lines.append(f"{old_line:5d} {new_line:5d} | {line}")
            old_line += 1
            new_line += 1

    return "\n".join(result_lines)


async def fetch_diff(pr_url: str) -> str:
    owner, repo, pr_number = parse_pr_url(pr_url)

    async with GitHubClient() as client:
        pr = await client.get_pr(owner, repo, pr_number)
        head_sha = pr.head.sha
        head_ref = pr.head.ref

        if base_sha := extract_stacked_pr_base_sha(pr.body, head_ref):
            print(
                f"Detected stacked PR, fetching incremental diff: {base_sha[:7]}..{head_sha[:7]}",
                file=sys.stderr,
            )
            diff = await client.get_compare_diff(owner, repo, base_sha, head_sha)
        else:
            diff = await client.get_pr_diff(owner, repo, pr_number)

    return filter_diff(diff)


def register(subparsers: argparse._SubParsersAction[argparse.ArgumentParser]) -> None:
    parser = subparsers.add_parser("fetch-diff", help="Fetch PR diff with line numbers")
    parser.add_argument("pr_url", help="GitHub PR URL")
    parser.set_defaults(func=run)


def run(args: argparse.Namespace) -> None:
    result = asyncio.run(fetch_diff(args.pr_url))
    print(result)
