

<!DOCTYPE html>
<!-- source: docs/source/_modules/mlflow/sagemaker -->
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mlflow.sagemaker</title>
  
   
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="canonical" href="https://mlflow.org/docs/latest/_modules/mlflow/sagemaker.html">
  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    

    

  
    

  

  
  
    

  

  
  
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600" rel="stylesheet">
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/cards.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/grids.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/mobile.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/simple-cards.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/tabs.css" type="text/css" />
    
  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="MLflow 2.17.1.dev0 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>
<script type="text/javascript" src="../../_static/jquery.js"></script>
<script type="text/javascript" src="../../_static/underscore.js"></script>
<script type="text/javascript" src="../../_static/doctools.js"></script>
<script type="text/javascript" src="../../_static/tabs.js"></script>
<script type="text/javascript" src="../../_static/languagesections.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
<script type="text/javascript" src="../../_static/runllm.js"></script>

<body class="wy-body-for-nav" role="document">
  

  
  <nav class="wy-nav-top header" role="navigation" aria-label="top navigation">
    <ul>
  <li class="menu-toggle">
    <i data-toggle="wy-nav-top" class="wy-nav-top-menu-button db-icon db-icon-menu pull-left"></i>
    <a href="../../index.html" class="wy-nav-top-logo"
      ><img src="../../_static/MLflow-logo-final-black.png" alt="MLflow"
    /></a>
    <span class="version">2.17.1.dev0</span>
  </li>
</ul>
  </nav>
  <page>
    

    <nav data-toggle="wy-nav-shift" class="wy-nav-side relative">
      <div class="wy-side-scroll">
  <div class="wy-side-nav-search">
    

    

    
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
  </form>
</div>


    
  </div>

  <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
    
      <a href="../../index.html" class="main-navigation-home"><img src="../../_static/icons/nav-home.svg"> MLflow</a>
    

    
      

      
        <ul>
<li class="toctree-l1"><a class="reference internal" href="../../python_api/index.html">Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli.html">Command-Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../R-api.html">R API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../java_api/index.html">Java API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rest-api.html">REST API</a></li>
</ul>

      
    
  </div>

  <div role="contentinfo">
    

    <p>
      <a id='feedbacklink' href="https://github.com/mlflow/mlflow/blob/master/CONTRIBUTING.md" target="_blank">Contribute</a>
    </p>
  </div>
</div>
    </nav>

    <main class="wy-grid-for-nav">
      <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
        <div class="wy-nav-content">
          <div class="rst-content">
            










<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Documentation</a> <span class="db-icon db-icon-chevron-right"></span></li>
    
        <li><a href="../index.html">Module code</a> <span class="db-icon db-icon-chevron-right"></span></li>
    
    
      <li>mlflow.sagemaker</li>
    
    
    <!-- <li class="wy-breadcrumbs-aside">
      <a href="https://github.com/mlflow/mlflow/blob/master/docs/source/_modules/mlflow/sagemaker" class="fa fa-github"> Edit on GitHub</a>
    </li> -->
    
  </ul>
</div>
            <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
              <div itemprop="articleBody">
                
  <h1>Source code for mlflow.sagemaker</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The ``mlflow.sagemaker`` module provides an API for deploying MLflow models to Amazon SageMaker.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">Popen</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">import</span> <span class="nn">mlflow.version</span>
<span class="kn">from</span> <span class="nn">mlflow</span> <span class="kn">import</span> <span class="n">mleap</span><span class="p">,</span> <span class="n">pyfunc</span>
<span class="kn">from</span> <span class="nn">mlflow.deployments</span> <span class="kn">import</span> <span class="n">BaseDeploymentClient</span><span class="p">,</span> <span class="n">PredictionsResponse</span>
<span class="kn">from</span> <span class="nn">mlflow.environment_variables</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">MLFLOW_DEPLOYMENT_FLAVOR_NAME</span><span class="p">,</span>
    <span class="n">MLFLOW_SAGEMAKER_DEPLOY_IMG_URL</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">mlflow.exceptions</span> <span class="kn">import</span> <span class="n">MlflowException</span>
<span class="kn">from</span> <span class="nn">mlflow.models</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">mlflow.models.container</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">SERVING_ENVIRONMENT</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">mlflow.models.container</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">SUPPORTED_FLAVORS</span> <span class="k">as</span> <span class="n">SUPPORTED_DEPLOYMENT_FLAVORS</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">mlflow.models.model</span> <span class="kn">import</span> <span class="n">MLMODEL_FILE_NAME</span>
<span class="kn">from</span> <span class="nn">mlflow.protos.databricks_pb2</span> <span class="kn">import</span> <span class="n">INVALID_PARAMETER_VALUE</span><span class="p">,</span> <span class="n">RESOURCE_DOES_NOT_EXIST</span>
<span class="kn">from</span> <span class="nn">mlflow.tracking.artifact_utils</span> <span class="kn">import</span> <span class="n">_download_artifact_from_uri</span>
<span class="kn">from</span> <span class="nn">mlflow.utils.file_utils</span> <span class="kn">import</span> <span class="n">TempDir</span>
<span class="kn">from</span> <span class="nn">mlflow.utils.proto_json_utils</span> <span class="kn">import</span> <span class="n">dump_input_data</span>

<span class="n">DEFAULT_IMAGE_NAME</span> <span class="o">=</span> <span class="s2">&quot;mlflow-pyfunc&quot;</span>
<span class="n">DEPLOYMENT_MODE_ADD</span> <span class="o">=</span> <span class="s2">&quot;add&quot;</span>
<span class="n">DEPLOYMENT_MODE_REPLACE</span> <span class="o">=</span> <span class="s2">&quot;replace&quot;</span>
<span class="n">DEPLOYMENT_MODE_CREATE</span> <span class="o">=</span> <span class="s2">&quot;create&quot;</span>

<span class="n">DEPLOYMENT_MODES</span> <span class="o">=</span> <span class="p">[</span><span class="n">DEPLOYMENT_MODE_CREATE</span><span class="p">,</span> <span class="n">DEPLOYMENT_MODE_ADD</span><span class="p">,</span> <span class="n">DEPLOYMENT_MODE_REPLACE</span><span class="p">]</span>

<span class="n">DEFAULT_BUCKET_NAME_PREFIX</span> <span class="o">=</span> <span class="s2">&quot;mlflow-sagemaker&quot;</span>

<span class="n">DEFAULT_SAGEMAKER_INSTANCE_TYPE</span> <span class="o">=</span> <span class="s2">&quot;ml.m4.xlarge&quot;</span>
<span class="n">DEFAULT_SAGEMAKER_INSTANCE_COUNT</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">DEFAULT_REGION_NAME</span> <span class="o">=</span> <span class="s2">&quot;us-west-2&quot;</span>
<span class="n">SAGEMAKER_SERVING_ENVIRONMENT</span> <span class="o">=</span> <span class="s2">&quot;SageMaker&quot;</span>
<span class="n">SAGEMAKER_APP_NAME_TAG_KEY</span> <span class="o">=</span> <span class="s2">&quot;app_name&quot;</span>

<span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">_full_template</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{account}</span><span class="s2">.dkr.ecr.</span><span class="si">{region}</span><span class="s2">.amazonaws.com/</span><span class="si">{image}</span><span class="s2">:</span><span class="si">{version}</span><span class="s2">&quot;</span>


<span class="k">def</span> <span class="nf">_get_preferred_deployment_flavor</span><span class="p">(</span><span class="n">model_config</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtains the flavor that MLflow would prefer to use when deploying the model.</span>
<span class="sd">    If the model does not contain any supported flavors for deployment, an exception</span>
<span class="sd">    will be thrown.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_config: An MLflow model object</span>

<span class="sd">    Returns:</span>
<span class="sd">        The name of the preferred deployment flavor for the specified model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">mleap</span><span class="o">.</span><span class="n">FLAVOR_NAME</span> <span class="ow">in</span> <span class="n">model_config</span><span class="o">.</span><span class="n">flavors</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mleap</span><span class="o">.</span><span class="n">FLAVOR_NAME</span>
    <span class="k">elif</span> <span class="n">pyfunc</span><span class="o">.</span><span class="n">FLAVOR_NAME</span> <span class="ow">in</span> <span class="n">model_config</span><span class="o">.</span><span class="n">flavors</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pyfunc</span><span class="o">.</span><span class="n">FLAVOR_NAME</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;The specified model does not contain any of the supported flavors for&quot;</span>
                <span class="s2">&quot; deployment. The model contains the following flavors: </span><span class="si">{model_flavors}</span><span class="s2">.&quot;</span>
                <span class="s2">&quot; Supported flavors: </span><span class="si">{supported_flavors}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">model_flavors</span><span class="o">=</span><span class="n">model_config</span><span class="o">.</span><span class="n">flavors</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                    <span class="n">supported_flavors</span><span class="o">=</span><span class="n">SUPPORTED_DEPLOYMENT_FLAVORS</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">),</span>
            <span class="n">error_code</span><span class="o">=</span><span class="n">RESOURCE_DOES_NOT_EXIST</span><span class="p">,</span>
        <span class="p">)</span>


<span class="k">def</span> <span class="nf">_validate_deployment_flavor</span><span class="p">(</span><span class="n">model_config</span><span class="p">,</span> <span class="n">flavor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks that the specified flavor is a supported deployment flavor</span>
<span class="sd">    and is contained in the specified model. If one of these conditions</span>
<span class="sd">    is not met, an exception is thrown.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_config: An MLflow Model object</span>
<span class="sd">        flavor: The deployment flavor to validate</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">flavor</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SUPPORTED_DEPLOYMENT_FLAVORS</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The specified flavor: `</span><span class="si">{</span><span class="n">flavor</span><span class="si">}</span><span class="s2">` is not supported for deployment.&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; Please use one of the supported flavors: </span><span class="si">{</span><span class="n">SUPPORTED_DEPLOYMENT_FLAVORS</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">),</span>
            <span class="n">error_code</span><span class="o">=</span><span class="n">INVALID_PARAMETER_VALUE</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">flavor</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">model_config</span><span class="o">.</span><span class="n">flavors</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;The specified model does not contain the specified deployment flavor:&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; `</span><span class="si">{</span><span class="n">flavor</span><span class="si">}</span><span class="s2">`. Please use one of the following deployment flavors&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; that the model contains: </span><span class="si">{</span><span class="n">model_config</span><span class="o">.</span><span class="n">flavors</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">),</span>
            <span class="n">error_code</span><span class="o">=</span><span class="n">RESOURCE_DOES_NOT_EXIST</span><span class="p">,</span>
        <span class="p">)</span>


<div class="viewcode-block" id="push_image_to_ecr"><a class="viewcode-back" href="../../python_api/mlflow.sagemaker.html#mlflow.sagemaker.push_image_to_ecr">[docs]</a><span class="k">def</span> <span class="nf">push_image_to_ecr</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">DEFAULT_IMAGE_NAME</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Push local Docker image to AWS ECR.</span>

<span class="sd">    The image is pushed under currently active AWS account and to the currently active AWS region.</span>

<span class="sd">    Args:</span>
<span class="sd">        image: Docker image name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">boto3</span>

    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Pushing image to ECR&quot;</span><span class="p">)</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;sts&quot;</span><span class="p">)</span>
    <span class="n">caller_id</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_caller_identity</span><span class="p">()</span>
    <span class="n">account</span> <span class="o">=</span> <span class="n">caller_id</span><span class="p">[</span><span class="s2">&quot;Account&quot;</span><span class="p">]</span>
    <span class="n">my_session</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
    <span class="n">region</span> <span class="o">=</span> <span class="n">my_session</span><span class="o">.</span><span class="n">region_name</span> <span class="ow">or</span> <span class="s2">&quot;us-west-2&quot;</span>
    <span class="n">fullname</span> <span class="o">=</span> <span class="n">_full_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">account</span><span class="o">=</span><span class="n">account</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">mlflow</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">VERSION</span>
    <span class="p">)</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Pushing docker image </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">fullname</span><span class="p">)</span>
    <span class="n">ecr_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;ecr&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ecr_client</span><span class="o">.</span><span class="n">describe_repositories</span><span class="p">(</span><span class="n">repositoryNames</span><span class="o">=</span><span class="p">[</span><span class="n">image</span><span class="p">])[</span><span class="s2">&quot;repositories&quot;</span><span class="p">]</span>
    <span class="k">except</span> <span class="n">ecr_client</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RepositoryNotFoundException</span><span class="p">:</span>
        <span class="n">ecr_client</span><span class="o">.</span><span class="n">create_repository</span><span class="p">(</span><span class="n">repositoryName</span><span class="o">=</span><span class="n">image</span><span class="p">)</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created new ECR repository: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
    <span class="c1"># TODO: it would be nice to translate the docker login, tag and push to python api.</span>
    <span class="c1"># x = ecr_client.get_authorization_token()[&#39;authorizationData&#39;][0]</span>
    <span class="c1"># docker_login_cmd = &quot;docker login -u AWS -p {token} {url}&quot;.format(token=x[&#39;authorizationToken&#39;]</span>
    <span class="c1">#                                                                ,url=x[&#39;proxyEndpoint&#39;])</span>

    <span class="n">docker_login_cmd</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;aws ecr get-login-password&quot;</span>
        <span class="s2">&quot; | docker login  --username AWS &quot;</span>
        <span class="s2">&quot;--password-stdin &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">account</span><span class="si">}</span><span class="s2">.dkr.ecr.</span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">.amazonaws.com&quot;</span>
    <span class="p">)</span>

    <span class="n">os_command_separator</span> <span class="o">=</span> <span class="s2">&quot;;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Windows&quot;</span><span class="p">:</span>
        <span class="n">os_command_separator</span> <span class="o">=</span> <span class="s2">&quot; &amp;&amp; &quot;</span>

    <span class="n">docker_tag_cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;docker tag </span><span class="si">{</span><span class="n">image</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">fullname</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">docker_push_cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;docker push </span><span class="si">{</span><span class="n">fullname</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">cmd</span> <span class="o">=</span> <span class="n">os_command_separator</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">docker_login_cmd</span><span class="p">,</span> <span class="n">docker_tag_cmd</span><span class="p">,</span> <span class="n">docker_push_cmd</span><span class="p">])</span>

    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Executing: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_deploy</span><span class="p">(</span>
    <span class="n">app_name</span><span class="p">,</span>
    <span class="n">model_uri</span><span class="p">,</span>
    <span class="n">execution_role_arn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">assume_role_arn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">bucket</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">image_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">region_name</span><span class="o">=</span><span class="s2">&quot;us-west-2&quot;</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="n">DEPLOYMENT_MODE_CREATE</span><span class="p">,</span>
    <span class="n">archive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">instance_type</span><span class="o">=</span><span class="n">DEFAULT_SAGEMAKER_INSTANCE_TYPE</span><span class="p">,</span>
    <span class="n">instance_count</span><span class="o">=</span><span class="n">DEFAULT_SAGEMAKER_INSTANCE_COUNT</span><span class="p">,</span>
    <span class="n">vpc_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">flavor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">synchronous</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">1200</span><span class="p">,</span>
    <span class="n">data_capture_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">variant_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">async_inference_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">serverless_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">tags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deploy an MLflow model on AWS SageMaker.</span>
<span class="sd">    The currently active AWS account must have correct permissions set up.</span>

<span class="sd">    This function creates a SageMaker endpoint. For more information about the input data</span>
<span class="sd">    formats accepted by this endpoint, see the</span>
<span class="sd">    :ref:`MLflow deployment tools documentation &lt;sagemaker_deployment&gt;`.</span>

<span class="sd">    Args:</span>
<span class="sd">        app_name: Name of the deployed application.</span>
<span class="sd">        model_uri: The location, in URI format, of the MLflow model to deploy to SageMaker.</span>
<span class="sd">            For example:</span>

<span class="sd">            - ``/Users/me/path/to/local/model``</span>
<span class="sd">            - ``relative/path/to/local/model``</span>
<span class="sd">            - ``s3://my_bucket/path/to/model``</span>
<span class="sd">            - ``runs:/&lt;mlflow_run_id&gt;/run-relative/path/to/model``</span>
<span class="sd">            - ``models:/&lt;model_name&gt;/&lt;model_version&gt;``</span>
<span class="sd">            - ``models:/&lt;model_name&gt;/&lt;stage&gt;``</span>

<span class="sd">            For more information about supported URI schemes, see</span>
<span class="sd">            `Referencing Artifacts &lt;https://www.mlflow.org/docs/latest/concepts.html#</span>
<span class="sd">            artifact-locations&gt;`_.</span>

<span class="sd">        execution_role_arn: The name of an IAM role granting the SageMaker service permissions to</span>
<span class="sd">            access the specified Docker image and S3 bucket containing MLflow</span>
<span class="sd">            model artifacts. If unspecified, the currently-assumed role will be</span>
<span class="sd">            used. This execution role is passed to the SageMaker service when</span>
<span class="sd">            creating a SageMaker model from the specified MLflow model. It is</span>
<span class="sd">            passed as the ``ExecutionRoleArn`` parameter of the `SageMaker</span>
<span class="sd">            CreateModel API call &lt;https://docs.aws.amazon.com/sagemaker/latest/</span>
<span class="sd">            dg/API_CreateModel.html&gt;`_. This role is *not* assumed for any other</span>
<span class="sd">            call. For more information about SageMaker execution roles for model</span>
<span class="sd">            creation, see</span>
<span class="sd">            https://docs.aws.amazon.com/sagemaker/latest/dg/sagemaker-roles.html.</span>
<span class="sd">        assume_role_arn: The name of an IAM cross-account role to be assumed to deploy SageMaker</span>
<span class="sd">            to another AWS account. If unspecified, SageMaker will be deployed to</span>
<span class="sd">            the the currently active AWS account.</span>
<span class="sd">        bucket: S3 bucket where model artifacts will be stored. Defaults to a</span>
<span class="sd">            SageMaker-compatible bucket name.</span>
<span class="sd">        image_url: URL of the ECR-hosted Docker image the model should be deployed into, produced</span>
<span class="sd">            by ``mlflow sagemaker build-and-push-container``. This parameter can also</span>
<span class="sd">            be specified by the environment variable ``MLFLOW_SAGEMAKER_DEPLOY_IMG_URL``.</span>
<span class="sd">        region_name: Name of the AWS region to which to deploy the application.</span>
<span class="sd">        mode: The mode in which to deploy the application. Must be one of the following:</span>

<span class="sd">            ``mlflow.sagemaker.DEPLOYMENT_MODE_CREATE``</span>
<span class="sd">                Create an application with the specified name and model. This fails if an</span>
<span class="sd">                application of the same name already exists.</span>

<span class="sd">            ``mlflow.sagemaker.DEPLOYMENT_MODE_REPLACE``</span>
<span class="sd">                If an application of the specified name exists, its model(s) is replaced with</span>
<span class="sd">                the specified model. If no such application exists, it is created with the</span>
<span class="sd">                specified name and model.</span>

<span class="sd">            ``mlflow.sagemaker.DEPLOYMENT_MODE_ADD``</span>
<span class="sd">                Add the specified model to a pre-existing application with the specified name,</span>
<span class="sd">                if one exists. If the application does not exist, a new application is created</span>
<span class="sd">                with the specified name and model. NOTE: If the application **already exists**,</span>
<span class="sd">                the specified model is added to the application&#39;s corresponding SageMaker</span>
<span class="sd">                endpoint with an initial weight of zero (0). To route traffic to the model,</span>
<span class="sd">                update the application&#39;s associated endpoint configuration using either the</span>
<span class="sd">                AWS console or the ``UpdateEndpointWeightsAndCapacities`` function defined in</span>
<span class="sd">                https://docs.aws.amazon.com/sagemaker/latest/dg/API_UpdateEndpointWeightsAndCapacities.html.</span>

<span class="sd">        archive: If ``True``, any pre-existing SageMaker application resources that become</span>
<span class="sd">            inactive (i.e. as a result of deploying in</span>
<span class="sd">            ``mlflow.sagemaker.DEPLOYMENT_MODE_REPLACE`` mode) are preserved.</span>
<span class="sd">            These resources may include unused SageMaker models and endpoint configurations</span>
<span class="sd">            that were associated with a prior version of the application endpoint. If</span>
<span class="sd">            ``False``, these resources are deleted. In order to use ``archive=False``,</span>
<span class="sd">            ``deploy()`` must be executed synchronously with ``synchronous=True``.</span>
<span class="sd">        instance_type: The type of SageMaker ML instance on which to deploy the model. For a list</span>
<span class="sd">            of supported instance types, see</span>
<span class="sd">            https://aws.amazon.com/sagemaker/pricing/instance-types/.</span>
<span class="sd">        instance_count: The number of SageMaker ML instances on which to deploy the model.</span>
<span class="sd">        vpc_config: A dictionary specifying the VPC configuration to use when creating the</span>
<span class="sd">            new SageMaker model associated with this application. The acceptable values</span>
<span class="sd">            for this parameter are identical to those of the ``VpcConfig`` parameter in</span>
<span class="sd">            the `SageMaker boto3 client&#39;s create_model method</span>
<span class="sd">            &lt;https://boto3.readthedocs.io/en/latest/reference/services/sagemaker.html</span>
<span class="sd">            #SageMaker.Client.create_model&gt;`_. For more information, see</span>
<span class="sd">            https://docs.aws.amazon.com/sagemaker/latest/dg/API_VpcConfig.html.</span>

<span class="sd">            .. code-block:: python</span>
<span class="sd">                :caption: Example</span>

<span class="sd">                    import mlflow.sagemaker as mfs</span>

<span class="sd">                    vpc_config = {</span>
<span class="sd">                        &quot;SecurityGroupIds&quot;: [</span>
<span class="sd">                            &quot;sg-123456abc&quot;,</span>
<span class="sd">                        ],</span>
<span class="sd">                        &quot;Subnets&quot;: [</span>
<span class="sd">                            &quot;subnet-123456abc&quot;,</span>
<span class="sd">                        ],</span>
<span class="sd">                    }</span>
<span class="sd">                    mfs.deploy(..., vpc_config=vpc_config)</span>

<span class="sd">        flavor: The name of the flavor of the model to use for deployment. Must be either</span>
<span class="sd">            ``None`` or one of mlflow.sagemaker.SUPPORTED_DEPLOYMENT_FLAVORS. If ``None``,</span>
<span class="sd">            a flavor is automatically selected from the model&#39;s available flavors. If the</span>
<span class="sd">            specified flavor is not present or not supported for deployment, an exception</span>
<span class="sd">            will be thrown.</span>
<span class="sd">        synchronous: If ``True``, this function will block until the deployment process succeeds</span>
<span class="sd">            or encounters an irrecoverable failure. If ``False``, this function will</span>
<span class="sd">            return immediately after starting the deployment process. It will not wait</span>
<span class="sd">            for the deployment process to complete; in this case, the caller is</span>
<span class="sd">            responsible for monitoring the health and status of the pending deployment</span>
<span class="sd">            via native SageMaker APIs or the AWS console.</span>
<span class="sd">        timeout_seconds: If ``synchronous`` is ``True``, the deployment process will return after</span>
<span class="sd">            the specified number of seconds if no definitive result (success or</span>
<span class="sd">            failure) is achieved. Once the function returns, the caller is</span>
<span class="sd">            responsible for monitoring the health and status of the pending</span>
<span class="sd">            deployment using native SageMaker APIs or the AWS console. If</span>
<span class="sd">            ``synchronous`` is ``False``, this parameter is ignored.</span>
<span class="sd">        data_capture_config: A dictionary specifying the data capture configuration to use when</span>
<span class="sd">            creating the new SageMaker model associated with this application.</span>
<span class="sd">            For more information, see</span>
<span class="sd">            https://docs.aws.amazon.com/sagemaker/latest/APIReference/API_DataCaptureConfig.html.</span>

<span class="sd">            .. code-block:: python</span>
<span class="sd">                :caption: Example</span>

<span class="sd">                import mlflow.sagemaker as mfs</span>

<span class="sd">                data_capture_config = {</span>
<span class="sd">                    &quot;EnableCapture&quot;: True,</span>
<span class="sd">                    &quot;InitalSamplingPercentage&quot;: 100,</span>
<span class="sd">                    &quot;DestinationS3Uri&quot;: &quot;s3://my-bucket/path&quot;,</span>
<span class="sd">                    &quot;CaptureOptions&quot;: [{&quot;CaptureMode&quot;: &quot;Output&quot;}],</span>
<span class="sd">                }</span>
<span class="sd">                mfs.deploy(..., data_capture_config=data_capture_config)</span>

<span class="sd">        variant_name: The name to assign to the new production variant.</span>
<span class="sd">        async_inference_config: The name to assign to the endpoint_config</span>
<span class="sd">            on the sagemaker endpoint.</span>
<span class="sd">            .. code-block:: python</span>
<span class="sd">                :caption: Example</span>

<span class="sd">                {</span>
<span class="sd">                    &quot;AsyncInferenceConfig&quot;: {</span>
<span class="sd">                        &quot;ClientConfig&quot;: {&quot;MaxConcurrentInvocationsPerInstance&quot;: 4},</span>
<span class="sd">                        &quot;OutputConfig&quot;: {</span>
<span class="sd">                            &quot;S3OutputPath&quot;: &quot;s3://&lt;path-to-output-bucket&gt;&quot;,</span>
<span class="sd">                            &quot;NotificationConfig&quot;: {},</span>
<span class="sd">                        },</span>
<span class="sd">                    }</span>
<span class="sd">                }</span>

<span class="sd">        serverless_config: An optional dictionary specifying the serverless configuration</span>
<span class="sd">            .. code-block:: python</span>
<span class="sd">                :caption: Example</span>

<span class="sd">                {</span>
<span class="sd">                    &quot;ServerlessConfig&quot;: {</span>
<span class="sd">                        &quot;MemorySizeInMB&quot;: 2048,</span>
<span class="sd">                        &quot;MaxConcurrency&quot;: 20,</span>
<span class="sd">                    }</span>
<span class="sd">                }</span>

<span class="sd">        env: An optional dictionary of environment variables to set for the model.</span>
<span class="sd">        tags: An optional dictionary of tags to apply to the endpoint.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">boto3</span>

    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">archive</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">synchronous</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;Resources must be archived when `deploy()` is executed in non-synchronous mode.&quot;</span>
                <span class="s2">&quot; Either set `synchronous=True` or `archive=True`.&quot;</span>
            <span class="p">),</span>
            <span class="n">error_code</span><span class="o">=</span><span class="n">INVALID_PARAMETER_VALUE</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">DEPLOYMENT_MODES</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;`mode` must be one of: </span><span class="si">{deployment_modes}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">deployment_modes</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DEPLOYMENT_MODES</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="n">error_code</span><span class="o">=</span><span class="n">INVALID_PARAMETER_VALUE</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">model_path</span> <span class="o">=</span> <span class="n">_download_artifact_from_uri</span><span class="p">(</span><span class="n">model_uri</span><span class="p">)</span>
    <span class="n">model_config_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">MLMODEL_FILE_NAME</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">model_config_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to find </span><span class="si">{</span><span class="n">MLMODEL_FILE_NAME</span><span class="si">}</span><span class="s2"> configuration within the specified model&#39;s &quot;</span>
                <span class="s2">&quot;root directory.&quot;</span>
            <span class="p">),</span>
            <span class="n">error_code</span><span class="o">=</span><span class="n">INVALID_PARAMETER_VALUE</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">model_config</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model_config_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">flavor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">flavor</span> <span class="o">=</span> <span class="n">_get_preferred_deployment_flavor</span><span class="p">(</span><span class="n">model_config</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_validate_deployment_flavor</span><span class="p">(</span><span class="n">model_config</span><span class="p">,</span> <span class="n">flavor</span><span class="p">)</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using the </span><span class="si">%s</span><span class="s2"> flavor for deployment!&quot;</span><span class="p">,</span> <span class="n">flavor</span><span class="p">)</span>

    <span class="n">assume_role_credentials</span> <span class="o">=</span> <span class="n">_assume_role_and_get_credentials</span><span class="p">(</span><span class="n">assume_role_arn</span><span class="o">=</span><span class="n">assume_role_arn</span><span class="p">)</span>

    <span class="n">s3_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;s3&quot;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">region_name</span><span class="p">,</span> <span class="o">**</span><span class="n">assume_role_credentials</span><span class="p">)</span>
    <span class="n">sage_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;sagemaker&quot;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">region_name</span><span class="p">,</span> <span class="o">**</span><span class="n">assume_role_credentials</span><span class="p">)</span>

    <span class="n">endpoint_exists</span> <span class="o">=</span> <span class="n">_find_endpoint</span><span class="p">(</span><span class="n">endpoint_name</span><span class="o">=</span><span class="n">app_name</span><span class="p">,</span> <span class="n">sage_client</span><span class="o">=</span><span class="n">sage_client</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">endpoint_exists</span> <span class="ow">and</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">DEPLOYMENT_MODE_CREATE</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;You are attempting to deploy an application with name: </span><span class="si">{</span><span class="n">app_name</span><span class="si">}</span><span class="s2"> in&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; &#39;</span><span class="si">{</span><span class="n">DEPLOYMENT_MODE_CREATE</span><span class="si">}</span><span class="s2">&#39; mode. However, an application with the same name&quot;</span>
                <span class="s2">&quot; already exists. If you want to update this application, deploy in&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; &#39;</span><span class="si">{</span><span class="n">DEPLOYMENT_MODE_ADD</span><span class="si">}</span><span class="s2">&#39; or &#39;</span><span class="si">{</span><span class="n">DEPLOYMENT_MODE_REPLACE</span><span class="si">}</span><span class="s2">&#39; mode.&quot;</span>
            <span class="p">),</span>
            <span class="n">error_code</span><span class="o">=</span><span class="n">INVALID_PARAMETER_VALUE</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">model_name</span> <span class="o">=</span> <span class="n">_get_sagemaker_model_name</span><span class="p">(</span><span class="n">endpoint_name</span><span class="o">=</span><span class="n">app_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">image_url</span><span class="p">:</span>
        <span class="n">image_url</span> <span class="o">=</span> <span class="n">_get_default_image_url</span><span class="p">(</span><span class="n">region_name</span><span class="o">=</span><span class="n">region_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">execution_role_arn</span><span class="p">:</span>
        <span class="n">execution_role_arn</span> <span class="o">=</span> <span class="n">_get_assumed_role_arn</span><span class="p">(</span><span class="o">**</span><span class="n">assume_role_credentials</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bucket</span><span class="p">:</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No model data bucket specified, using the default bucket&quot;</span><span class="p">)</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="n">_get_default_s3_bucket</span><span class="p">(</span><span class="n">region_name</span><span class="p">,</span> <span class="o">**</span><span class="n">assume_role_credentials</span><span class="p">)</span>

    <span class="n">model_s3_path</span> <span class="o">=</span> <span class="n">_upload_s3</span><span class="p">(</span>
        <span class="n">local_model_path</span><span class="o">=</span><span class="n">model_path</span><span class="p">,</span>
        <span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span>
        <span class="n">prefix</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
        <span class="n">region_name</span><span class="o">=</span><span class="n">region_name</span><span class="p">,</span>
        <span class="n">s3_client</span><span class="o">=</span><span class="n">s3_client</span><span class="p">,</span>
        <span class="o">**</span><span class="n">assume_role_credentials</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">endpoint_exists</span><span class="p">:</span>
        <span class="n">deployment_operation</span> <span class="o">=</span> <span class="n">_update_sagemaker_endpoint</span><span class="p">(</span>
            <span class="n">endpoint_name</span><span class="o">=</span><span class="n">app_name</span><span class="p">,</span>
            <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
            <span class="n">model_s3_path</span><span class="o">=</span><span class="n">model_s3_path</span><span class="p">,</span>
            <span class="n">model_uri</span><span class="o">=</span><span class="n">model_uri</span><span class="p">,</span>
            <span class="n">image_url</span><span class="o">=</span><span class="n">image_url</span><span class="p">,</span>
            <span class="n">flavor</span><span class="o">=</span><span class="n">flavor</span><span class="p">,</span>
            <span class="n">instance_type</span><span class="o">=</span><span class="n">instance_type</span><span class="p">,</span>
            <span class="n">instance_count</span><span class="o">=</span><span class="n">instance_count</span><span class="p">,</span>
            <span class="n">vpc_config</span><span class="o">=</span><span class="n">vpc_config</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
            <span class="n">role</span><span class="o">=</span><span class="n">execution_role_arn</span><span class="p">,</span>
            <span class="n">sage_client</span><span class="o">=</span><span class="n">sage_client</span><span class="p">,</span>
            <span class="n">s3_client</span><span class="o">=</span><span class="n">s3_client</span><span class="p">,</span>
            <span class="n">variant_name</span><span class="o">=</span><span class="n">variant_name</span><span class="p">,</span>
            <span class="n">async_inference_config</span><span class="o">=</span><span class="n">async_inference_config</span><span class="p">,</span>
            <span class="n">serverless_config</span><span class="o">=</span><span class="n">serverless_config</span><span class="p">,</span>
            <span class="n">data_capture_config</span><span class="o">=</span><span class="n">data_capture_config</span><span class="p">,</span>
            <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>
            <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">deployment_operation</span> <span class="o">=</span> <span class="n">_create_sagemaker_endpoint</span><span class="p">(</span>
            <span class="n">endpoint_name</span><span class="o">=</span><span class="n">app_name</span><span class="p">,</span>
            <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
            <span class="n">model_s3_path</span><span class="o">=</span><span class="n">model_s3_path</span><span class="p">,</span>
            <span class="n">model_uri</span><span class="o">=</span><span class="n">model_uri</span><span class="p">,</span>
            <span class="n">image_url</span><span class="o">=</span><span class="n">image_url</span><span class="p">,</span>
            <span class="n">flavor</span><span class="o">=</span><span class="n">flavor</span><span class="p">,</span>
            <span class="n">instance_type</span><span class="o">=</span><span class="n">instance_type</span><span class="p">,</span>
            <span class="n">instance_count</span><span class="o">=</span><span class="n">instance_count</span><span class="p">,</span>
            <span class="n">vpc_config</span><span class="o">=</span><span class="n">vpc_config</span><span class="p">,</span>
            <span class="n">data_capture_config</span><span class="o">=</span><span class="n">data_capture_config</span><span class="p">,</span>
            <span class="n">role</span><span class="o">=</span><span class="n">execution_role_arn</span><span class="p">,</span>
            <span class="n">sage_client</span><span class="o">=</span><span class="n">sage_client</span><span class="p">,</span>
            <span class="n">variant_name</span><span class="o">=</span><span class="n">variant_name</span><span class="p">,</span>
            <span class="n">async_inference_config</span><span class="o">=</span><span class="n">async_inference_config</span><span class="p">,</span>
            <span class="n">serverless_config</span><span class="o">=</span><span class="n">serverless_config</span><span class="p">,</span>
            <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>
            <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">synchronous</span><span class="p">:</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Waiting for the deployment operation to complete...&quot;</span><span class="p">)</span>
        <span class="n">operation_status</span> <span class="o">=</span> <span class="n">deployment_operation</span><span class="o">.</span><span class="n">await_completion</span><span class="p">(</span><span class="n">timeout_seconds</span><span class="o">=</span><span class="n">timeout_seconds</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">operation_status</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">_SageMakerOperationStatus</span><span class="o">.</span><span class="n">STATE_SUCCEEDED</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;The deployment operation completed successfully with message: &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="p">,</span>
                <span class="n">operation_status</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
                <span class="s2">&quot;The deployment operation failed with the following error message:&quot;</span>
                <span class="sa">f</span><span class="s1">&#39; &quot;</span><span class="si">{</span><span class="n">operation_status</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">archive</span><span class="p">:</span>
            <span class="n">deployment_operation</span><span class="o">.</span><span class="n">clean_up</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">app_name</span><span class="p">,</span> <span class="n">flavor</span>


<span class="k">def</span> <span class="nf">_delete</span><span class="p">(</span>
    <span class="n">app_name</span><span class="p">,</span>
    <span class="n">region_name</span><span class="o">=</span><span class="s2">&quot;us-west-2&quot;</span><span class="p">,</span>
    <span class="n">assume_role_arn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">archive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">synchronous</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delete a SageMaker application.</span>

<span class="sd">    Args:</span>
<span class="sd">        app_name: Name of the deployed application.</span>
<span class="sd">        region_name: Name of the AWS region in which the application is deployed.</span>
<span class="sd">        assume_role_arn: The name of an IAM cross-account role to be assumed to deploy SageMaker</span>
<span class="sd">            to another AWS account. If unspecified, SageMaker will be deployed to</span>
<span class="sd">            the the currently active AWS account.</span>
<span class="sd">        archive: If ``True``, resources associated with the specified application, such</span>
<span class="sd">            as its associated models and endpoint configuration, are preserved.</span>
<span class="sd">            If ``False``, these resources are deleted. In order to use</span>
<span class="sd">            ``archive=False``, ``delete()`` must be executed synchronously with</span>
<span class="sd">            ``synchronous=True``.</span>
<span class="sd">        synchronous: If `True`, this function blocks until the deletion process succeeds</span>
<span class="sd">            or encounters an irrecoverable failure. If `False`, this function</span>
<span class="sd">            returns immediately after starting the deletion process. It will not wait</span>
<span class="sd">            for the deletion process to complete; in this case, the caller is</span>
<span class="sd">            responsible for monitoring the status of the deletion process via native</span>
<span class="sd">            SageMaker APIs or the AWS console.</span>
<span class="sd">        timeout_seconds: If `synchronous` is `True`, the deletion process returns after the</span>
<span class="sd">            specified number of seconds if no definitive result (success or failure)</span>
<span class="sd">            is achieved. Once the function returns, the caller is responsible</span>
<span class="sd">            for monitoring the status of the deletion process via native SageMaker</span>
<span class="sd">            APIs or the AWS console. If `synchronous` is False, this parameter</span>
<span class="sd">            is ignored.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">boto3</span>

    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">archive</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">synchronous</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;Resources must be archived when `delete()` is executed in non-synchronous mode.&quot;</span>
                <span class="s2">&quot; Either set `synchronous=True` or `archive=True`.&quot;</span>
            <span class="p">),</span>
            <span class="n">error_code</span><span class="o">=</span><span class="n">INVALID_PARAMETER_VALUE</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">assume_role_credentials</span> <span class="o">=</span> <span class="n">_assume_role_and_get_credentials</span><span class="p">(</span><span class="n">assume_role_arn</span><span class="o">=</span><span class="n">assume_role_arn</span><span class="p">)</span>

    <span class="n">s3_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;s3&quot;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">region_name</span><span class="p">,</span> <span class="o">**</span><span class="n">assume_role_credentials</span><span class="p">)</span>
    <span class="n">sage_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;sagemaker&quot;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">region_name</span><span class="p">,</span> <span class="o">**</span><span class="n">assume_role_credentials</span><span class="p">)</span>

    <span class="n">endpoint_info</span> <span class="o">=</span> <span class="n">sage_client</span><span class="o">.</span><span class="n">describe_endpoint</span><span class="p">(</span><span class="n">EndpointName</span><span class="o">=</span><span class="n">app_name</span><span class="p">)</span>
    <span class="n">endpoint_arn</span> <span class="o">=</span> <span class="n">endpoint_info</span><span class="p">[</span><span class="s2">&quot;EndpointArn&quot;</span><span class="p">]</span>

    <span class="n">sage_client</span><span class="o">.</span><span class="n">delete_endpoint</span><span class="p">(</span><span class="n">EndpointName</span><span class="o">=</span><span class="n">app_name</span><span class="p">)</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deleted endpoint with arn: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">endpoint_arn</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">status_check_fn</span><span class="p">():</span>
        <span class="n">endpoint_info</span> <span class="o">=</span> <span class="n">_find_endpoint</span><span class="p">(</span><span class="n">endpoint_name</span><span class="o">=</span><span class="n">app_name</span><span class="p">,</span> <span class="n">sage_client</span><span class="o">=</span><span class="n">sage_client</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">endpoint_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_SageMakerOperationStatus</span><span class="o">.</span><span class="n">in_progress</span><span class="p">(</span>
                <span class="s2">&quot;Deletion is still in progress. Current endpoint status: </span><span class="si">{endpoint_status}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">endpoint_status</span><span class="o">=</span><span class="n">endpoint_info</span><span class="p">[</span><span class="s2">&quot;EndpointStatus&quot;</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_SageMakerOperationStatus</span><span class="o">.</span><span class="n">succeeded</span><span class="p">(</span>
                <span class="s2">&quot;The SageMaker endpoint was deleted successfully.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">cleanup_fn</span><span class="p">():</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cleaning up unused resources...&quot;</span><span class="p">)</span>
        <span class="n">config_name</span> <span class="o">=</span> <span class="n">endpoint_info</span><span class="p">[</span><span class="s2">&quot;EndpointConfigName&quot;</span><span class="p">]</span>
        <span class="n">config_info</span> <span class="o">=</span> <span class="n">sage_client</span><span class="o">.</span><span class="n">describe_endpoint_config</span><span class="p">(</span><span class="n">EndpointConfigName</span><span class="o">=</span><span class="n">config_name</span><span class="p">)</span>
        <span class="n">config_arn</span> <span class="o">=</span> <span class="n">config_info</span><span class="p">[</span><span class="s2">&quot;EndpointConfigArn&quot;</span><span class="p">]</span>
        <span class="n">sage_client</span><span class="o">.</span><span class="n">delete_endpoint_config</span><span class="p">(</span><span class="n">EndpointConfigName</span><span class="o">=</span><span class="n">config_name</span><span class="p">)</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deleted associated endpoint configuration with arn: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">config_arn</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span> <span class="n">config_info</span><span class="p">[</span><span class="s2">&quot;ProductionVariants&quot;</span><span class="p">]:</span>
            <span class="n">model_name</span> <span class="o">=</span> <span class="n">pv</span><span class="p">[</span><span class="s2">&quot;ModelName&quot;</span><span class="p">]</span>
            <span class="n">model_arn</span> <span class="o">=</span> <span class="n">_delete_sagemaker_model</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">sage_client</span><span class="p">,</span> <span class="n">s3_client</span><span class="p">)</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deleted associated model with arn: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">model_arn</span><span class="p">)</span>

    <span class="n">delete_operation</span> <span class="o">=</span> <span class="n">_SageMakerOperation</span><span class="p">(</span><span class="n">status_check_fn</span><span class="o">=</span><span class="n">status_check_fn</span><span class="p">,</span> <span class="n">cleanup_fn</span><span class="o">=</span><span class="n">cleanup_fn</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">synchronous</span><span class="p">:</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Waiting for the delete operation to complete...&quot;</span><span class="p">)</span>
        <span class="n">operation_status</span> <span class="o">=</span> <span class="n">delete_operation</span><span class="o">.</span><span class="n">await_completion</span><span class="p">(</span><span class="n">timeout_seconds</span><span class="o">=</span><span class="n">timeout_seconds</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">operation_status</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">_SageMakerOperationStatus</span><span class="o">.</span><span class="n">STATE_SUCCEEDED</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;The deletion operation completed successfully with message: &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="p">,</span>
                <span class="n">operation_status</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
                <span class="s2">&quot;The deletion operation failed with the following error message:&quot;</span>
                <span class="sa">f</span><span class="s1">&#39; &quot;</span><span class="si">{</span><span class="n">operation_status</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">archive</span><span class="p">:</span>
            <span class="n">delete_operation</span><span class="o">.</span><span class="n">clean_up</span><span class="p">()</span>


<div class="viewcode-block" id="deploy_transform_job"><a class="viewcode-back" href="../../python_api/mlflow.sagemaker.html#mlflow.sagemaker.deploy_transform_job">[docs]</a><span class="k">def</span> <span class="nf">deploy_transform_job</span><span class="p">(</span>
    <span class="n">job_name</span><span class="p">,</span>
    <span class="n">model_uri</span><span class="p">,</span>
    <span class="n">s3_input_data_type</span><span class="p">,</span>
    <span class="n">s3_input_uri</span><span class="p">,</span>
    <span class="n">content_type</span><span class="p">,</span>
    <span class="n">s3_output_path</span><span class="p">,</span>
    <span class="n">compression_type</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span>
    <span class="n">split_type</span><span class="o">=</span><span class="s2">&quot;Line&quot;</span><span class="p">,</span>
    <span class="n">accept</span><span class="o">=</span><span class="s2">&quot;text/csv&quot;</span><span class="p">,</span>
    <span class="n">assemble_with</span><span class="o">=</span><span class="s2">&quot;Line&quot;</span><span class="p">,</span>
    <span class="n">input_filter</span><span class="o">=</span><span class="s2">&quot;$&quot;</span><span class="p">,</span>
    <span class="n">output_filter</span><span class="o">=</span><span class="s2">&quot;$&quot;</span><span class="p">,</span>
    <span class="n">join_resource</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">,</span>
    <span class="n">execution_role_arn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">assume_role_arn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">bucket</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">image_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">region_name</span><span class="o">=</span><span class="s2">&quot;us-west-2&quot;</span><span class="p">,</span>
    <span class="n">instance_type</span><span class="o">=</span><span class="n">DEFAULT_SAGEMAKER_INSTANCE_TYPE</span><span class="p">,</span>
    <span class="n">instance_count</span><span class="o">=</span><span class="n">DEFAULT_SAGEMAKER_INSTANCE_COUNT</span><span class="p">,</span>
    <span class="n">vpc_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">flavor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">archive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">synchronous</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">1200</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deploy an MLflow model on AWS SageMaker and create the corresponding batch transform job.</span>
<span class="sd">    The currently active AWS account must have correct permissions set up.</span>

<span class="sd">    Args:</span>
<span class="sd">        job_name: Name of the deployed Sagemaker batch transform job.</span>
<span class="sd">        model_uri: The location, in URI format, of the MLflow model to deploy to SageMaker.</span>
<span class="sd">            For example:</span>

<span class="sd">            - ``/Users/me/path/to/local/model``</span>
<span class="sd">            - ``relative/path/to/local/model``</span>
<span class="sd">            - ``s3://my_bucket/path/to/model``</span>
<span class="sd">            - ``runs:/&lt;mlflow_run_id&gt;/run-relative/path/to/model``</span>
<span class="sd">            - ``models:/&lt;model_name&gt;/&lt;model_version&gt;``</span>
<span class="sd">            - ``models:/&lt;model_name&gt;/&lt;stage&gt;``</span>

<span class="sd">            For more information about supported URI schemes, see</span>
<span class="sd">            `Referencing Artifacts &lt;https://www.mlflow.org/docs/latest/concepts.html#</span>
<span class="sd">            artifact-locations&gt;`_.</span>

<span class="sd">        s3_input_data_type: Input data type for the transform job.</span>
<span class="sd">        s3_input_uri: S3 key name prefix or a manifest of the input data.</span>
<span class="sd">        content_type: The multipurpose internet mail extension (MIME) type of the data.</span>
<span class="sd">        s3_output_path: The S3 path to store the output results of the Sagemaker transform job.</span>
<span class="sd">        compression_type: The compression type of the transform data.</span>
<span class="sd">        split_type: The method to split the transform job&#39;s data files into smaller batches.</span>
<span class="sd">        accept: The multipurpose internet mail extension (MIME) type of the output data.</span>
<span class="sd">        assemble_with: The method to assemble the results of the transform job as</span>
<span class="sd">            a single S3 object.</span>
<span class="sd">        input_filter: A JSONPath expression used to select a portion of the input data for</span>
<span class="sd">            the transform job.</span>
<span class="sd">        output_filter: A JSONPath expression used to select a portion of the output data from</span>
<span class="sd">            the transform job.</span>
<span class="sd">        join_resource: The source of the data to join with the transformed data.</span>

<span class="sd">        execution_role_arn: The name of an IAM role granting the SageMaker service permissions to</span>
<span class="sd">            access the specified Docker image and S3 bucket containing MLflow</span>
<span class="sd">            model artifacts. If unspecified, the currently-assumed role will be</span>
<span class="sd">            used. This execution role is passed to the SageMaker service when</span>
<span class="sd">            creating a SageMaker model from the specified MLflow model. It is</span>
<span class="sd">            passed as the ``ExecutionRoleArn`` parameter of the `SageMaker</span>
<span class="sd">            CreateModel API call &lt;https://docs.aws.amazon.com/sagemaker/latest/</span>
<span class="sd">            dg/API_CreateModel.html&gt;`_. This role is *not* assumed for any other</span>
<span class="sd">            call. For more information about SageMaker execution roles for model</span>
<span class="sd">            creation, see</span>
<span class="sd">            https://docs.aws.amazon.com/sagemaker/latest/dg/sagemaker-roles.html.</span>
<span class="sd">        assume_role_arn: The name of an IAM cross-account role to be assumed to deploy SageMaker</span>
<span class="sd">            to another AWS account. If unspecified, SageMaker will be deployed to</span>
<span class="sd">            the the currently active AWS account.</span>
<span class="sd">        bucket: S3 bucket where model artifacts will be stored. Defaults to a</span>
<span class="sd">            SageMaker-compatible bucket name.</span>
<span class="sd">        image_url: URL of the ECR-hosted Docker image the model should be deployed into, produced</span>
<span class="sd">            by ``mlflow sagemaker build-and-push-container``. This parameter can also</span>
<span class="sd">            be specified by the environment variable ``MLFLOW_SAGEMAKER_DEPLOY_IMG_URL``.</span>
<span class="sd">        region_name: Name of the AWS region to which to deploy the application.</span>
<span class="sd">        instance_type: The type of SageMaker ML instance on which to deploy the model. For a list</span>
<span class="sd">            of supported instance types, see</span>
<span class="sd">            https://aws.amazon.com/sagemaker/pricing/instance-types/.</span>
<span class="sd">        instance_count: The number of SageMaker ML instances on which to deploy the model.</span>
<span class="sd">        vpc_config: A dictionary specifying the VPC configuration to use when creating the</span>
<span class="sd">            new SageMaker model associated with this batch transform job. The acceptable</span>
<span class="sd">            values for this parameter are identical to those of the ``VpcConfig``</span>
<span class="sd">            parameter in the `SageMaker boto3 client&#39;s create_model method</span>
<span class="sd">            &lt;https://boto3.readthedocs.io/en/latest/reference/services/sagemaker.html</span>
<span class="sd">            #SageMaker.Client.create_model&gt;`_. For more information, see</span>
<span class="sd">            https://docs.aws.amazon.com/sagemaker/latest/dg/API_VpcConfig.html.</span>

<span class="sd">            .. code-block:: python</span>
<span class="sd">                :caption: Example</span>

<span class="sd">                import mlflow.sagemaker as mfs</span>

<span class="sd">                vpc_config = {</span>
<span class="sd">                    &quot;SecurityGroupIds&quot;: [</span>
<span class="sd">                        &quot;sg-123456abc&quot;,</span>
<span class="sd">                    ],</span>
<span class="sd">                    &quot;Subnets&quot;: [</span>
<span class="sd">                        &quot;subnet-123456abc&quot;,</span>
<span class="sd">                    ],</span>
<span class="sd">                }</span>
<span class="sd">                mfs.deploy_transform_job(..., vpc_config=vpc_config)</span>

<span class="sd">        flavor: The name of the flavor of the model to use for deployment. Must be either</span>
<span class="sd">            ``None`` or one of mlflow.sagemaker.SUPPORTED_DEPLOYMENT_FLAVORS. If ``None``,</span>
<span class="sd">            a flavor is automatically selected from the model&#39;s available flavors. If the</span>
<span class="sd">            specified flavor is not present or not supported for deployment, an exception</span>
<span class="sd">            will be thrown.</span>
<span class="sd">        archive: If ``True``, resources like Sagemaker models and model artifacts in S3 are</span>
<span class="sd">            preserved after the finished batch transform job. If ``False``, these resources</span>
<span class="sd">            are deleted. In order to use ``archive=False``, ``deploy_transform_job()`` must</span>
<span class="sd">            be executed synchronously with ``synchronous=True``.</span>
<span class="sd">        synchronous: If ``True``, this function will block until the deployment process succeeds</span>
<span class="sd">            or encounters an irrecoverable failure. If ``False``, this function will</span>
<span class="sd">            return immediately after starting the deployment process. It will not wait</span>
<span class="sd">            for the deployment process to complete; in this case, the caller is</span>
<span class="sd">            responsible for monitoring the health and status of the pending deployment</span>
<span class="sd">            via native SageMaker APIs or the AWS console.</span>
<span class="sd">        timeout_seconds: If ``synchronous`` is ``True``, the deployment process will return after</span>
<span class="sd">            the specified number of seconds if no definitive result (success or</span>
<span class="sd">            failure) is achieved. Once the function returns, the caller is</span>
<span class="sd">            responsible for monitoring the health and status of the pending</span>
<span class="sd">            deployment using native SageMaker APIs or the AWS console. If</span>
<span class="sd">            ``synchronous`` is ``False``, this parameter is ignored.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">boto3</span>

    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">archive</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">synchronous</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;Resources must be archived when `deploy_transform_job()`&quot;</span>
                <span class="s2">&quot; is executed in non-synchronous mode.&quot;</span>
                <span class="s2">&quot; Either set `synchronous=True` or `archive=True`.&quot;</span>
            <span class="p">),</span>
            <span class="n">error_code</span><span class="o">=</span><span class="n">INVALID_PARAMETER_VALUE</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">model_path</span> <span class="o">=</span> <span class="n">_download_artifact_from_uri</span><span class="p">(</span><span class="n">model_uri</span><span class="p">)</span>
    <span class="n">model_config_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">MLMODEL_FILE_NAME</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">model_config_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to find </span><span class="si">{</span><span class="n">MLMODEL_FILE_NAME</span><span class="si">}</span><span class="s2"> configuration within the specified model&#39;s&quot;</span>
                <span class="s2">&quot; root directory.&quot;</span>
            <span class="p">),</span>
            <span class="n">error_code</span><span class="o">=</span><span class="n">INVALID_PARAMETER_VALUE</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">model_config</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model_config_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">flavor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">flavor</span> <span class="o">=</span> <span class="n">_get_preferred_deployment_flavor</span><span class="p">(</span><span class="n">model_config</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_validate_deployment_flavor</span><span class="p">(</span><span class="n">model_config</span><span class="p">,</span> <span class="n">flavor</span><span class="p">)</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using the </span><span class="si">%s</span><span class="s2"> flavor for deployment!&quot;</span><span class="p">,</span> <span class="n">flavor</span><span class="p">)</span>

    <span class="n">assume_role_credentials</span> <span class="o">=</span> <span class="n">_assume_role_and_get_credentials</span><span class="p">(</span><span class="n">assume_role_arn</span><span class="o">=</span><span class="n">assume_role_arn</span><span class="p">)</span>

    <span class="n">s3_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;s3&quot;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">region_name</span><span class="p">,</span> <span class="o">**</span><span class="n">assume_role_credentials</span><span class="p">)</span>
    <span class="n">sage_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;sagemaker&quot;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">region_name</span><span class="p">,</span> <span class="o">**</span><span class="n">assume_role_credentials</span><span class="p">)</span>

    <span class="n">transform_job_exists</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">_find_transform_job</span><span class="p">(</span><span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">,</span> <span class="n">sage_client</span><span class="o">=</span><span class="n">sage_client</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">transform_job_exists</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;You are attempting to deploy a batch transform job with name: </span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="s2">&quot;However, a batch transform job with the same name already exists.&quot;</span>
            <span class="p">),</span>
            <span class="n">error_code</span><span class="o">=</span><span class="n">INVALID_PARAMETER_VALUE</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">model_name</span> <span class="o">=</span> <span class="n">_get_sagemaker_transform_model_name</span><span class="p">(</span><span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">image_url</span><span class="p">:</span>
        <span class="n">image_url</span> <span class="o">=</span> <span class="n">_get_default_image_url</span><span class="p">(</span><span class="n">region_name</span><span class="o">=</span><span class="n">region_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">execution_role_arn</span><span class="p">:</span>
        <span class="n">execution_role_arn</span> <span class="o">=</span> <span class="n">_get_assumed_role_arn</span><span class="p">(</span><span class="o">**</span><span class="n">assume_role_credentials</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bucket</span><span class="p">:</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No model data bucket specified, using the default bucket&quot;</span><span class="p">)</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="n">_get_default_s3_bucket</span><span class="p">(</span><span class="n">region_name</span><span class="p">,</span> <span class="o">**</span><span class="n">assume_role_credentials</span><span class="p">)</span>

    <span class="n">model_s3_path</span> <span class="o">=</span> <span class="n">_upload_s3</span><span class="p">(</span>
        <span class="n">local_model_path</span><span class="o">=</span><span class="n">model_path</span><span class="p">,</span>
        <span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span>
        <span class="n">prefix</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
        <span class="n">region_name</span><span class="o">=</span><span class="n">region_name</span><span class="p">,</span>
        <span class="n">s3_client</span><span class="o">=</span><span class="n">s3_client</span><span class="p">,</span>
        <span class="o">**</span><span class="n">assume_role_credentials</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">deployment_operation</span> <span class="o">=</span> <span class="n">_create_sagemaker_transform_job</span><span class="p">(</span>
        <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">,</span>
        <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
        <span class="n">model_s3_path</span><span class="o">=</span><span class="n">model_s3_path</span><span class="p">,</span>
        <span class="n">model_uri</span><span class="o">=</span><span class="n">model_uri</span><span class="p">,</span>
        <span class="n">image_url</span><span class="o">=</span><span class="n">image_url</span><span class="p">,</span>
        <span class="n">flavor</span><span class="o">=</span><span class="n">flavor</span><span class="p">,</span>
        <span class="n">vpc_config</span><span class="o">=</span><span class="n">vpc_config</span><span class="p">,</span>
        <span class="n">role</span><span class="o">=</span><span class="n">execution_role_arn</span><span class="p">,</span>
        <span class="n">sage_client</span><span class="o">=</span><span class="n">sage_client</span><span class="p">,</span>
        <span class="n">s3_client</span><span class="o">=</span><span class="n">s3_client</span><span class="p">,</span>
        <span class="n">instance_type</span><span class="o">=</span><span class="n">instance_type</span><span class="p">,</span>
        <span class="n">instance_count</span><span class="o">=</span><span class="n">instance_count</span><span class="p">,</span>
        <span class="n">s3_input_data_type</span><span class="o">=</span><span class="n">s3_input_data_type</span><span class="p">,</span>
        <span class="n">s3_input_uri</span><span class="o">=</span><span class="n">s3_input_uri</span><span class="p">,</span>
        <span class="n">content_type</span><span class="o">=</span><span class="n">content_type</span><span class="p">,</span>
        <span class="n">compression_type</span><span class="o">=</span><span class="n">compression_type</span><span class="p">,</span>
        <span class="n">split_type</span><span class="o">=</span><span class="n">split_type</span><span class="p">,</span>
        <span class="n">s3_output_path</span><span class="o">=</span><span class="n">s3_output_path</span><span class="p">,</span>
        <span class="n">accept</span><span class="o">=</span><span class="n">accept</span><span class="p">,</span>
        <span class="n">assemble_with</span><span class="o">=</span><span class="n">assemble_with</span><span class="p">,</span>
        <span class="n">input_filter</span><span class="o">=</span><span class="n">input_filter</span><span class="p">,</span>
        <span class="n">output_filter</span><span class="o">=</span><span class="n">output_filter</span><span class="p">,</span>
        <span class="n">join_resource</span><span class="o">=</span><span class="n">join_resource</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">synchronous</span><span class="p">:</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Waiting for the batch transform job to complete...&quot;</span><span class="p">)</span>
        <span class="n">operation_status</span> <span class="o">=</span> <span class="n">deployment_operation</span><span class="o">.</span><span class="n">await_completion</span><span class="p">(</span><span class="n">timeout_seconds</span><span class="o">=</span><span class="n">timeout_seconds</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">operation_status</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">_SageMakerOperationStatus</span><span class="o">.</span><span class="n">STATE_SUCCEEDED</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;The batch transform job completed successfully with message: &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="p">,</span>
                <span class="n">operation_status</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
                <span class="s2">&quot;The batch transform job failed with the following error message:&quot;</span>
                <span class="sa">f</span><span class="s1">&#39; &quot;</span><span class="si">{</span><span class="n">operation_status</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">archive</span><span class="p">:</span>
            <span class="n">deployment_operation</span><span class="o">.</span><span class="n">clean_up</span><span class="p">()</span></div>


<div class="viewcode-block" id="terminate_transform_job"><a class="viewcode-back" href="../../python_api/mlflow.sagemaker.html#mlflow.sagemaker.terminate_transform_job">[docs]</a><span class="k">def</span> <span class="nf">terminate_transform_job</span><span class="p">(</span>
    <span class="n">job_name</span><span class="p">,</span>
    <span class="n">region_name</span><span class="o">=</span><span class="s2">&quot;us-west-2&quot;</span><span class="p">,</span>
    <span class="n">assume_role_arn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">archive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">synchronous</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">timeout_seconds</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Terminate a SageMaker batch transform job.</span>

<span class="sd">    Args:</span>
<span class="sd">        job_name: Name of the deployed Sagemaker batch transform job.</span>
<span class="sd">        region_name: Name of the AWS region in which the batch transform job is deployed.</span>
<span class="sd">        assume_role_arn: The name of an IAM cross-account role to be assumed to deploy SageMaker</span>
<span class="sd">            to another AWS account. If unspecified, SageMaker will be deployed to</span>
<span class="sd">            the the currently active AWS account.</span>
<span class="sd">        archive: If ``True``, resources associated with the specified batch transform job,</span>
<span class="sd">            such as its associated models and model artifacts, are preserved.</span>
<span class="sd">            If ``False``, these resources are deleted. In order to use ``archive=False``,</span>
<span class="sd">            ``terminate_transform_job()`` must be executed synchronously</span>
<span class="sd">            with ``synchronous=True``.</span>
<span class="sd">        synchronous: If `True`, this function blocks until the termination process succeeds</span>
<span class="sd">            or encounters an irrecoverable failure. If `False`, this function</span>
<span class="sd">            returns immediately after starting the termination process. It will not</span>
<span class="sd">            wait for the termination process to complete; in this case, the caller is</span>
<span class="sd">            responsible for monitoring the status of the termination process via native</span>
<span class="sd">            SageMaker APIs or the AWS console.</span>
<span class="sd">        timeout_seconds: If `synchronous` is `True`, the termination process returns after the</span>
<span class="sd">            specified number of seconds if no definitive result (success or failure)</span>
<span class="sd">            is achieved. Once the function returns, the caller is responsible</span>
<span class="sd">            for monitoring the status of the termination process via native</span>
<span class="sd">            SageMaker APIs or the AWS console. If `synchronous` is False, this</span>
<span class="sd">            parameter is ignored.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">boto3</span>

    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">archive</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">synchronous</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;Resources must be archived when `terminate_transform_job()`&quot;</span>
                <span class="s2">&quot; is executed in non-synchronous mode.&quot;</span>
                <span class="s2">&quot; Either set `synchronous=True` or `archive=True`.&quot;</span>
            <span class="p">),</span>
            <span class="n">error_code</span><span class="o">=</span><span class="n">INVALID_PARAMETER_VALUE</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">assume_role_credentials</span> <span class="o">=</span> <span class="n">_assume_role_and_get_credentials</span><span class="p">(</span><span class="n">assume_role_arn</span><span class="o">=</span><span class="n">assume_role_arn</span><span class="p">)</span>

    <span class="n">s3_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;s3&quot;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">region_name</span><span class="p">,</span> <span class="o">**</span><span class="n">assume_role_credentials</span><span class="p">)</span>
    <span class="n">sage_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;sagemaker&quot;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">region_name</span><span class="p">,</span> <span class="o">**</span><span class="n">assume_role_credentials</span><span class="p">)</span>

    <span class="n">transform_job_info</span> <span class="o">=</span> <span class="n">sage_client</span><span class="o">.</span><span class="n">describe_transform_job</span><span class="p">(</span><span class="n">TransformJobName</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
    <span class="n">transform_job_arn</span> <span class="o">=</span> <span class="n">transform_job_info</span><span class="p">[</span><span class="s2">&quot;TransformJobArn&quot;</span><span class="p">]</span>

    <span class="n">sage_client</span><span class="o">.</span><span class="n">stop_transform_job</span><span class="p">(</span><span class="n">TransformJobName</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Terminated batch transform job with arn: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">transform_job_arn</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">status_check_fn</span><span class="p">():</span>
        <span class="n">transform_job_info</span> <span class="o">=</span> <span class="n">_find_transform_job</span><span class="p">(</span><span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">,</span> <span class="n">sage_client</span><span class="o">=</span><span class="n">sage_client</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">transform_job_info</span><span class="p">[</span><span class="s2">&quot;TransformJobStatus&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Stopping&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_SageMakerOperationStatus</span><span class="o">.</span><span class="n">in_progress</span><span class="p">(</span>
                <span class="s2">&quot;Termination is still in progress. Current batch transform job status: &quot;</span>
                <span class="s2">&quot;</span><span class="si">{transform_job_status}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">transform_job_status</span><span class="o">=</span><span class="n">transform_job_info</span><span class="p">[</span><span class="s2">&quot;TransformJobStatus&quot;</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">transform_job_info</span><span class="p">[</span><span class="s2">&quot;TransformJobStatus&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Stopped&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_SageMakerOperationStatus</span><span class="o">.</span><span class="n">succeeded</span><span class="p">(</span>
                <span class="s2">&quot;The SageMaker batch transform job was terminated successfully.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">cleanup_fn</span><span class="p">():</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cleaning up unused resources...&quot;</span><span class="p">)</span>
        <span class="n">model_name</span> <span class="o">=</span> <span class="n">transform_job_info</span><span class="p">[</span><span class="s2">&quot;ModelName&quot;</span><span class="p">]</span>
        <span class="n">model_arn</span> <span class="o">=</span> <span class="n">_delete_sagemaker_model</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">sage_client</span><span class="p">,</span> <span class="n">s3_client</span><span class="p">)</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deleted associated model with arn: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">model_arn</span><span class="p">)</span>

    <span class="n">stop_operation</span> <span class="o">=</span> <span class="n">_SageMakerOperation</span><span class="p">(</span><span class="n">status_check_fn</span><span class="o">=</span><span class="n">status_check_fn</span><span class="p">,</span> <span class="n">cleanup_fn</span><span class="o">=</span><span class="n">cleanup_fn</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">synchronous</span><span class="p">:</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Waiting for the termination operation to complete...&quot;</span><span class="p">)</span>
        <span class="n">operation_status</span> <span class="o">=</span> <span class="n">stop_operation</span><span class="o">.</span><span class="n">await_completion</span><span class="p">(</span><span class="n">timeout_seconds</span><span class="o">=</span><span class="n">timeout_seconds</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">operation_status</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">_SageMakerOperationStatus</span><span class="o">.</span><span class="n">STATE_SUCCEEDED</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;The termination operation completed successfully with message: &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="p">,</span>
                <span class="n">operation_status</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
                <span class="s2">&quot;The termination operation failed with the following error message:&quot;</span>
                <span class="sa">f</span><span class="s1">&#39; &quot;</span><span class="si">{</span><span class="n">operation_status</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">archive</span><span class="p">:</span>
            <span class="n">stop_operation</span><span class="o">.</span><span class="n">clean_up</span><span class="p">()</span></div>


<div class="viewcode-block" id="push_model_to_sagemaker"><a class="viewcode-back" href="../../python_api/mlflow.sagemaker.html#mlflow.sagemaker.push_model_to_sagemaker">[docs]</a><span class="k">def</span> <span class="nf">push_model_to_sagemaker</span><span class="p">(</span>
    <span class="n">model_name</span><span class="p">,</span>
    <span class="n">model_uri</span><span class="p">,</span>
    <span class="n">execution_role_arn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">assume_role_arn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">bucket</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">image_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">region_name</span><span class="o">=</span><span class="s2">&quot;us-west-2&quot;</span><span class="p">,</span>
    <span class="n">vpc_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">flavor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a SageMaker Model from an MLflow model artifact.</span>
<span class="sd">    The currently active AWS account must have correct permissions set up.</span>

<span class="sd">    Args:</span>
<span class="sd">        model_name: Name of the Sagemaker model.</span>
<span class="sd">        model_uri: The location, in URI format, of the MLflow model to deploy to SageMaker.</span>
<span class="sd">            For example:</span>

<span class="sd">            - ``/Users/me/path/to/local/model``</span>
<span class="sd">            - ``relative/path/to/local/model``</span>
<span class="sd">            - ``s3://my_bucket/path/to/model``</span>
<span class="sd">            - ``runs:/&lt;mlflow_run_id&gt;/run-relative/path/to/model``</span>
<span class="sd">            - ``models:/&lt;model_name&gt;/&lt;model_version&gt;``</span>
<span class="sd">            - ``models:/&lt;model_name&gt;/&lt;stage&gt;``</span>

<span class="sd">            For more information about supported URI schemes, see</span>
<span class="sd">            `Referencing Artifacts &lt;https://www.mlflow.org/docs/latest/concepts.html#</span>
<span class="sd">            artifact-locations&gt;`_.</span>

<span class="sd">        execution_role_arn: The name of an IAM role granting the SageMaker service permissions to</span>
<span class="sd">            access the specified Docker image and S3 bucket containing MLflow</span>
<span class="sd">            model artifacts. If unspecified, the currently-assumed role will be</span>
<span class="sd">            used. This execution role is passed to the SageMaker service when</span>
<span class="sd">            creating a SageMaker model from the specified MLflow model. It is</span>
<span class="sd">            passed as the ``ExecutionRoleArn`` parameter of the `SageMaker</span>
<span class="sd">            CreateModel API call &lt;https://docs.aws.amazon.com/sagemaker/latest/</span>
<span class="sd">            dg/API_CreateModel.html&gt;`_. This role is *not* assumed for any other</span>
<span class="sd">            call. For more information about SageMaker execution roles for model</span>
<span class="sd">            creation, see</span>
<span class="sd">            https://docs.aws.amazon.com/sagemaker/latest/dg/sagemaker-roles.html.</span>
<span class="sd">        assume_role_arn: The name of an IAM cross-account role to be assumed to deploy SageMaker</span>
<span class="sd">            to another AWS account. If unspecified, SageMaker will be deployed to</span>
<span class="sd">            the the currently active AWS account.</span>
<span class="sd">        bucket: S3 bucket where model artifacts will be stored. Defaults to a</span>
<span class="sd">            SageMaker-compatible bucket name.</span>
<span class="sd">        image_url: URL of the ECR-hosted Docker image the model should be deployed into, produced</span>
<span class="sd">            by ``mlflow sagemaker build-and-push-container``. This parameter can also</span>
<span class="sd">            be specified by the environment variable ``MLFLOW_SAGEMAKER_DEPLOY_IMG_URL``.</span>
<span class="sd">        region_name: Name of the AWS region to which to deploy the application.</span>
<span class="sd">        vpc_config: A dictionary specifying the VPC configuration to use when creating the</span>
<span class="sd">            new SageMaker model. The acceptable values for this parameter are identical</span>
<span class="sd">            to those of the ``VpcConfig`` parameter in the `SageMaker boto3 client&#39;s</span>
<span class="sd">            create_model method</span>
<span class="sd">            &lt;https://boto3.readthedocs.io/en/latest/reference/services/sagemaker.html</span>
<span class="sd">            #SageMaker.Client.create_model&gt;`_. For more information, see</span>
<span class="sd">            https://docs.aws.amazon.com/sagemaker/latest/dg/API_VpcConfig.html.</span>

<span class="sd">            .. code-block:: python</span>
<span class="sd">                :caption: Example</span>

<span class="sd">                import mlflow.sagemaker as mfs</span>

<span class="sd">                vpc_config = {</span>
<span class="sd">                    &quot;SecurityGroupIds&quot;: [</span>
<span class="sd">                        &quot;sg-123456abc&quot;,</span>
<span class="sd">                    ],</span>
<span class="sd">                    &quot;Subnets&quot;: [</span>
<span class="sd">                        &quot;subnet-123456abc&quot;,</span>
<span class="sd">                    ],</span>
<span class="sd">                }</span>
<span class="sd">                mfs.push_model_to_sagemaker(..., vpc_config=vpc_config)</span>

<span class="sd">        flavor: The name of the flavor of the model to use for deployment. Must be either</span>
<span class="sd">            ``None`` or one of mlflow.sagemaker.SUPPORTED_DEPLOYMENT_FLAVORS. If ``None``,</span>
<span class="sd">            a flavor is automatically selected from the model&#39;s available flavors. If the</span>
<span class="sd">            specified flavor is not present or not supported for deployment, an exception</span>
<span class="sd">            will be thrown.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">boto3</span>

    <span class="n">model_path</span> <span class="o">=</span> <span class="n">_download_artifact_from_uri</span><span class="p">(</span><span class="n">model_uri</span><span class="p">)</span>
    <span class="n">model_config_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">MLMODEL_FILE_NAME</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">model_config_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to find </span><span class="si">{</span><span class="n">MLMODEL_FILE_NAME</span><span class="si">}</span><span class="s2"> configuration within the specified model&#39;s&quot;</span>
                <span class="s2">&quot; root directory.&quot;</span>
            <span class="p">),</span>
            <span class="n">error_code</span><span class="o">=</span><span class="n">INVALID_PARAMETER_VALUE</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">model_config</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model_config_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">flavor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">flavor</span> <span class="o">=</span> <span class="n">_get_preferred_deployment_flavor</span><span class="p">(</span><span class="n">model_config</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_validate_deployment_flavor</span><span class="p">(</span><span class="n">model_config</span><span class="p">,</span> <span class="n">flavor</span><span class="p">)</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using the </span><span class="si">%s</span><span class="s2"> flavor for deployment!&quot;</span><span class="p">,</span> <span class="n">flavor</span><span class="p">)</span>

    <span class="n">assume_role_credentials</span> <span class="o">=</span> <span class="n">_assume_role_and_get_credentials</span><span class="p">(</span><span class="n">assume_role_arn</span><span class="o">=</span><span class="n">assume_role_arn</span><span class="p">)</span>

    <span class="n">s3_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;s3&quot;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">region_name</span><span class="p">,</span> <span class="o">**</span><span class="n">assume_role_credentials</span><span class="p">)</span>
    <span class="n">sage_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;sagemaker&quot;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">region_name</span><span class="p">,</span> <span class="o">**</span><span class="n">assume_role_credentials</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">_does_model_exist</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span> <span class="n">sage_client</span><span class="o">=</span><span class="n">sage_client</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;You are attempting to create a Sagemaker model with name: </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="s2">&quot;However, a model with the same name already exists.&quot;</span>
            <span class="p">),</span>
            <span class="n">error_code</span><span class="o">=</span><span class="n">INVALID_PARAMETER_VALUE</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">image_url</span><span class="p">:</span>
        <span class="n">image_url</span> <span class="o">=</span> <span class="n">_get_default_image_url</span><span class="p">(</span><span class="n">region_name</span><span class="o">=</span><span class="n">region_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">execution_role_arn</span><span class="p">:</span>
        <span class="n">execution_role_arn</span> <span class="o">=</span> <span class="n">_get_assumed_role_arn</span><span class="p">(</span><span class="o">**</span><span class="n">assume_role_credentials</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bucket</span><span class="p">:</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No model data bucket specified, using the default bucket&quot;</span><span class="p">)</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="n">_get_default_s3_bucket</span><span class="p">(</span><span class="n">region_name</span><span class="p">,</span> <span class="o">**</span><span class="n">assume_role_credentials</span><span class="p">)</span>

    <span class="n">model_s3_path</span> <span class="o">=</span> <span class="n">_upload_s3</span><span class="p">(</span>
        <span class="n">local_model_path</span><span class="o">=</span><span class="n">model_path</span><span class="p">,</span>
        <span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span>
        <span class="n">prefix</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
        <span class="n">region_name</span><span class="o">=</span><span class="n">region_name</span><span class="p">,</span>
        <span class="n">s3_client</span><span class="o">=</span><span class="n">s3_client</span><span class="p">,</span>
        <span class="o">**</span><span class="n">assume_role_credentials</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">model_response</span> <span class="o">=</span> <span class="n">_create_sagemaker_model</span><span class="p">(</span>
        <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
        <span class="n">model_s3_path</span><span class="o">=</span><span class="n">model_s3_path</span><span class="p">,</span>
        <span class="n">model_uri</span><span class="o">=</span><span class="n">model_uri</span><span class="p">,</span>
        <span class="n">flavor</span><span class="o">=</span><span class="n">flavor</span><span class="p">,</span>
        <span class="n">vpc_config</span><span class="o">=</span><span class="n">vpc_config</span><span class="p">,</span>
        <span class="n">image_url</span><span class="o">=</span><span class="n">image_url</span><span class="p">,</span>
        <span class="n">execution_role</span><span class="o">=</span><span class="n">execution_role_arn</span><span class="p">,</span>
        <span class="n">sage_client</span><span class="o">=</span><span class="n">sage_client</span><span class="p">,</span>
        <span class="n">env</span><span class="o">=</span><span class="p">{},</span>
        <span class="n">tags</span><span class="o">=</span><span class="p">{},</span>
    <span class="p">)</span>

    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created Sagemaker model with arn: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">model_response</span><span class="p">[</span><span class="s2">&quot;ModelArn&quot;</span><span class="p">])</span></div>


<div class="viewcode-block" id="run_local"><a class="viewcode-back" href="../../python_api/mlflow.sagemaker.html#mlflow.sagemaker.run_local">[docs]</a><span class="k">def</span> <span class="nf">run_local</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">model_uri</span><span class="p">,</span> <span class="n">flavor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Serve the model locally in a SageMaker compatible Docker container.</span>

<span class="sd">    Note that models deployed locally cannot be managed by other deployment APIs</span>
<span class="sd">    (e.g. ``update_deployment``, ``delete_deployment``, etc).</span>

<span class="sd">    Args:</span>
<span class="sd">        name: Name of the local serving application.</span>
<span class="sd">        model_uri: The location, in URI format, of the MLflow model to deploy locally.</span>
<span class="sd">                        For example:</span>

<span class="sd">                        - ``/Users/me/path/to/local/model``</span>
<span class="sd">                        - ``relative/path/to/local/model``</span>
<span class="sd">                        - ``s3://my_bucket/path/to/model``</span>
<span class="sd">                        - ``runs:/&lt;mlflow_run_id&gt;/run-relative/path/to/model``</span>
<span class="sd">                        - ``models:/&lt;model_name&gt;/&lt;model_version&gt;``</span>
<span class="sd">                        - ``models:/&lt;model_name&gt;/&lt;stage&gt;``</span>

<span class="sd">                        For more information about supported URI schemes, see</span>
<span class="sd">                        `Referencing Artifacts &lt;https://www.mlflow.org/docs/latest/concepts.html#</span>
<span class="sd">                        artifact-locations&gt;`_.</span>
<span class="sd">        flavor: The name of the flavor of the model to use for deployment. Must be either</span>
<span class="sd">                    ``None`` or one of mlflow.sagemaker.SUPPORTED_DEPLOYMENT_FLAVORS.</span>
<span class="sd">                    If ``None``, a flavor is automatically selected from the model&#39;s available</span>
<span class="sd">                    flavors. If the specified flavor is not present or not supported for</span>
<span class="sd">                    deployment, an exception will be thrown.</span>
<span class="sd">        config: Configuration parameters. The supported parameters are:</span>

<span class="sd">                    - ``image``: The name of the Docker image to use for model serving. Defaults</span>
<span class="sd">                                    to ``&quot;mlflow-pyfunc&quot;``.</span>
<span class="sd">                    - ``port``: The port at which to expose the model server on the local host.</span>
<span class="sd">                                Defaults to ``5000``.</span>

<span class="sd">    .. code-block:: python</span>
<span class="sd">        :caption: Python example</span>

<span class="sd">        from mlflow.models import build_docker</span>
<span class="sd">        from mlflow.deployments import get_deploy_client</span>

<span class="sd">        build_docker(name=&quot;mlflow-pyfunc&quot;)</span>

<span class="sd">        client = get_deploy_client(&quot;sagemaker&quot;)</span>
<span class="sd">        client.run_local(</span>
<span class="sd">            name=&quot;my-local-deployment&quot;,</span>
<span class="sd">            model_uri=&quot;/mlruns/0/abc/model&quot;,</span>
<span class="sd">            flavor=&quot;python_function&quot;,</span>
<span class="sd">            config={</span>
<span class="sd">                &quot;port&quot;: 5000,</span>
<span class="sd">                &quot;image&quot;: &quot;mlflow-pyfunc&quot;,</span>
<span class="sd">            },</span>
<span class="sd">        )</span>

<span class="sd">    .. code-block:: bash</span>
<span class="sd">        :caption:  Command-line example</span>

<span class="sd">        mlflow models build-docker --name &quot;mlflow-pyfunc&quot;</span>
<span class="sd">        mlflow deployments run-local --target sagemaker \\</span>
<span class="sd">                --name my-local-deployment \\</span>
<span class="sd">                --model-uri &quot;/mlruns/0/abc/model&quot; \\</span>
<span class="sd">                --flavor python_function \\</span>
<span class="sd">                -C port=5000 \\</span>
<span class="sd">                -C image=&quot;mlflow-pyfunc&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model_path</span> <span class="o">=</span> <span class="n">_download_artifact_from_uri</span><span class="p">(</span><span class="n">model_uri</span><span class="p">)</span>
    <span class="n">model_config_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">MLMODEL_FILE_NAME</span><span class="p">)</span>
    <span class="n">model_config</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model_config_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">flavor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">flavor</span> <span class="o">=</span> <span class="n">_get_preferred_deployment_flavor</span><span class="p">(</span><span class="n">model_config</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_validate_deployment_flavor</span><span class="p">(</span><span class="n">model_config</span><span class="p">,</span> <span class="n">flavor</span><span class="p">)</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using the </span><span class="si">%s</span><span class="s2"> flavor for local serving!&quot;</span><span class="p">,</span> <span class="n">flavor</span><span class="p">)</span>

    <span class="n">image</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="n">DEFAULT_IMAGE_NAME</span><span class="p">)</span>
    <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;port&quot;</span><span class="p">,</span> <span class="mi">5000</span><span class="p">))</span>

    <span class="n">deployment_config</span> <span class="o">=</span> <span class="n">_get_deployment_config</span><span class="p">(</span><span class="n">flavor_name</span><span class="o">=</span><span class="n">flavor</span><span class="p">)</span>

    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;launching docker image with path </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">model_path</span><span class="p">)</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;docker&quot;</span><span class="p">,</span> <span class="s2">&quot;run&quot;</span><span class="p">,</span> <span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_path</span><span class="si">}</span><span class="s2">:/opt/ml/model/&quot;</span><span class="p">,</span> <span class="s2">&quot;-p&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">:8080&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">deployment_config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-e&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
    <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--rm&quot;</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="s2">&quot;serve&quot;</span><span class="p">]</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;executing: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_sigterm_handler</span><span class="p">(</span><span class="o">*</span><span class="n">_</span><span class="p">):</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;received termination signal =&gt; killing docker process&quot;</span><span class="p">)</span>
        <span class="n">proc</span><span class="o">.</span><span class="n">send_signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">)</span>

    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">_sigterm_handler</span><span class="p">)</span>
    <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span></div>


<div class="viewcode-block" id="target_help"><a class="viewcode-back" href="../../python_api/mlflow.sagemaker.html#mlflow.sagemaker.target_help">[docs]</a><span class="k">def</span> <span class="nf">target_help</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Provide help information for the SageMaker deployment client.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">    For detailed documentation on the SageMaker deployment client, please visit</span>
<span class="s2">    https://mlflow.org/docs/latest/python_api/mlflow.sagemaker.html#mlflow.sagemaker.SageMakerDeploymentClient</span>

<span class="s2">    The target URI must follow the following formats:</span>
<span class="s2">    - sagemaker</span>
<span class="s2">    - sagemaker:/region_name</span>
<span class="s2">    - sagemaker:/region_name/assume_role_arn</span>

<span class="s2">    When the region_name or assume_role_arn are provided, they will be used as the default region</span>
<span class="s2">    and assumed role ARN when executing the commands.</span>

<span class="s2">    The `create` and `update` commands require a deployment name and a model_uri. The model flavor</span>
<span class="s2">    and deployment configuration can be optionally provided. These commands can also be executed</span>
<span class="s2">    in synchronous or asynchronous mode.</span>

<span class="s2">    The `delete` command accepts configurations to archive a model instead of deleting, execute</span>
<span class="s2">    in asynchronous mode and timeout period.</span>
<span class="s2">    &quot;&quot;&quot;</span></div>


<span class="k">def</span> <span class="nf">_get_default_image_url</span><span class="p">(</span><span class="n">region_name</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">boto3</span>

    <span class="k">if</span> <span class="n">env_img</span> <span class="o">:=</span> <span class="n">MLFLOW_SAGEMAKER_DEPLOY_IMG_URL</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">env_img</span>

    <span class="n">ecr_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;ecr&quot;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="n">region_name</span><span class="p">)</span>
    <span class="n">repository_conf</span> <span class="o">=</span> <span class="n">ecr_client</span><span class="o">.</span><span class="n">describe_repositories</span><span class="p">(</span><span class="n">repositoryNames</span><span class="o">=</span><span class="p">[</span><span class="n">DEFAULT_IMAGE_NAME</span><span class="p">])[</span>
        <span class="s2">&quot;repositories&quot;</span>
    <span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">repository_conf</span><span class="p">[</span><span class="s2">&quot;repositoryUri&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;:</span><span class="si">{version}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">mlflow</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">VERSION</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_account_id</span><span class="p">(</span><span class="o">**</span><span class="n">assume_role_credentials</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">boto3</span>

    <span class="n">sess</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
    <span class="n">sts_client</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;sts&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">assume_role_credentials</span><span class="p">)</span>
    <span class="n">identity_info</span> <span class="o">=</span> <span class="n">sts_client</span><span class="o">.</span><span class="n">get_caller_identity</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">identity_info</span><span class="p">[</span><span class="s2">&quot;Account&quot;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_get_assumed_role_arn</span><span class="p">(</span><span class="o">**</span><span class="n">assume_role_credentials</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns:</span>
<span class="sd">        ARN of the user&#39;s current IAM role.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">boto3</span>

    <span class="n">sess</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
    <span class="n">sts_client</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;sts&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">assume_role_credentials</span><span class="p">)</span>
    <span class="n">identity_info</span> <span class="o">=</span> <span class="n">sts_client</span><span class="o">.</span><span class="n">get_caller_identity</span><span class="p">()</span>
    <span class="n">sts_arn</span> <span class="o">=</span> <span class="n">identity_info</span><span class="p">[</span><span class="s2">&quot;Arn&quot;</span><span class="p">]</span>
    <span class="n">role_name</span> <span class="o">=</span> <span class="n">sts_arn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">iam_client</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;iam&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">assume_role_credentials</span><span class="p">)</span>
    <span class="n">role_response</span> <span class="o">=</span> <span class="n">iam_client</span><span class="o">.</span><span class="n">get_role</span><span class="p">(</span><span class="n">RoleName</span><span class="o">=</span><span class="n">role_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">role_response</span><span class="p">[</span><span class="s2">&quot;Role&quot;</span><span class="p">][</span><span class="s2">&quot;Arn&quot;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_assume_role_and_get_credentials</span><span class="p">(</span><span class="n">assume_role_arn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assume a new role in AWS and return the credentials for that role.</span>
<span class="sd">    When ``assume_role_arn`` is ``None`` or an empty string,</span>
<span class="sd">    this function does nothing and returns an empty dictionary.</span>

<span class="sd">    Args:</span>
<span class="sd">        assume_role_arn: Optional ARN of the role that will be assumed</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict with credentials of the assumed role</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">boto3</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">assume_role_arn</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="n">sts_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;sts&quot;</span><span class="p">)</span>
    <span class="n">sts_response</span> <span class="o">=</span> <span class="n">sts_client</span><span class="o">.</span><span class="n">assume_role</span><span class="p">(</span>
        <span class="n">RoleArn</span><span class="o">=</span><span class="n">assume_role_arn</span><span class="p">,</span> <span class="n">RoleSessionName</span><span class="o">=</span><span class="s2">&quot;mlflow-sagemaker&quot;</span>
    <span class="p">)</span>

    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Assuming role </span><span class="si">%s</span><span class="s2"> for deployment!&quot;</span><span class="p">,</span> <span class="n">assume_role_arn</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;aws_access_key_id&quot;</span><span class="p">:</span> <span class="n">sts_response</span><span class="p">[</span><span class="s2">&quot;Credentials&quot;</span><span class="p">][</span><span class="s2">&quot;AccessKeyId&quot;</span><span class="p">],</span>
        <span class="s2">&quot;aws_secret_access_key&quot;</span><span class="p">:</span> <span class="n">sts_response</span><span class="p">[</span><span class="s2">&quot;Credentials&quot;</span><span class="p">][</span><span class="s2">&quot;SecretAccessKey&quot;</span><span class="p">],</span>
        <span class="s2">&quot;aws_session_token&quot;</span><span class="p">:</span> <span class="n">sts_response</span><span class="p">[</span><span class="s2">&quot;Credentials&quot;</span><span class="p">][</span><span class="s2">&quot;SessionToken&quot;</span><span class="p">],</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">_get_default_s3_bucket</span><span class="p">(</span><span class="n">region_name</span><span class="p">,</span> <span class="o">**</span><span class="n">assume_role_credentials</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">boto3</span>

    <span class="c1"># create bucket if it does not exist</span>
    <span class="n">sess</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
    <span class="n">account_id</span> <span class="o">=</span> <span class="n">_get_account_id</span><span class="p">(</span><span class="o">**</span><span class="n">assume_role_credentials</span><span class="p">)</span>
    <span class="n">bucket_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">DEFAULT_BUCKET_NAME_PREFIX</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">account_id</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">s3</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;s3&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">assume_role_credentials</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">s3</span><span class="o">.</span><span class="n">list_buckets</span><span class="p">()</span>
    <span class="n">buckets</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;Buckets&quot;</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">bucket_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">buckets</span><span class="p">:</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Default bucket `</span><span class="si">%s</span><span class="s2">` not found. Creating...&quot;</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">)</span>
        <span class="n">bucket_creation_kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;ACL&quot;</span><span class="p">:</span> <span class="s2">&quot;bucket-owner-full-control&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Bucket&quot;</span><span class="p">:</span> <span class="n">bucket_name</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">region_name</span> <span class="o">!=</span> <span class="s2">&quot;us-east-1&quot;</span><span class="p">:</span>
            <span class="c1"># The location constraint is required during bucket creation for all regions</span>
            <span class="c1"># outside of us-east-1. This constraint cannot be specified in us-east-1;</span>
            <span class="c1"># specifying it in this region results in a failure, so we will only</span>
            <span class="c1"># add it if we are deploying outside of us-east-1.</span>
            <span class="c1"># See https://docs.aws.amazon.com/cli/latest/reference/s3api/create-bucket.html#examples</span>
            <span class="n">bucket_creation_kwargs</span><span class="p">[</span><span class="s2">&quot;CreateBucketConfiguration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;LocationConstraint&quot;</span><span class="p">:</span> <span class="n">region_name</span>
            <span class="p">}</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">s3</span><span class="o">.</span><span class="n">create_bucket</span><span class="p">(</span><span class="o">**</span><span class="n">bucket_creation_kwargs</span><span class="p">)</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Bucket creation response: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Default bucket `</span><span class="si">%s</span><span class="s2">` already exists. Skipping creation.&quot;</span><span class="p">,</span> <span class="n">bucket_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bucket_name</span>


<span class="k">def</span> <span class="nf">_make_tarfile</span><span class="p">(</span><span class="n">output_filename</span><span class="p">,</span> <span class="n">source_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    create a tar.gz from a directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_filename</span><span class="p">,</span> <span class="s2">&quot;w:gz&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tar</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">source_dir</span><span class="p">):</span>
            <span class="n">tar</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">),</span> <span class="n">arcname</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_upload_s3</span><span class="p">(</span><span class="n">local_model_path</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">region_name</span><span class="p">,</span> <span class="n">s3_client</span><span class="p">,</span> <span class="o">**</span><span class="n">assume_role_credentials</span><span class="p">):</span>  <span class="c1"># noqa: D417</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Upload dir to S3 as .tar.gz.</span>

<span class="sd">    Args:</span>
<span class="sd">        local_model_path: Local path to a dir.</span>
<span class="sd">        bucket: S3 bucket where to store the data.</span>
<span class="sd">        prefix: Path within the bucket.</span>
<span class="sd">        region_name: The AWS region in which to upload data to S3.</span>
<span class="sd">        s3_client: A boto3 client for S3.</span>

<span class="sd">    Returns:</span>
<span class="sd">        S3 path of the uploaded artifact.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">boto3</span>

    <span class="n">sess</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">region_name</span><span class="o">=</span><span class="n">region_name</span><span class="p">,</span> <span class="o">**</span><span class="n">assume_role_credentials</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">TempDir</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmp</span><span class="p">:</span>
        <span class="n">model_data_file</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="s2">&quot;model.tar.gz&quot;</span><span class="p">)</span>
        <span class="n">_make_tarfile</span><span class="p">(</span><span class="n">model_data_file</span><span class="p">,</span> <span class="n">local_model_path</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">model_data_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fobj</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="s2">&quot;model.tar.gz&quot;</span><span class="p">)</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s2">&quot;s3&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">Bucket</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span><span class="o">.</span><span class="n">Object</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">upload_fileobj</span><span class="p">(</span><span class="n">fobj</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">s3_client</span><span class="o">.</span><span class="n">put_object_tagging</span><span class="p">(</span>
                <span class="n">Bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">Tagging</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;TagSet&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;Key&quot;</span><span class="p">:</span> <span class="s2">&quot;SageMaker&quot;</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">}]}</span>
            <span class="p">)</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;tag response: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;s3://</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="k">def</span> <span class="nf">_get_deployment_config</span><span class="p">(</span><span class="n">flavor_name</span><span class="p">,</span> <span class="n">env_override</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns:</span>
<span class="sd">        The deployment configuration as a dictionary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">deployment_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">MLFLOW_DEPLOYMENT_FLAVOR_NAME</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">flavor_name</span><span class="p">,</span>
        <span class="n">SERVING_ENVIRONMENT</span><span class="p">:</span> <span class="n">SAGEMAKER_SERVING_ENVIRONMENT</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">env_override</span><span class="p">:</span>
        <span class="n">deployment_config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">env_override</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;http_proxy&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">deployment_config</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;http_proxy&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;http_proxy&quot;</span><span class="p">]})</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;https_proxy&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">deployment_config</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;https_proxy&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;https_proxy&quot;</span><span class="p">]})</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;no_proxy&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">deployment_config</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;no_proxy&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;no_proxy&quot;</span><span class="p">]})</span>

    <span class="k">return</span> <span class="n">deployment_config</span>


<span class="k">def</span> <span class="nf">_truncate_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">max_length</span><span class="p">):</span>
    <span class="c1"># NB: Sagemaker prevents the registration of models and configurations whose names</span>
    <span class="c1"># exceed 63 characters in length. For reference:</span>
    <span class="c1"># https://docs.aws.amazon.com/sagemaker/latest/APIReference/API_Model.html</span>
    <span class="c1"># https://docs.aws.amazon.com/sagemaker/latest/APIReference/API_TransformJob.html</span>
    <span class="c1"># https://docs.aws.amazon.com/sagemaker/latest/APIReference/API_ModelConfiguration.html</span>
    <span class="c1"># This function middle-truncates the name provided to</span>
    <span class="c1"># ensure that the least critical name information is not lost</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">max_length</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">name</span>
    <span class="n">available_length</span> <span class="o">=</span> <span class="n">max_length</span> <span class="o">-</span> <span class="mi">3</span>
    <span class="n">start_len</span> <span class="o">=</span> <span class="n">available_length</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">end_len</span> <span class="o">=</span> <span class="n">available_length</span> <span class="o">-</span> <span class="n">start_len</span>
    <span class="n">truncated_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="p">[:</span><span class="n">start_len</span><span class="p">]</span><span class="si">}</span><span class="s2">---</span><span class="si">{</span><span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="n">end_len</span><span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Truncated name </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">truncated_name</span><span class="si">}</span><span class="s2"> to coerce total character counts to &lt; 64&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">truncated_name</span>


<span class="k">def</span> <span class="nf">_get_unique_name</span><span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="n">unique_suffix</span><span class="p">,</span> <span class="n">unique_id_length</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="n">unique_id</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">[:</span><span class="n">unique_id_length</span><span class="p">]</span>
    <span class="n">unique_resource_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">unique_suffix</span><span class="si">}{</span><span class="n">unique_id</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">max_length</span> <span class="o">=</span> <span class="mi">63</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_resource_string</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_truncate_name</span><span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="n">max_length</span><span class="p">)</span> <span class="o">+</span> <span class="n">unique_resource_string</span>


<span class="k">def</span> <span class="nf">_get_sagemaker_model_name</span><span class="p">(</span><span class="n">endpoint_name</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_get_unique_name</span><span class="p">(</span><span class="n">endpoint_name</span><span class="p">,</span> <span class="s2">&quot;-model-&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_sagemaker_transform_model_name</span><span class="p">(</span><span class="n">job_name</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_get_unique_name</span><span class="p">(</span><span class="n">job_name</span><span class="p">,</span> <span class="s2">&quot;-model-&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_sagemaker_config_name</span><span class="p">(</span><span class="n">endpoint_name</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_get_unique_name</span><span class="p">(</span><span class="n">endpoint_name</span><span class="p">,</span> <span class="s2">&quot;-config-&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_sagemaker_config_tags</span><span class="p">(</span><span class="n">endpoint_name</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;Key&quot;</span><span class="p">:</span> <span class="n">SAGEMAKER_APP_NAME_TAG_KEY</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">:</span> <span class="n">endpoint_name</span><span class="p">}]</span>


<span class="k">def</span> <span class="nf">_prepare_sagemaker_tags</span><span class="p">(</span>
    <span class="n">config_tags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span>
    <span class="n">sagemaker_tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sagemaker_tags</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">config_tags</span>

    <span class="k">if</span> <span class="n">SAGEMAKER_APP_NAME_TAG_KEY</span> <span class="ow">in</span> <span class="n">sagemaker_tags</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">MlflowException</span><span class="o">.</span><span class="n">invalid_parameter_value</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Duplicate tag provided for &#39;</span><span class="si">{</span><span class="n">SAGEMAKER_APP_NAME_TAG_KEY</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        <span class="p">)</span>
    <span class="n">parsed</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;Key&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)}</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">sagemaker_tags</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>

    <span class="k">return</span> <span class="n">config_tags</span> <span class="o">+</span> <span class="n">parsed</span>


<span class="k">def</span> <span class="nf">_create_sagemaker_transform_job</span><span class="p">(</span>
    <span class="n">job_name</span><span class="p">,</span>
    <span class="n">model_name</span><span class="p">,</span>
    <span class="n">model_s3_path</span><span class="p">,</span>
    <span class="n">model_uri</span><span class="p">,</span>
    <span class="n">image_url</span><span class="p">,</span>
    <span class="n">flavor</span><span class="p">,</span>
    <span class="n">vpc_config</span><span class="p">,</span>
    <span class="n">role</span><span class="p">,</span>
    <span class="n">sage_client</span><span class="p">,</span>
    <span class="n">s3_client</span><span class="p">,</span>
    <span class="n">instance_type</span><span class="p">,</span>
    <span class="n">instance_count</span><span class="p">,</span>
    <span class="n">s3_input_data_type</span><span class="p">,</span>
    <span class="n">s3_input_uri</span><span class="p">,</span>
    <span class="n">content_type</span><span class="p">,</span>
    <span class="n">compression_type</span><span class="p">,</span>
    <span class="n">split_type</span><span class="p">,</span>
    <span class="n">s3_output_path</span><span class="p">,</span>
    <span class="n">accept</span><span class="p">,</span>
    <span class="n">assemble_with</span><span class="p">,</span>
    <span class="n">input_filter</span><span class="p">,</span>
    <span class="n">output_filter</span><span class="p">,</span>
    <span class="n">join_resource</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        job_name: Name of the deployed Sagemaker batch transform job.</span>
<span class="sd">        model_name: The name to assign the new SageMaker model that will be associated with the</span>
<span class="sd">            specified batch transform job.</span>
<span class="sd">        model_s3_path: S3 path where we stored the model artifacts.</span>
<span class="sd">        model_uri: URI of the MLflow model to associate with the specified SageMaker batch</span>
<span class="sd">            transform job.</span>
<span class="sd">        image_url: URL of the ECR-hosted docker image the model is being deployed into.</span>
<span class="sd">        flavor: The name of the flavor of the model to use for deployment.</span>
<span class="sd">        vpc_config: A dictionary specifying the VPC configuration to use when creating the</span>
<span class="sd">            new SageMaker model associated with this SageMaker batch transform job.</span>
<span class="sd">        role: SageMaker execution ARN role.</span>
<span class="sd">        sage_client: A boto3 client for SageMaker.</span>
<span class="sd">        s3_client: A boto3 client for S3.</span>
<span class="sd">        instance_type: The type of SageMaker ML instance on which to deploy the model.</span>
<span class="sd">        instance_count: The number of SageMaker ML instances on which to deploy the model.</span>
<span class="sd">        s3_input_data_type: Input data type for the transform job.</span>
<span class="sd">        s3_input_uri: S3 key name prefix or a manifest of the input data.</span>
<span class="sd">        content_type: The multipurpose internet mail extension (MIME) type of the data.</span>
<span class="sd">        compression_type: The compression type of the transform data.</span>
<span class="sd">        split_type: The method to split the transform job&#39;s data files into smaller batches.</span>
<span class="sd">        s3_output_path: The S3 path to store the output results of the Sagemaker transform job.</span>
<span class="sd">        accept: The multipurpose internet mail extension (MIME) type of the output data.</span>
<span class="sd">        assemble_with: The method to assemble the results of the transform job as a single</span>
<span class="sd">            S3 object.</span>
<span class="sd">        input_filter: A JSONPath expression used to select a portion of the input data for the</span>
<span class="sd">            transform job.</span>
<span class="sd">        output_filter: A JSONPath expression used to select a portion of the output data from</span>
<span class="sd">            the transform job.</span>
<span class="sd">        join_resource: The source of the data to join with the transformed data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating new batch transform job with name: </span><span class="si">%s</span><span class="s2"> ...&quot;</span><span class="p">,</span> <span class="n">job_name</span><span class="p">)</span>

    <span class="n">model_response</span> <span class="o">=</span> <span class="n">_create_sagemaker_model</span><span class="p">(</span>
        <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
        <span class="n">model_s3_path</span><span class="o">=</span><span class="n">model_s3_path</span><span class="p">,</span>
        <span class="n">model_uri</span><span class="o">=</span><span class="n">model_uri</span><span class="p">,</span>
        <span class="n">flavor</span><span class="o">=</span><span class="n">flavor</span><span class="p">,</span>
        <span class="n">vpc_config</span><span class="o">=</span><span class="n">vpc_config</span><span class="p">,</span>
        <span class="n">image_url</span><span class="o">=</span><span class="n">image_url</span><span class="p">,</span>
        <span class="n">execution_role</span><span class="o">=</span><span class="n">role</span><span class="p">,</span>
        <span class="n">sage_client</span><span class="o">=</span><span class="n">sage_client</span><span class="p">,</span>
        <span class="n">env</span><span class="o">=</span><span class="p">{},</span>
        <span class="n">tags</span><span class="o">=</span><span class="p">{},</span>
    <span class="p">)</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created model with arn: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">model_response</span><span class="p">[</span><span class="s2">&quot;ModelArn&quot;</span><span class="p">])</span>

    <span class="n">transform_input</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;DataSource&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S3DataSource&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;S3DataType&quot;</span><span class="p">:</span> <span class="n">s3_input_data_type</span><span class="p">,</span> <span class="s2">&quot;S3Uri&quot;</span><span class="p">:</span> <span class="n">s3_input_uri</span><span class="p">}},</span>
        <span class="s2">&quot;ContentType&quot;</span><span class="p">:</span> <span class="n">content_type</span><span class="p">,</span>
        <span class="s2">&quot;CompressionType&quot;</span><span class="p">:</span> <span class="n">compression_type</span><span class="p">,</span>
        <span class="s2">&quot;SplitType&quot;</span><span class="p">:</span> <span class="n">split_type</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">transform_output</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;S3OutputPath&quot;</span><span class="p">:</span> <span class="n">s3_output_path</span><span class="p">,</span>
        <span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="n">accept</span><span class="p">,</span>
        <span class="s2">&quot;AssembleWith&quot;</span><span class="p">:</span> <span class="n">assemble_with</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">transform_resources</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;InstanceType&quot;</span><span class="p">:</span> <span class="n">instance_type</span><span class="p">,</span> <span class="s2">&quot;InstanceCount&quot;</span><span class="p">:</span> <span class="n">instance_count</span><span class="p">}</span>

    <span class="n">data_processing</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;InputFilter&quot;</span><span class="p">:</span> <span class="n">input_filter</span><span class="p">,</span>
        <span class="s2">&quot;OutputFilter&quot;</span><span class="p">:</span> <span class="n">output_filter</span><span class="p">,</span>
        <span class="s2">&quot;JoinSource&quot;</span><span class="p">:</span> <span class="n">join_resource</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">transform_job_response</span> <span class="o">=</span> <span class="n">sage_client</span><span class="o">.</span><span class="n">create_transform_job</span><span class="p">(</span>
        <span class="n">TransformJobName</span><span class="o">=</span><span class="n">job_name</span><span class="p">,</span>
        <span class="n">ModelName</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
        <span class="n">TransformInput</span><span class="o">=</span><span class="n">transform_input</span><span class="p">,</span>
        <span class="n">TransformOutput</span><span class="o">=</span><span class="n">transform_output</span><span class="p">,</span>
        <span class="n">TransformResources</span><span class="o">=</span><span class="n">transform_resources</span><span class="p">,</span>
        <span class="n">DataProcessing</span><span class="o">=</span><span class="n">data_processing</span><span class="p">,</span>
        <span class="n">Tags</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;Key&quot;</span><span class="p">:</span> <span class="s2">&quot;model_name&quot;</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">}],</span>
    <span class="p">)</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;Created batch transform job with arn: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">transform_job_response</span><span class="p">[</span><span class="s2">&quot;TransformJobArn&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">status_check_fn</span><span class="p">():</span>
        <span class="n">transform_job_info</span> <span class="o">=</span> <span class="n">sage_client</span><span class="o">.</span><span class="n">describe_transform_job</span><span class="p">(</span><span class="n">TransformJobName</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">transform_job_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_SageMakerOperationStatus</span><span class="o">.</span><span class="n">in_progress</span><span class="p">(</span>
                <span class="s2">&quot;Waiting for batch transform job to be created...&quot;</span>
            <span class="p">)</span>

        <span class="n">transform_job_status</span> <span class="o">=</span> <span class="n">transform_job_info</span><span class="p">[</span><span class="s2">&quot;TransformJobStatus&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">transform_job_status</span> <span class="o">==</span> <span class="s2">&quot;InProgress&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_SageMakerOperationStatus</span><span class="o">.</span><span class="n">in_progress</span><span class="p">(</span>
                <span class="s1">&#39;Waiting for batch transform job to reach the &quot;Completed&quot; state.                   &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;  Current batch transform job status: &quot;</span><span class="si">{</span><span class="n">transform_job_status</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">transform_job_status</span> <span class="o">==</span> <span class="s2">&quot;Completed&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_SageMakerOperationStatus</span><span class="o">.</span><span class="n">succeeded</span><span class="p">(</span>
                <span class="s2">&quot;The SageMaker batch transform job was processed successfully.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">failure_reason</span> <span class="o">=</span> <span class="n">transform_job_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;FailureReason&quot;</span><span class="p">,</span>
                <span class="s2">&quot;An unknown SageMaker failure occurred. Please see the SageMaker console logs&quot;</span>
                <span class="s2">&quot; for more information.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">_SageMakerOperationStatus</span><span class="o">.</span><span class="n">failed</span><span class="p">(</span><span class="n">failure_reason</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cleanup_fn</span><span class="p">():</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cleaning up Sagemaker model and S3 model artifacts...&quot;</span><span class="p">)</span>
        <span class="n">transform_job_info</span> <span class="o">=</span> <span class="n">sage_client</span><span class="o">.</span><span class="n">describe_transform_job</span><span class="p">(</span><span class="n">TransformJobName</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
        <span class="n">model_name</span> <span class="o">=</span> <span class="n">transform_job_info</span><span class="p">[</span><span class="s2">&quot;ModelName&quot;</span><span class="p">]</span>
        <span class="n">model_arn</span> <span class="o">=</span> <span class="n">_delete_sagemaker_model</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">sage_client</span><span class="p">,</span> <span class="n">s3_client</span><span class="p">)</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deleted associated model with arn: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">model_arn</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_SageMakerOperation</span><span class="p">(</span><span class="n">status_check_fn</span><span class="o">=</span><span class="n">status_check_fn</span><span class="p">,</span> <span class="n">cleanup_fn</span><span class="o">=</span><span class="n">cleanup_fn</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_create_sagemaker_endpoint</span><span class="p">(</span>  <span class="c1"># noqa: D417</span>
    <span class="n">endpoint_name</span><span class="p">,</span>
    <span class="n">model_name</span><span class="p">,</span>
    <span class="n">model_s3_path</span><span class="p">,</span>
    <span class="n">model_uri</span><span class="p">,</span>
    <span class="n">image_url</span><span class="p">,</span>
    <span class="n">flavor</span><span class="p">,</span>
    <span class="n">instance_type</span><span class="p">,</span>
    <span class="n">vpc_config</span><span class="p">,</span>
    <span class="n">data_capture_config</span><span class="p">,</span>
    <span class="n">instance_count</span><span class="p">,</span>
    <span class="n">role</span><span class="p">,</span>
    <span class="n">sage_client</span><span class="p">,</span>
    <span class="n">variant_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">async_inference_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">serverless_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">tags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        endpoint_name: The name of the SageMaker endpoint to create.</span>
<span class="sd">        model_name: The name to assign the new SageMaker model that will be associated with the</span>
<span class="sd">            specified endpoint.</span>
<span class="sd">        model_s3_path: S3 path where we stored the model artifacts.</span>
<span class="sd">        model_uri: URI of the MLflow model to associate with the specified SageMaker endpoint.</span>
<span class="sd">        image_url: URL of the ECR-hosted docker image the model is being deployed into.</span>
<span class="sd">        flavor: The name of the flavor of the model to use for deployment.</span>
<span class="sd">        instance_type: The type of SageMaker ML instance on which to deploy the model.</span>
<span class="sd">        instance_count: The number of SageMaker ML instances on which to deploy the model.</span>
<span class="sd">        vpc_config: A dictionary specifying the VPC configuration to use when creating the</span>
<span class="sd">            new SageMaker model associated with this SageMaker endpoint.</span>
<span class="sd">        data_capture_config: A dictionary specifying the data capture configuration to use when</span>
<span class="sd">            creating the new SageMaker model associated with this application.</span>
<span class="sd">        role: SageMaker execution ARN role.</span>
<span class="sd">        sage_client: A boto3 client for SageMaker.</span>
<span class="sd">        variant_name: The name to assign to the new production variant.</span>
<span class="sd">        env: A dictionary of environment variables to set for the model.</span>
<span class="sd">        tags: A dictionary of tags to apply to the endpoint.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating new endpoint with name: </span><span class="si">%s</span><span class="s2"> ...&quot;</span><span class="p">,</span> <span class="n">endpoint_name</span><span class="p">)</span>

    <span class="n">model_response</span> <span class="o">=</span> <span class="n">_create_sagemaker_model</span><span class="p">(</span>
        <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
        <span class="n">model_s3_path</span><span class="o">=</span><span class="n">model_s3_path</span><span class="p">,</span>
        <span class="n">model_uri</span><span class="o">=</span><span class="n">model_uri</span><span class="p">,</span>
        <span class="n">flavor</span><span class="o">=</span><span class="n">flavor</span><span class="p">,</span>
        <span class="n">vpc_config</span><span class="o">=</span><span class="n">vpc_config</span><span class="p">,</span>
        <span class="n">image_url</span><span class="o">=</span><span class="n">image_url</span><span class="p">,</span>
        <span class="n">execution_role</span><span class="o">=</span><span class="n">role</span><span class="p">,</span>
        <span class="n">sage_client</span><span class="o">=</span><span class="n">sage_client</span><span class="p">,</span>
        <span class="n">env</span><span class="o">=</span><span class="n">env</span> <span class="ow">or</span> <span class="p">{},</span>
        <span class="n">tags</span><span class="o">=</span><span class="n">tags</span> <span class="ow">or</span> <span class="p">{},</span>
    <span class="p">)</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created model with arn: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">model_response</span><span class="p">[</span><span class="s2">&quot;ModelArn&quot;</span><span class="p">])</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">variant_name</span><span class="p">:</span>
        <span class="n">variant_name</span> <span class="o">=</span> <span class="n">model_name</span>

    <span class="n">production_variant</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;VariantName&quot;</span><span class="p">:</span> <span class="n">variant_name</span><span class="p">,</span>
        <span class="s2">&quot;ModelName&quot;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
        <span class="s2">&quot;InitialVariantWeight&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">serverless_config</span><span class="p">:</span>
        <span class="n">production_variant</span><span class="p">[</span><span class="s2">&quot;ServerlessConfig&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">serverless_config</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">production_variant</span><span class="p">[</span><span class="s2">&quot;InstanceType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance_type</span>
        <span class="n">production_variant</span><span class="p">[</span><span class="s2">&quot;InitialInstanceCount&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance_count</span>

    <span class="n">config_name</span> <span class="o">=</span> <span class="n">_get_sagemaker_config_name</span><span class="p">(</span><span class="n">endpoint_name</span><span class="p">)</span>
    <span class="n">config_tags</span> <span class="o">=</span> <span class="n">_get_sagemaker_config_tags</span><span class="p">(</span><span class="n">endpoint_name</span><span class="p">)</span>
    <span class="n">tags_list</span> <span class="o">=</span> <span class="n">_prepare_sagemaker_tags</span><span class="p">(</span><span class="n">config_tags</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>
    <span class="n">endpoint_config_kwargs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;EndpointConfigName&quot;</span><span class="p">:</span> <span class="n">config_name</span><span class="p">,</span>
        <span class="s2">&quot;ProductionVariants&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">production_variant</span><span class="p">],</span>
        <span class="s2">&quot;Tags&quot;</span><span class="p">:</span> <span class="n">config_tags</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">async_inference_config</span><span class="p">:</span>
        <span class="n">endpoint_config_kwargs</span><span class="p">[</span><span class="s2">&quot;AsyncInferenceConfig&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">async_inference_config</span>
    <span class="k">if</span> <span class="n">data_capture_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">endpoint_config_kwargs</span><span class="p">[</span><span class="s2">&quot;DataCaptureConfig&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_capture_config</span>
    <span class="n">endpoint_config_response</span> <span class="o">=</span> <span class="n">sage_client</span><span class="o">.</span><span class="n">create_endpoint_config</span><span class="p">(</span><span class="o">**</span><span class="n">endpoint_config_kwargs</span><span class="p">)</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;Created endpoint configuration with arn: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">endpoint_config_response</span><span class="p">[</span><span class="s2">&quot;EndpointConfigArn&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="n">endpoint_response</span> <span class="o">=</span> <span class="n">sage_client</span><span class="o">.</span><span class="n">create_endpoint</span><span class="p">(</span>
        <span class="n">EndpointName</span><span class="o">=</span><span class="n">endpoint_name</span><span class="p">,</span>
        <span class="n">EndpointConfigName</span><span class="o">=</span><span class="n">config_name</span><span class="p">,</span>
        <span class="n">Tags</span><span class="o">=</span><span class="n">tags_list</span> <span class="ow">or</span> <span class="p">[],</span>
    <span class="p">)</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created endpoint with arn: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">endpoint_response</span><span class="p">[</span><span class="s2">&quot;EndpointArn&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">status_check_fn</span><span class="p">():</span>
        <span class="n">endpoint_info</span> <span class="o">=</span> <span class="n">_find_endpoint</span><span class="p">(</span><span class="n">endpoint_name</span><span class="o">=</span><span class="n">endpoint_name</span><span class="p">,</span> <span class="n">sage_client</span><span class="o">=</span><span class="n">sage_client</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">endpoint_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_SageMakerOperationStatus</span><span class="o">.</span><span class="n">in_progress</span><span class="p">(</span><span class="s2">&quot;Waiting for endpoint to be created...&quot;</span><span class="p">)</span>

        <span class="n">endpoint_status</span> <span class="o">=</span> <span class="n">endpoint_info</span><span class="p">[</span><span class="s2">&quot;EndpointStatus&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">endpoint_status</span> <span class="o">==</span> <span class="s2">&quot;Creating&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_SageMakerOperationStatus</span><span class="o">.</span><span class="n">in_progress</span><span class="p">(</span>
                <span class="s1">&#39;Waiting for endpoint to reach the &quot;InService&quot; state. Current endpoint status:&#39;</span>
                <span class="sa">f</span><span class="s1">&#39; &quot;</span><span class="si">{</span><span class="n">endpoint_status</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">endpoint_status</span> <span class="o">==</span> <span class="s2">&quot;InService&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_SageMakerOperationStatus</span><span class="o">.</span><span class="n">succeeded</span><span class="p">(</span>
                <span class="s2">&quot;The SageMaker endpoint was created successfully.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">failure_reason</span> <span class="o">=</span> <span class="n">endpoint_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;FailureReason&quot;</span><span class="p">,</span>
                <span class="s2">&quot;An unknown SageMaker failure occurred. Please see the SageMaker console logs&quot;</span>
                <span class="s2">&quot; for more information.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">_SageMakerOperationStatus</span><span class="o">.</span><span class="n">failed</span><span class="p">(</span><span class="n">failure_reason</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cleanup_fn</span><span class="p">():</span>
        <span class="k">pass</span>

    <span class="k">return</span> <span class="n">_SageMakerOperation</span><span class="p">(</span><span class="n">status_check_fn</span><span class="o">=</span><span class="n">status_check_fn</span><span class="p">,</span> <span class="n">cleanup_fn</span><span class="o">=</span><span class="n">cleanup_fn</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_update_sagemaker_endpoint</span><span class="p">(</span>  <span class="c1"># noqa: D417</span>
    <span class="n">endpoint_name</span><span class="p">,</span>
    <span class="n">model_name</span><span class="p">,</span>
    <span class="n">model_uri</span><span class="p">,</span>
    <span class="n">image_url</span><span class="p">,</span>
    <span class="n">model_s3_path</span><span class="p">,</span>
    <span class="n">flavor</span><span class="p">,</span>
    <span class="n">instance_type</span><span class="p">,</span>
    <span class="n">instance_count</span><span class="p">,</span>
    <span class="n">vpc_config</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">,</span>
    <span class="n">role</span><span class="p">,</span>
    <span class="n">sage_client</span><span class="p">,</span>
    <span class="n">s3_client</span><span class="p">,</span>
    <span class="n">variant_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">async_inference_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">serverless_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">data_capture_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">tags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        endpoint_name: The name of the SageMaker endpoint to update.</span>
<span class="sd">        model_name: The name to assign the new SageMaker model that will be associated with the</span>
<span class="sd">            specified endpoint.</span>
<span class="sd">        model_uri: URI of the MLflow model to associate with the specified SageMaker endpoint.</span>
<span class="sd">        image_url: URL of the ECR-hosted Docker image the model is being deployed into</span>
<span class="sd">        model_s3_path: S3 path where we stored the model artifacts</span>
<span class="sd">        flavor: The name of the flavor of the model to use for deployment.</span>
<span class="sd">        instance_type: The type of SageMaker ML instance on which to deploy the model.</span>
<span class="sd">        instance_count: The number of SageMaker ML instances on which to deploy the model.</span>
<span class="sd">        vpc_config: A dictionary specifying the VPC configuration to use when creating the</span>
<span class="sd">            new SageMaker model associated with this SageMaker endpoint.</span>
<span class="sd">        mode: either mlflow.sagemaker.DEPLOYMENT_MODE_ADD or</span>
<span class="sd">            mlflow.sagemaker.DEPLOYMENT_MODE_REPLACE.</span>
<span class="sd">        role: SageMaker execution ARN role.</span>
<span class="sd">        sage_client: A boto3 client for SageMaker.</span>
<span class="sd">        s3_client: A boto3 client for S3.</span>
<span class="sd">        variant_name: The name to assign to the new production variant if it doesn&#39;t already exist.</span>
<span class="sd">        async_inference_config: A dictionary specifying the async inference configuration to use.</span>
<span class="sd">            For more information, see https://docs.aws.amazon.com/sagemaker/latest/APIReference/API_AsyncInferenceConfig.html.</span>
<span class="sd">            Defaults to ``None``.</span>
<span class="sd">        data_capture_config: A dictionary specifying the data capture configuration to use.</span>
<span class="sd">            For more information, see https://docs.aws.amazon.com/sagemaker/latest/APIReference/API_DataCaptureConfig.html.</span>
<span class="sd">            Defaults to ``None``.</span>
<span class="sd">        env: A dictionary of environment variables to set for the model.</span>
<span class="sd">        tags: A dictionary of tags to apply to the endpoint configuration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">DEPLOYMENT_MODE_ADD</span><span class="p">,</span> <span class="n">DEPLOYMENT_MODE_REPLACE</span><span class="p">]:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Invalid mode `</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">` for deployment to a pre-existing application&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">endpoint_info</span> <span class="o">=</span> <span class="n">sage_client</span><span class="o">.</span><span class="n">describe_endpoint</span><span class="p">(</span><span class="n">EndpointName</span><span class="o">=</span><span class="n">endpoint_name</span><span class="p">)</span>
    <span class="n">endpoint_arn</span> <span class="o">=</span> <span class="n">endpoint_info</span><span class="p">[</span><span class="s2">&quot;EndpointArn&quot;</span><span class="p">]</span>
    <span class="n">deployed_config_name</span> <span class="o">=</span> <span class="n">endpoint_info</span><span class="p">[</span><span class="s2">&quot;EndpointConfigName&quot;</span><span class="p">]</span>
    <span class="n">deployed_config_info</span> <span class="o">=</span> <span class="n">sage_client</span><span class="o">.</span><span class="n">describe_endpoint_config</span><span class="p">(</span>
        <span class="n">EndpointConfigName</span><span class="o">=</span><span class="n">deployed_config_name</span>
    <span class="p">)</span>
    <span class="n">deployed_config_arn</span> <span class="o">=</span> <span class="n">deployed_config_info</span><span class="p">[</span><span class="s2">&quot;EndpointConfigArn&quot;</span><span class="p">]</span>
    <span class="n">deployed_production_variants</span> <span class="o">=</span> <span class="n">deployed_config_info</span><span class="p">[</span><span class="s2">&quot;ProductionVariants&quot;</span><span class="p">]</span>

    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Found active endpoint with arn: </span><span class="si">%s</span><span class="s2">. Updating...&quot;</span><span class="p">,</span> <span class="n">endpoint_arn</span><span class="p">)</span>

    <span class="n">new_model_response</span> <span class="o">=</span> <span class="n">_create_sagemaker_model</span><span class="p">(</span>
        <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
        <span class="n">model_s3_path</span><span class="o">=</span><span class="n">model_s3_path</span><span class="p">,</span>
        <span class="n">model_uri</span><span class="o">=</span><span class="n">model_uri</span><span class="p">,</span>
        <span class="n">flavor</span><span class="o">=</span><span class="n">flavor</span><span class="p">,</span>
        <span class="n">vpc_config</span><span class="o">=</span><span class="n">vpc_config</span><span class="p">,</span>
        <span class="n">image_url</span><span class="o">=</span><span class="n">image_url</span><span class="p">,</span>
        <span class="n">execution_role</span><span class="o">=</span><span class="n">role</span><span class="p">,</span>
        <span class="n">sage_client</span><span class="o">=</span><span class="n">sage_client</span><span class="p">,</span>
        <span class="n">env</span><span class="o">=</span><span class="n">env</span> <span class="ow">or</span> <span class="p">{},</span>
        <span class="n">tags</span><span class="o">=</span><span class="n">tags</span> <span class="ow">or</span> <span class="p">{},</span>
    <span class="p">)</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created new model with arn: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">new_model_response</span><span class="p">[</span><span class="s2">&quot;ModelArn&quot;</span><span class="p">])</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">variant_name</span><span class="p">:</span>
        <span class="n">variant_name</span> <span class="o">=</span> <span class="n">model_name</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">DEPLOYMENT_MODE_ADD</span><span class="p">:</span>
        <span class="n">new_model_weight</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">production_variants</span> <span class="o">=</span> <span class="n">deployed_production_variants</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">DEPLOYMENT_MODE_REPLACE</span><span class="p">:</span>
        <span class="n">new_model_weight</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">production_variants</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">new_production_variant</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;VariantName&quot;</span><span class="p">:</span> <span class="n">variant_name</span><span class="p">,</span>
        <span class="s2">&quot;ModelName&quot;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
        <span class="s2">&quot;InitialVariantWeight&quot;</span><span class="p">:</span> <span class="n">new_model_weight</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">serverless_config</span><span class="p">:</span>
        <span class="n">new_production_variant</span><span class="p">[</span><span class="s2">&quot;ServerlessConfig&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">serverless_config</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_production_variant</span><span class="p">[</span><span class="s2">&quot;InstanceType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance_type</span>
        <span class="n">new_production_variant</span><span class="p">[</span><span class="s2">&quot;InitialInstanceCount&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instance_count</span>

    <span class="n">production_variants</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_production_variant</span><span class="p">)</span>

    <span class="c1"># Create the new endpoint configuration and update the endpoint</span>
    <span class="c1"># to adopt the new configuration</span>
    <span class="n">new_config_name</span> <span class="o">=</span> <span class="n">_get_sagemaker_config_name</span><span class="p">(</span><span class="n">endpoint_name</span><span class="p">)</span>
    <span class="n">config_tags</span> <span class="o">=</span> <span class="n">_get_sagemaker_config_tags</span><span class="p">(</span><span class="n">endpoint_name</span><span class="p">)</span>
    <span class="n">endpoint_config_kwargs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;EndpointConfigName&quot;</span><span class="p">:</span> <span class="n">new_config_name</span><span class="p">,</span>
        <span class="s2">&quot;ProductionVariants&quot;</span><span class="p">:</span> <span class="n">production_variants</span><span class="p">,</span>
        <span class="s2">&quot;Tags&quot;</span><span class="p">:</span> <span class="n">config_tags</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">async_inference_config</span><span class="p">:</span>
        <span class="n">endpoint_config_kwargs</span><span class="p">[</span><span class="s2">&quot;AsyncInferenceConfig&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">async_inference_config</span>
    <span class="k">if</span> <span class="n">data_capture_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">endpoint_config_kwargs</span><span class="p">[</span><span class="s2">&quot;DataCaptureConfig&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_capture_config</span>
    <span class="n">endpoint_config_response</span> <span class="o">=</span> <span class="n">sage_client</span><span class="o">.</span><span class="n">create_endpoint_config</span><span class="p">(</span><span class="o">**</span><span class="n">endpoint_config_kwargs</span><span class="p">)</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;Created new endpoint configuration with arn: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">endpoint_config_response</span><span class="p">[</span><span class="s2">&quot;EndpointConfigArn&quot;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="n">sage_client</span><span class="o">.</span><span class="n">update_endpoint</span><span class="p">(</span><span class="n">EndpointName</span><span class="o">=</span><span class="n">endpoint_name</span><span class="p">,</span> <span class="n">EndpointConfigName</span><span class="o">=</span><span class="n">new_config_name</span><span class="p">)</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updated endpoint with new configuration!&quot;</span><span class="p">)</span>

    <span class="n">operation_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">status_check_fn</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">operation_start_time</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="c1"># Wait at least 20 seconds before checking the status of the update; this ensures</span>
            <span class="c1"># that we don&#39;t consider the operation to have failed if small delays occur at</span>
            <span class="c1"># initialization time</span>
            <span class="k">return</span> <span class="n">_SageMakerOperationStatus</span><span class="o">.</span><span class="n">in_progress</span><span class="p">()</span>

        <span class="n">endpoint_info</span> <span class="o">=</span> <span class="n">sage_client</span><span class="o">.</span><span class="n">describe_endpoint</span><span class="p">(</span><span class="n">EndpointName</span><span class="o">=</span><span class="n">endpoint_name</span><span class="p">)</span>
        <span class="n">endpoint_update_was_rolled_back</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">endpoint_info</span><span class="p">[</span><span class="s2">&quot;EndpointStatus&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;InService&quot;</span>
            <span class="ow">and</span> <span class="n">endpoint_info</span><span class="p">[</span><span class="s2">&quot;EndpointConfigName&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">new_config_name</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">endpoint_update_was_rolled_back</span> <span class="ow">or</span> <span class="n">endpoint_info</span><span class="p">[</span><span class="s2">&quot;EndpointStatus&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Failed&quot;</span><span class="p">:</span>
            <span class="n">failure_reason</span> <span class="o">=</span> <span class="n">endpoint_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;FailureReason&quot;</span><span class="p">,</span>
                <span class="s2">&quot;An unknown SageMaker failure occurred.&quot;</span>
                <span class="s2">&quot; Please see the SageMaker console logs for&quot;</span>
                <span class="s2">&quot; more information.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">_SageMakerOperationStatus</span><span class="o">.</span><span class="n">failed</span><span class="p">(</span><span class="n">failure_reason</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">endpoint_info</span><span class="p">[</span><span class="s2">&quot;EndpointStatus&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;InService&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_SageMakerOperationStatus</span><span class="o">.</span><span class="n">succeeded</span><span class="p">(</span>
                <span class="s2">&quot;The SageMaker endpoint was updated successfully.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_SageMakerOperationStatus</span><span class="o">.</span><span class="n">in_progress</span><span class="p">(</span>
                <span class="s2">&quot;The update operation is still in progress. Current endpoint status:&quot;</span>
                <span class="s1">&#39; &quot;</span><span class="si">{endpoint_status}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">endpoint_status</span><span class="o">=</span><span class="n">endpoint_info</span><span class="p">[</span><span class="s2">&quot;EndpointStatus&quot;</span><span class="p">])</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">cleanup_fn</span><span class="p">():</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cleaning up unused resources...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">DEPLOYMENT_MODE_REPLACE</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pv</span> <span class="ow">in</span> <span class="n">deployed_production_variants</span><span class="p">:</span>
                <span class="n">deployed_model_arn</span> <span class="o">=</span> <span class="n">_delete_sagemaker_model</span><span class="p">(</span>
                    <span class="n">model_name</span><span class="o">=</span><span class="n">pv</span><span class="p">[</span><span class="s2">&quot;ModelName&quot;</span><span class="p">],</span> <span class="n">sage_client</span><span class="o">=</span><span class="n">sage_client</span><span class="p">,</span> <span class="n">s3_client</span><span class="o">=</span><span class="n">s3_client</span>
                <span class="p">)</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deleted model with arn: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">deployed_model_arn</span><span class="p">)</span>

        <span class="n">sage_client</span><span class="o">.</span><span class="n">delete_endpoint_config</span><span class="p">(</span><span class="n">EndpointConfigName</span><span class="o">=</span><span class="n">deployed_config_name</span><span class="p">)</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deleted endpoint configuration with arn: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">deployed_config_arn</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_SageMakerOperation</span><span class="p">(</span><span class="n">status_check_fn</span><span class="o">=</span><span class="n">status_check_fn</span><span class="p">,</span> <span class="n">cleanup_fn</span><span class="o">=</span><span class="n">cleanup_fn</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_create_sagemaker_model</span><span class="p">(</span>
    <span class="n">model_name</span><span class="p">,</span>
    <span class="n">model_s3_path</span><span class="p">,</span>
    <span class="n">model_uri</span><span class="p">,</span>
    <span class="n">flavor</span><span class="p">,</span>
    <span class="n">vpc_config</span><span class="p">,</span>
    <span class="n">image_url</span><span class="p">,</span>
    <span class="n">execution_role</span><span class="p">,</span>
    <span class="n">sage_client</span><span class="p">,</span>
    <span class="n">env</span><span class="p">,</span>
    <span class="n">tags</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        model_name: The name to assign the new SageMaker model that is created.</span>
<span class="sd">        model_s3_path: S3 path where the model artifacts are stored.</span>
<span class="sd">        model_uri: URI of the MLflow model associated with the new SageMaker model.</span>
<span class="sd">        flavor: The name of the flavor of the model.</span>
<span class="sd">        vpc_config: A dictionary specifying the VPC configuration to use when creating the</span>
<span class="sd">            new SageMaker model associated with this SageMaker endpoint.</span>
<span class="sd">        image_url: URL of the ECR-hosted Docker image that will serve as the</span>
<span class="sd">            model&#39;s container,</span>
<span class="sd">        execution_role: The ARN of the role that SageMaker will assume when creating the model.</span>
<span class="sd">        sage_client: A boto3 client for SageMaker.</span>
<span class="sd">        env: A dictionary of environment variables to set for the model.</span>
<span class="sd">        tags: A dictionary of tags to apply to the SageMaker model.</span>

<span class="sd">    Returns:</span>
<span class="sd">        AWS response containing metadata associated with the new model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tags</span><span class="p">[</span><span class="s2">&quot;model_uri&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">model_uri</span><span class="p">)</span>
    <span class="n">create_model_args</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;ModelName&quot;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
        <span class="s2">&quot;PrimaryContainer&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;Image&quot;</span><span class="p">:</span> <span class="n">image_url</span><span class="p">,</span>
            <span class="s2">&quot;ModelDataUrl&quot;</span><span class="p">:</span> <span class="n">model_s3_path</span><span class="p">,</span>
            <span class="s2">&quot;Environment&quot;</span><span class="p">:</span> <span class="n">_get_deployment_config</span><span class="p">(</span><span class="n">flavor_name</span><span class="o">=</span><span class="n">flavor</span><span class="p">,</span> <span class="n">env_override</span><span class="o">=</span><span class="n">env</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="s2">&quot;ExecutionRoleArn&quot;</span><span class="p">:</span> <span class="n">execution_role</span><span class="p">,</span>
        <span class="s2">&quot;Tags&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;Key&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)}</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">tags</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">vpc_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">create_model_args</span><span class="p">[</span><span class="s2">&quot;VpcConfig&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vpc_config</span>

    <span class="k">return</span> <span class="n">sage_client</span><span class="o">.</span><span class="n">create_model</span><span class="p">(</span><span class="o">**</span><span class="n">create_model_args</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_delete_sagemaker_model</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">sage_client</span><span class="p">,</span> <span class="n">s3_client</span><span class="p">):</span>  <span class="c1"># noqa: D417</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        sage_client: A boto3 client for SageMaker.</span>
<span class="sd">        s3_client: A boto3 client for S3.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ARN of the deleted model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model_info</span> <span class="o">=</span> <span class="n">sage_client</span><span class="o">.</span><span class="n">describe_model</span><span class="p">(</span><span class="n">ModelName</span><span class="o">=</span><span class="n">model_name</span><span class="p">)</span>
    <span class="n">model_arn</span> <span class="o">=</span> <span class="n">model_info</span><span class="p">[</span><span class="s2">&quot;ModelArn&quot;</span><span class="p">]</span>
    <span class="n">model_data_url</span> <span class="o">=</span> <span class="n">model_info</span><span class="p">[</span><span class="s2">&quot;PrimaryContainer&quot;</span><span class="p">][</span><span class="s2">&quot;ModelDataUrl&quot;</span><span class="p">]</span>

    <span class="c1"># Parse the model data url to obtain a bucket path. The following</span>
    <span class="c1"># procedure is safe due to the well-documented structure of the `ModelDataUrl`</span>
    <span class="c1"># (see https://docs.aws.amazon.com/sagemaker/latest/dg/API_ContainerDefinition.html)</span>
    <span class="n">parsed_data_url</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">model_data_url</span><span class="p">)</span>
    <span class="n">bucket_name</span> <span class="o">=</span> <span class="n">parsed_data_url</span><span class="o">.</span><span class="n">netloc</span>
    <span class="n">bucket_key</span> <span class="o">=</span> <span class="n">parsed_data_url</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>

    <span class="n">s3_client</span><span class="o">.</span><span class="n">delete_object</span><span class="p">(</span><span class="n">Bucket</span><span class="o">=</span><span class="n">bucket_name</span><span class="p">,</span> <span class="n">Key</span><span class="o">=</span><span class="n">bucket_key</span><span class="p">)</span>
    <span class="n">sage_client</span><span class="o">.</span><span class="n">delete_model</span><span class="p">(</span><span class="n">ModelName</span><span class="o">=</span><span class="n">model_name</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">model_arn</span>


<span class="k">def</span> <span class="nf">_delete_sagemaker_endpoint_configuration</span><span class="p">(</span><span class="n">endpoint_config_name</span><span class="p">,</span> <span class="n">sage_client</span><span class="p">):</span>  <span class="c1"># noqa: D417</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        sage_client: A boto3 client for SageMaker.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ARN of the deleted endpoint configuration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">endpoint_config_info</span> <span class="o">=</span> <span class="n">sage_client</span><span class="o">.</span><span class="n">describe_endpoint_config</span><span class="p">(</span>
        <span class="n">EndpointConfigName</span><span class="o">=</span><span class="n">endpoint_config_name</span>
    <span class="p">)</span>
    <span class="n">sage_client</span><span class="o">.</span><span class="n">delete_endpoint_config</span><span class="p">(</span><span class="n">EndpointConfigName</span><span class="o">=</span><span class="n">endpoint_config_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">endpoint_config_info</span><span class="p">[</span><span class="s2">&quot;EndpointConfigArn&quot;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_find_endpoint</span><span class="p">(</span><span class="n">endpoint_name</span><span class="p">,</span> <span class="n">sage_client</span><span class="p">):</span>  <span class="c1"># noqa: D417</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finds a SageMaker endpoint with the specified name in the caller&#39;s AWS account, returning a</span>
<span class="sd">    NoneType if the endpoint is not found.</span>

<span class="sd">    Args:</span>
<span class="sd">        sage_client: A boto3 client for SageMaker.</span>

<span class="sd">    Returns:</span>
<span class="sd">        If the endpoint exists, a dictionary of endpoint attributes. If the endpoint does not</span>
<span class="sd">        exist, ``None``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">endpoints_page</span> <span class="o">=</span> <span class="n">sage_client</span><span class="o">.</span><span class="n">list_endpoints</span><span class="p">(</span><span class="n">MaxResults</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">NameContains</span><span class="o">=</span><span class="n">endpoint_name</span><span class="p">)</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">endpoint</span> <span class="ow">in</span> <span class="n">endpoints_page</span><span class="p">[</span><span class="s2">&quot;Endpoints&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">endpoint</span><span class="p">[</span><span class="s2">&quot;EndpointName&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">endpoint_name</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">endpoint</span>

        <span class="k">if</span> <span class="s2">&quot;NextToken&quot;</span> <span class="ow">in</span> <span class="n">endpoints_page</span><span class="p">:</span>
            <span class="n">endpoints_page</span> <span class="o">=</span> <span class="n">sage_client</span><span class="o">.</span><span class="n">list_endpoints</span><span class="p">(</span>
                <span class="n">MaxResults</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">NextToken</span><span class="o">=</span><span class="n">endpoints_page</span><span class="p">[</span><span class="s2">&quot;NextToken&quot;</span><span class="p">],</span> <span class="n">NameContains</span><span class="o">=</span><span class="n">endpoint_name</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_find_transform_job</span><span class="p">(</span><span class="n">job_name</span><span class="p">,</span> <span class="n">sage_client</span><span class="p">):</span>  <span class="c1"># noqa: D417</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finds a SageMaker batch transform job with the specified name in the caller&#39;s AWS account,</span>
<span class="sd">    returning a NoneType if the transform job is not found.</span>

<span class="sd">    Args:</span>
<span class="sd">        sage_client: A boto3 client for SageMaker.</span>

<span class="sd">    Returns:</span>
<span class="sd">        If the transform job exists, a dictionary of transform job attributes. If the</span>
<span class="sd">        transform job does not exist, ``None``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">transform_jobs_page</span> <span class="o">=</span> <span class="n">sage_client</span><span class="o">.</span><span class="n">list_transform_jobs</span><span class="p">(</span><span class="n">MaxResults</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">NameContains</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">transform_job</span> <span class="ow">in</span> <span class="n">transform_jobs_page</span><span class="p">[</span><span class="s2">&quot;TransformJobSummaries&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">transform_job</span><span class="p">[</span><span class="s2">&quot;TransformJobName&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">job_name</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">transform_job</span>

        <span class="k">if</span> <span class="s2">&quot;NextToken&quot;</span> <span class="ow">in</span> <span class="n">transform_jobs_page</span><span class="p">:</span>
            <span class="n">transform_jobs_page</span> <span class="o">=</span> <span class="n">sage_client</span><span class="o">.</span><span class="n">list_transform_jobs</span><span class="p">(</span>
                <span class="n">MaxResults</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                <span class="n">NextToken</span><span class="o">=</span><span class="n">transform_jobs_page</span><span class="p">[</span><span class="s2">&quot;NextToken&quot;</span><span class="p">],</span>
                <span class="n">NameContains</span><span class="o">=</span><span class="n">job_name</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_does_model_exist</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">sage_client</span><span class="p">):</span>  <span class="c1"># noqa: D417</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determines whether a SageMaker model exists with the specified name in the caller&#39;s AWS account,</span>
<span class="sd">    returning True if the model exists, returning False if the model does not exist.</span>

<span class="sd">    Args:</span>
<span class="sd">        sage_client: A boto3 client for SageMaker.</span>

<span class="sd">    Returns:</span>
<span class="sd">        If the model exists, ``True``. If the model does not</span>
<span class="sd">        exist, ``False``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">sage_client</span><span class="o">.</span><span class="n">describe_model</span><span class="p">(</span><span class="n">ModelName</span><span class="o">=</span><span class="n">model_name</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">sage_client</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;Could not find model&quot;</span> <span class="ow">in</span> <span class="n">error</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;Error&quot;</span><span class="p">][</span><span class="s2">&quot;Message&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>


<div class="viewcode-block" id="SageMakerDeploymentClient"><a class="viewcode-back" href="../../python_api/mlflow.sagemaker.html#mlflow.sagemaker.SageMakerDeploymentClient">[docs]</a><span class="k">class</span> <span class="nc">SageMakerDeploymentClient</span><span class="p">(</span><span class="n">BaseDeploymentClient</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize a deployment client for SageMaker. The default region and assumed role ARN will</span>
<span class="sd">    be set according to the value of the `target_uri`.</span>

<span class="sd">    This class is meant to supercede the other ``mlflow.sagemaker`` real-time serving API&#39;s.</span>
<span class="sd">    It is also designed to be used through the :py:mod:`mlflow.deployments` module.</span>
<span class="sd">    This means that you can deploy to SageMaker using the</span>
<span class="sd">    `mlflow deployments CLI &lt;https://www.mlflow.org/docs/latest/cli.html#mlflow-deployments&gt;`_ and</span>
<span class="sd">    get a client through the :py:mod:`mlflow.deployments.get_deploy_client` function.</span>

<span class="sd">    Args:</span>
<span class="sd">        target_uri: A URI that follows one of the following formats:</span>

<span class="sd">            - ``sagemaker``: This will set the default region to `us-west-2` and</span>
<span class="sd">              the default assumed role ARN to `None`.</span>
<span class="sd">            - ``sagemaker:/region_name``: This will set the default region to</span>
<span class="sd">              `region_name` and the default assumed role ARN to `None`.</span>
<span class="sd">            - ``sagemaker:/region_name/assumed_role_arn``: This will set the default</span>
<span class="sd">              region to `region_name` and the default assumed role ARN to</span>
<span class="sd">              `assumed_role_arn`.</span>

<span class="sd">            When an `assumed_role_arn` is provided without a `region_name`,</span>
<span class="sd">            an MlflowException will be raised.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_uri</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">target_uri</span><span class="o">=</span><span class="n">target_uri</span><span class="p">)</span>

        <span class="c1"># Default region_name and assumed_role_arn when</span>
        <span class="c1"># the target_uri is `sagemaker` or `sagemaker:/`</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region_name</span> <span class="o">=</span> <span class="n">DEFAULT_REGION_NAME</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assumed_role_arn</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_values_from_target_uri</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_values_from_target_uri</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_uri</span><span class="p">)</span>
        <span class="n">values_str</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">parsed</span><span class="o">.</span><span class="n">scheme</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">values_str</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">separator_index</span> <span class="o">=</span> <span class="n">values_str</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">separator_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1"># values_str would look like us-east-1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">region_name</span> <span class="o">=</span> <span class="n">values_str</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># values_str could look like us-east-1/arn:aws:1234:role/assumed_role</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">region_name</span> <span class="o">=</span> <span class="n">values_str</span><span class="p">[:</span><span class="n">separator_index</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assumed_role_arn</span> <span class="o">=</span> <span class="n">values_str</span><span class="p">[</span><span class="n">separator_index</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span>

            <span class="c1"># if values_str contains multiple interior slashes such as</span>
            <span class="c1"># us-east-1/////arn:aws:1234:role/assumed_role, remove</span>
            <span class="c1"># the extra slashes that come before &quot;arn&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assumed_role_arn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assumed_role_arn</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;arn&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                    <span class="s2">&quot;It looks like the target_uri contains an IAM role ARN without a region name.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;A region name must be provided when the target_uri contains a role ARN.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;In this case, the target_uri must follow the format: &quot;</span>
                    <span class="s2">&quot;sagemaker:/region_name/assumed_role_arn.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;The provided target_uri is: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">target_uri</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">),</span>
                <span class="n">error_code</span><span class="o">=</span><span class="n">INVALID_PARAMETER_VALUE</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_default_deployment_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">create_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;assume_role_arn&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">assumed_role_arn</span><span class="p">,</span>
            <span class="s2">&quot;execution_role_arn&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;bucket&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;image_url&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;region_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_name</span><span class="p">,</span>
            <span class="s2">&quot;archive&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;instance_type&quot;</span><span class="p">:</span> <span class="n">DEFAULT_SAGEMAKER_INSTANCE_TYPE</span><span class="p">,</span>
            <span class="s2">&quot;instance_count&quot;</span><span class="p">:</span> <span class="n">DEFAULT_SAGEMAKER_INSTANCE_COUNT</span><span class="p">,</span>
            <span class="s2">&quot;vpc_config&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;data_capture_config&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;synchronous&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;timeout_seconds&quot;</span><span class="p">:</span> <span class="mi">1200</span><span class="p">,</span>
            <span class="s2">&quot;variant_name&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;env&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;async_inference_config&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;serverless_config&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">create_mode</span><span class="p">:</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DEPLOYMENT_MODE_CREATE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">config</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DEPLOYMENT_MODE_REPLACE</span>

        <span class="k">return</span> <span class="n">config</span>

    <span class="k">def</span> <span class="nf">_apply_custom_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">custom_config</span><span class="p">):</span>
        <span class="n">int_fields</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;instance_count&quot;</span><span class="p">,</span> <span class="s2">&quot;timeout_seconds&quot;</span><span class="p">}</span>
        <span class="n">bool_fields</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;synchronous&quot;</span><span class="p">,</span> <span class="s2">&quot;archive&quot;</span><span class="p">}</span>
        <span class="n">dict_fields</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;vpc_config&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data_capture_config&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tags&quot;</span><span class="p">,</span>
            <span class="s2">&quot;env&quot;</span><span class="p">,</span>
            <span class="s2">&quot;async_inference_config&quot;</span><span class="p">,</span>
            <span class="s2">&quot;serverless_config&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">custom_config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">int_fields</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">bool_fields</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;True&quot;</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dict_fields</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="n">config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="SageMakerDeploymentClient.create_deployment"><a class="viewcode-back" href="../../python_api/mlflow.sagemaker.html#mlflow.sagemaker.SageMakerDeploymentClient.create_deployment">[docs]</a>    <span class="k">def</span> <span class="nf">create_deployment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">model_uri</span><span class="p">,</span> <span class="n">flavor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deploy an MLflow model on AWS SageMaker.</span>
<span class="sd">        The currently active AWS account must have correct permissions set up.</span>

<span class="sd">        This function creates a SageMaker endpoint. For more information about the input data</span>
<span class="sd">        formats accepted by this endpoint, see the</span>
<span class="sd">        :ref:`MLflow deployment tools documentation &lt;sagemaker_deployment&gt;`.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: Name of the deployed application.</span>
<span class="sd">            model_uri: The location, in URI format, of the MLflow model to deploy to SageMaker.</span>
<span class="sd">                For example:</span>

<span class="sd">                - ``/Users/me/path/to/local/model``</span>
<span class="sd">                - ``relative/path/to/local/model``</span>
<span class="sd">                - ``s3://my_bucket/path/to/model``</span>
<span class="sd">                - ``runs:/&lt;mlflow_run_id&gt;/run-relative/path/to/model``</span>
<span class="sd">                - ``models:/&lt;model_name&gt;/&lt;model_version&gt;``</span>
<span class="sd">                - ``models:/&lt;model_name&gt;/&lt;stage&gt;``</span>

<span class="sd">                For more information about supported URI schemes, see</span>
<span class="sd">                `Referencing Artifacts &lt;https://www.mlflow.org/docs/latest/concepts.html#</span>
<span class="sd">                artifact-locations&gt;`_.</span>
<span class="sd">            flavor: The name of the flavor of the model to use for deployment. Must be either</span>
<span class="sd">                ``None`` or one of mlflow.sagemaker.SUPPORTED_DEPLOYMENT_FLAVORS.</span>
<span class="sd">                If ``None``, a flavor is automatically selected from the model&#39;s available</span>
<span class="sd">                flavors. If the specified flavor is not present or not supported for</span>
<span class="sd">                deployment, an exception will be thrown.</span>
<span class="sd">            config: Configuration parameters. The supported parameters are:</span>

<span class="sd">                - ``assume_role_arn``: The name of an IAM cross-account role to be assumed</span>
<span class="sd">                  to deploy SageMaker to another AWS account. If this parameter is not</span>
<span class="sd">                  specified, the role given in the ``target_uri`` will be used. If the</span>
<span class="sd">                  role is not given in the ``target_uri``, defaults to ``us-west-2``.</span>

<span class="sd">                - ``execution_role_arn``: The name of an IAM role granting the SageMaker</span>
<span class="sd">                  service permissions to access the specified Docker image and S3 bucket</span>
<span class="sd">                  containing MLflow model artifacts. If unspecified, the currently-assumed</span>
<span class="sd">                  role will be used. This execution role is passed to the SageMaker service</span>
<span class="sd">                  when creating a SageMaker model from the specified MLflow model. It is</span>
<span class="sd">                  passed as the ``ExecutionRoleArn`` parameter of the `SageMaker</span>
<span class="sd">                  CreateModel API call &lt;https://docs.aws.amazon.com/sagemaker/latest/</span>
<span class="sd">                  dg/API_CreateModel.html&gt;`_. This role is *not* assumed for any other</span>
<span class="sd">                  call. For more information about SageMaker execution roles for model</span>
<span class="sd">                  creation, see</span>
<span class="sd">                  https://docs.aws.amazon.com/sagemaker/latest/dg/sagemaker-roles.html.</span>

<span class="sd">                - ``bucket``: S3 bucket where model artifacts will be stored. Defaults to a</span>
<span class="sd">                  SageMaker-compatible bucket name.</span>

<span class="sd">                - ``image_url``: URL of the ECR-hosted Docker image the model should be</span>
<span class="sd">                  deployed into, produced by ``mlflow sagemaker build-and-push-container``.</span>
<span class="sd">                  This parameter can also be specified by the environment variable</span>
<span class="sd">                  ``MLFLOW_SAGEMAKER_DEPLOY_IMG_URL``.</span>

<span class="sd">                - ``region_name``: Name of the AWS region to which to deploy the application.</span>
<span class="sd">                  If unspecified, use the region name given in the ``target_uri``.</span>
<span class="sd">                  If it is also not specified in the ``target_uri``,</span>
<span class="sd">                  defaults to ``us-west-2``.</span>

<span class="sd">                - ``archive``: If ``True``, any pre-existing SageMaker application resources</span>
<span class="sd">                  that become inactive (i.e. as a result of deploying in</span>
<span class="sd">                  ``mlflow.sagemaker.DEPLOYMENT_MODE_REPLACE`` mode) are preserved.</span>
<span class="sd">                  These resources may include unused SageMaker models and endpoint</span>
<span class="sd">                  configurations that were associated with a prior version of the</span>
<span class="sd">                  application endpoint. If ``False``, these resources are deleted.</span>
<span class="sd">                  In order to use ``archive=False``, ``create_deployment()`` must be executed</span>
<span class="sd">                  synchronously with ``synchronous=True``. Defaults to ``False``.</span>

<span class="sd">                - ``instance_type``: The type of SageMaker ML instance on which to deploy the</span>
<span class="sd">                  model. For a list of supported instance types, see</span>
<span class="sd">                  https://aws.amazon.com/sagemaker/pricing/instance-types/.</span>
<span class="sd">                  Defaults to ``ml.m4.xlarge``.</span>

<span class="sd">                - ``instance_count``: The number of SageMaker ML instances on which to deploy</span>
<span class="sd">                  the model. Defaults to ``1``.</span>

<span class="sd">                - ``synchronous``: If ``True``, this function will block until the deployment</span>
<span class="sd">                  process succeeds or encounters an irrecoverable failure. If ``False``,</span>
<span class="sd">                  this function will return immediately after starting the deployment</span>
<span class="sd">                  process. It will not wait for the deployment process to complete;</span>
<span class="sd">                  in this case, the caller is responsible for monitoring the health and</span>
<span class="sd">                  status of the pending deployment via native SageMaker APIs or the AWS</span>
<span class="sd">                  console. Defaults to ``True``.</span>

<span class="sd">                - ``timeout_seconds``: If ``synchronous`` is ``True``, the deployment process</span>
<span class="sd">                  will return after the specified number of seconds if no definitive result</span>
<span class="sd">                  (success or failure) is achieved. Once the function returns, the caller is</span>
<span class="sd">                  responsible for monitoring the health and status of the pending</span>
<span class="sd">                  deployment using native SageMaker APIs or the AWS console. If</span>
<span class="sd">                  ``synchronous`` is ``False``, this parameter is ignored.</span>
<span class="sd">                  Defaults to ``300``.</span>

<span class="sd">                - ``vpc_config``: A dictionary specifying the VPC configuration to use when</span>
<span class="sd">                  creating the new SageMaker model associated with this application.</span>
<span class="sd">                  The acceptable values for this parameter are identical to those of the</span>
<span class="sd">                  ``VpcConfig`` parameter in the `SageMaker boto3 client&#39;s create_model</span>
<span class="sd">                  method &lt;https://boto3.readthedocs.io/en/latest/reference/services/sagemaker.html</span>
<span class="sd">                  #SageMaker.Client.create_model&gt;`_. For more information, see</span>
<span class="sd">                  https://docs.aws.amazon.com/sagemaker/latest/dg/API_VpcConfig.html.</span>
<span class="sd">                  Defaults to ``None``.</span>

<span class="sd">                - ``data_capture_config``: A dictionary specifying the data capture</span>
<span class="sd">                  configuration to use when creating the new SageMaker model associated with</span>
<span class="sd">                  this application.</span>
<span class="sd">                  For more information, see</span>
<span class="sd">                  https://docs.aws.amazon.com/sagemaker/latest/APIReference/API_DataCaptureConfig.html.</span>
<span class="sd">                  Defaults to ``None``.</span>

<span class="sd">                - ``variant_name``: A string specifying the desired name when creating a production</span>
<span class="sd">                  variant.  Defaults to ``None``.</span>

<span class="sd">                - ``async_inference_config``: A dictionary specifying the</span>
<span class="sd">                  async_inference_configuration</span>

<span class="sd">                - ``serverless_config``: A dictionary specifying the serverless_configuration</span>

<span class="sd">                - ``env``: A dictionary specifying environment variables as key-value</span>
<span class="sd">                  pairs to be set for the deployed model. Defaults to ``None``.</span>

<span class="sd">                - ``tags``: A dictionary of key-value pairs representing additional</span>
<span class="sd">                  tags to be set for the deployed model. Defaults to ``None``.</span>

<span class="sd">            endpoint: (optional) Endpoint to create the deployment under. Currently unsupported</span>

<span class="sd">        .. code-block:: python</span>
<span class="sd">            :caption: Python example</span>

<span class="sd">            from mlflow.deployments import get_deploy_client</span>

<span class="sd">            vpc_config = {</span>
<span class="sd">                &quot;SecurityGroupIds&quot;: [</span>
<span class="sd">                    &quot;sg-123456abc&quot;,</span>
<span class="sd">                ],</span>
<span class="sd">                &quot;Subnets&quot;: [</span>
<span class="sd">                    &quot;subnet-123456abc&quot;,</span>
<span class="sd">                ],</span>
<span class="sd">            }</span>
<span class="sd">            config = dict(</span>
<span class="sd">                assume_role_arn=&quot;arn:aws:123:role/assumed_role&quot;,</span>
<span class="sd">                execution_role_arn=&quot;arn:aws:456:role/execution_role&quot;,</span>
<span class="sd">                bucket_name=&quot;my-s3-bucket&quot;,</span>
<span class="sd">                image_url=&quot;1234.dkr.ecr.us-east-1.amazonaws.com/mlflow-test:1.23.1&quot;,</span>
<span class="sd">                region_name=&quot;us-east-1&quot;,</span>
<span class="sd">                archive=False,</span>
<span class="sd">                instance_type=&quot;ml.m5.4xlarge&quot;,</span>
<span class="sd">                instance_count=1,</span>
<span class="sd">                synchronous=True,</span>
<span class="sd">                timeout_seconds=300,</span>
<span class="sd">                vpc_config=vpc_config,</span>
<span class="sd">                variant_name=&quot;prod-variant-1&quot;,</span>
<span class="sd">                env={&quot;DISABLE_NGINX&quot;: &quot;true&quot;, &quot;GUNICORN_CMD_ARGS&quot;: &#39;&quot;--timeout 60&quot;&#39;},</span>
<span class="sd">                tags={&quot;training_timestamp&quot;: &quot;2022-11-01T05:12:26&quot;},</span>
<span class="sd">            )</span>
<span class="sd">            client = get_deploy_client(&quot;sagemaker&quot;)</span>
<span class="sd">            client.create_deployment(</span>
<span class="sd">                &quot;my-deployment&quot;,</span>
<span class="sd">                model_uri=&quot;/mlruns/0/abc/model&quot;,</span>
<span class="sd">                flavor=&quot;python_function&quot;,</span>
<span class="sd">                config=config,</span>
<span class="sd">            )</span>
<span class="sd">        .. code-block:: bash</span>
<span class="sd">            :caption:  Command-line example</span>

<span class="sd">            mlflow deployments create --target sagemaker:/us-east-1/arn:aws:123:role/assumed_role \\</span>
<span class="sd">                    --name my-deployment \\</span>
<span class="sd">                    --model-uri /mlruns/0/abc/model \\</span>
<span class="sd">                    --flavor python_function\\</span>
<span class="sd">                    -C execution_role_arn=arn:aws:456:role/execution_role \\</span>
<span class="sd">                    -C bucket_name=my-s3-bucket \\</span>
<span class="sd">                    -C image_url=1234.dkr.ecr.us-east-1.amazonaws.com/mlflow-test:1.23.1 \\</span>
<span class="sd">                    -C region_name=us-east-1 \\</span>
<span class="sd">                    -C archive=False \\</span>
<span class="sd">                    -C instance_type=ml.m5.4xlarge \\</span>
<span class="sd">                    -C instance_count=1 \\</span>
<span class="sd">                    -C synchronous=True \\</span>
<span class="sd">                    -C timeout_seconds=300 \\</span>
<span class="sd">                    -C variant_name=prod-variant-1 \\</span>
<span class="sd">                    -C vpc_config=&#39;{&quot;SecurityGroupIds&quot;: [&quot;sg-123456abc&quot;], \\</span>
<span class="sd">                    &quot;Subnets&quot;: [&quot;subnet-123456abc&quot;]}&#39; \\</span>
<span class="sd">                    -C data_capture_config=&#39;{&quot;EnableCapture&quot;: True, \\</span>
<span class="sd">                    &#39;InitalSamplingPercentage&#39;: 100, &#39;DestinationS3Uri&quot;: &#39;s3://my-bucket/path&#39;, \\</span>
<span class="sd">                    &#39;CaptureOptions&#39;: [{&#39;CaptureMode&#39;: &#39;Output&#39;}]}&#39;</span>
<span class="sd">                    -C env=&#39;{&quot;DISABLE_NGINX&quot;: &quot;true&quot;, &quot;GUNICORN_CMD_ARGS&quot;: &quot;\&quot;--timeout 60\&quot;&quot;}&#39; \\</span>
<span class="sd">                    -C tags=&#39;{&quot;training_timestamp&quot;: &quot;2022-11-01T05:12:26&quot;}&#39; \\</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">final_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_deployment_config</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_apply_custom_config</span><span class="p">(</span><span class="n">final_config</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

        <span class="n">app_name</span><span class="p">,</span> <span class="n">flavor</span> <span class="o">=</span> <span class="n">_deploy</span><span class="p">(</span>
            <span class="n">app_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">model_uri</span><span class="o">=</span><span class="n">model_uri</span><span class="p">,</span>
            <span class="n">flavor</span><span class="o">=</span><span class="n">flavor</span><span class="p">,</span>
            <span class="n">execution_role_arn</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;execution_role_arn&quot;</span><span class="p">],</span>
            <span class="n">assume_role_arn</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;assume_role_arn&quot;</span><span class="p">],</span>
            <span class="n">bucket</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;bucket&quot;</span><span class="p">],</span>
            <span class="n">image_url</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;image_url&quot;</span><span class="p">],</span>
            <span class="n">region_name</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;region_name&quot;</span><span class="p">],</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">mlflow</span><span class="o">.</span><span class="n">sagemaker</span><span class="o">.</span><span class="n">DEPLOYMENT_MODE_CREATE</span><span class="p">,</span>
            <span class="n">archive</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;archive&quot;</span><span class="p">],</span>
            <span class="n">instance_type</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;instance_type&quot;</span><span class="p">],</span>
            <span class="n">instance_count</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;instance_count&quot;</span><span class="p">],</span>
            <span class="n">vpc_config</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;vpc_config&quot;</span><span class="p">],</span>
            <span class="n">data_capture_config</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;data_capture_config&quot;</span><span class="p">],</span>
            <span class="n">synchronous</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;synchronous&quot;</span><span class="p">],</span>
            <span class="n">timeout_seconds</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;timeout_seconds&quot;</span><span class="p">],</span>
            <span class="n">variant_name</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;variant_name&quot;</span><span class="p">],</span>
            <span class="n">async_inference_config</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;async_inference_config&quot;</span><span class="p">],</span>
            <span class="n">serverless_config</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;serverless_config&quot;</span><span class="p">],</span>
            <span class="n">env</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;env&quot;</span><span class="p">],</span>
            <span class="n">tags</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">app_name</span><span class="p">,</span> <span class="s2">&quot;flavor&quot;</span><span class="p">:</span> <span class="n">flavor</span><span class="p">}</span></div>

<div class="viewcode-block" id="SageMakerDeploymentClient.update_deployment"><a class="viewcode-back" href="../../python_api/mlflow.sagemaker.html#mlflow.sagemaker.SageMakerDeploymentClient.update_deployment">[docs]</a>    <span class="k">def</span> <span class="nf">update_deployment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">model_uri</span><span class="p">,</span> <span class="n">flavor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update a deployment on AWS SageMaker. This function can replace or add a new model to</span>
<span class="sd">        an existing SageMaker endpoint. By default, this function replaces the existing model</span>
<span class="sd">        with the new one. The currently active AWS account must have correct permissions set up.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: Name of the deployed application.</span>
<span class="sd">            model_uri: The location, in URI format, of the MLflow model to deploy to SageMaker.</span>
<span class="sd">                For example:</span>

<span class="sd">                - ``/Users/me/path/to/local/model``</span>
<span class="sd">                - ``relative/path/to/local/model``</span>
<span class="sd">                - ``s3://my_bucket/path/to/model``</span>
<span class="sd">                - ``runs:/&lt;mlflow_run_id&gt;/run-relative/path/to/model``</span>
<span class="sd">                - ``models:/&lt;model_name&gt;/&lt;model_version&gt;``</span>
<span class="sd">                - ``models:/&lt;model_name&gt;/&lt;stage&gt;``</span>

<span class="sd">                For more information about supported URI schemes, see</span>
<span class="sd">                `Referencing Artifacts &lt;https://www.mlflow.org/docs/latest/concepts.html#</span>
<span class="sd">                artifact-locations&gt;`_.</span>

<span class="sd">            flavor: The name of the flavor of the model to use for deployment. Must be either</span>
<span class="sd">                ``None`` or one of mlflow.sagemaker.SUPPORTED_DEPLOYMENT_FLAVORS.</span>
<span class="sd">                If ``None``, a flavor is automatically selected from the model&#39;s available</span>
<span class="sd">                flavors. If the specified flavor is not present or not supported for</span>
<span class="sd">                deployment, an exception will be thrown.</span>

<span class="sd">            config: Configuration parameters. The supported parameters are:</span>

<span class="sd">                - ``assume_role_arn``: The name of an IAM cross-account role to be assumed</span>
<span class="sd">                  to deploy SageMaker to another AWS account. If this parameter is not</span>
<span class="sd">                  specified, the role given in the ``target_uri`` will be used. If the</span>
<span class="sd">                  role is not given in the ``target_uri``, defaults to ``us-west-2``.</span>

<span class="sd">                - ``execution_role_arn``: The name of an IAM role granting the SageMaker</span>
<span class="sd">                  service permissions to access the specified Docker image and S3 bucket</span>
<span class="sd">                  containing MLflow model artifacts. If unspecified, the currently-assumed</span>
<span class="sd">                  role will be used. This execution role is passed to the SageMaker service</span>
<span class="sd">                  when creating a SageMaker model from the specified MLflow model. It is</span>
<span class="sd">                  passed as the ``ExecutionRoleArn`` parameter of the `SageMaker</span>
<span class="sd">                  CreateModel API call &lt;https://docs.aws.amazon.com/sagemaker/latest/</span>
<span class="sd">                  dg/API_CreateModel.html&gt;`_. This role is *not* assumed for any other</span>
<span class="sd">                  call. For more information about SageMaker execution roles for model</span>
<span class="sd">                  creation, see</span>
<span class="sd">                  https://docs.aws.amazon.com/sagemaker/latest/dg/sagemaker-roles.html.</span>

<span class="sd">                - ``bucket``: S3 bucket where model artifacts will be stored. Defaults to a</span>
<span class="sd">                  SageMaker-compatible bucket name.</span>

<span class="sd">                - ``image_url``: URL of the ECR-hosted Docker image the model should be</span>
<span class="sd">                  deployed into, produced by ``mlflow sagemaker build-and-push-container``.</span>
<span class="sd">                  This parameter can also be specified by the environment variable</span>
<span class="sd">                  ``MLFLOW_SAGEMAKER_DEPLOY_IMG_URL``.</span>

<span class="sd">                - ``region_name``: Name of the AWS region to which to deploy the application.</span>
<span class="sd">                  If unspecified, use the region name given in the ``target_uri``.</span>
<span class="sd">                  If it is also not specified in the ``target_uri``,</span>
<span class="sd">                  defaults to ``us-west-2``.</span>

<span class="sd">                - ``mode``: The mode in which to deploy the application.</span>
<span class="sd">                  Must be one of the following:</span>

<span class="sd">                  ``mlflow.sagemaker.DEPLOYMENT_MODE_REPLACE``</span>
<span class="sd">                      If an application of the specified name exists, its model(s) is</span>
<span class="sd">                      replaced with the specified model. If no such application exists,</span>
<span class="sd">                      it is created with the specified name and model.</span>
<span class="sd">                      This is the default mode.</span>

<span class="sd">                  ``mlflow.sagemaker.DEPLOYMENT_MODE_ADD``</span>
<span class="sd">                      Add the specified model to a pre-existing application with the</span>
<span class="sd">                      specified name, if one exists. If the application does not exist,</span>
<span class="sd">                      a new application is created with the specified name and model.</span>
<span class="sd">                      NOTE: If the application **already exists**, the specified model is</span>
<span class="sd">                      added to the application&#39;s corresponding SageMaker endpoint with an</span>
<span class="sd">                      initial weight of zero (0). To route traffic to the model,</span>
<span class="sd">                      update the application&#39;s associated endpoint configuration using</span>
<span class="sd">                      either the AWS console or the ``UpdateEndpointWeightsAndCapacities``</span>
<span class="sd">                      function defined in https://docs.aws.amazon.com/sagemaker/latest/dg/API_UpdateEndpointWeightsAndCapacities.html.</span>

<span class="sd">                - ``archive``: If ``True``, any pre-existing SageMaker application resources</span>
<span class="sd">                  that become inactive (i.e. as a result of deploying in</span>
<span class="sd">                  ``mlflow.sagemaker.DEPLOYMENT_MODE_REPLACE`` mode) are preserved.</span>
<span class="sd">                  These resources may include unused SageMaker models and endpoint</span>
<span class="sd">                  configurations that were associated with a prior version of the</span>
<span class="sd">                  application endpoint. If ``False``, these resources are deleted.</span>
<span class="sd">                  In order to use ``archive=False``, ``update_deployment()`` must be executed</span>
<span class="sd">                  synchronously with ``synchronous=True``. Defaults to ``False``.</span>

<span class="sd">                - ``instance_type``: The type of SageMaker ML instance on which to deploy the</span>
<span class="sd">                  model. For a list of supported instance types, see</span>
<span class="sd">                  https://aws.amazon.com/sagemaker/pricing/instance-types/.</span>
<span class="sd">                  Defaults to ``ml.m4.xlarge``.</span>

<span class="sd">                - ``instance_count``: The number of SageMaker ML instances on which to deploy</span>
<span class="sd">                  the model. Defaults to ``1``.</span>

<span class="sd">                - ``synchronous``: If ``True``, this function will block until the deployment</span>
<span class="sd">                  process succeeds or encounters an irrecoverable failure. If ``False``,</span>
<span class="sd">                  this function will return immediately after starting the deployment</span>
<span class="sd">                  process. It will not wait for the deployment process to complete;</span>
<span class="sd">                  in this case, the caller is responsible for monitoring the health and</span>
<span class="sd">                  status of the pending deployment via native SageMaker APIs or the AWS</span>
<span class="sd">                  console. Defaults to ``True``.</span>

<span class="sd">                - ``timeout_seconds``: If ``synchronous`` is ``True``, the deployment process</span>
<span class="sd">                  will return after the specified number of seconds if no definitive result</span>
<span class="sd">                  (success or failure) is achieved. Once the function returns, the caller is</span>
<span class="sd">                  responsible for monitoring the health and status of the pending</span>
<span class="sd">                  deployment using native SageMaker APIs or the AWS console. If</span>
<span class="sd">                  ``synchronous`` is ``False``, this parameter is ignored.</span>
<span class="sd">                  Defaults to ``300``.</span>

<span class="sd">                - ``variant_name``: A string specifying the desired name when creating a</span>
<span class="sd">                  production variant.  Defaults to ``None``.</span>

<span class="sd">                - ``vpc_config``: A dictionary specifying the VPC configuration to use when</span>
<span class="sd">                  creating the new SageMaker model associated with this application.</span>
<span class="sd">                  The acceptable values for this parameter are identical to those of the</span>
<span class="sd">                  ``VpcConfig`` parameter in the `SageMaker boto3 client&#39;s create_model</span>
<span class="sd">                  method &lt;https://boto3.readthedocs.io/en/latest/reference/services/sagemaker.html</span>
<span class="sd">                  #SageMaker.Client.create_model&gt;`_. For more information, see</span>
<span class="sd">                  https://docs.aws.amazon.com/sagemaker/latest/dg/API_VpcConfig.html.</span>
<span class="sd">                  Defaults to ``None``.</span>

<span class="sd">                - ``data_capture_config``: A dictionary specifying the data capture</span>
<span class="sd">                  configuration to use when creating the new SageMaker model associated with</span>
<span class="sd">                  this application.</span>
<span class="sd">                  For more information, see</span>
<span class="sd">                  https://docs.aws.amazon.com/sagemaker/latest/APIReference/API_DataCaptureConfig.html.</span>
<span class="sd">                  Defaults to ``None``.</span>

<span class="sd">                - ``async_inference_config``: A dictionary specifying the async config</span>
<span class="sd">                  configuration. Defaults to ``None``.</span>

<span class="sd">                - ``env``: A dictionary specifying environment variables as key-value pairs</span>
<span class="sd">                  to be set for the deployed model. Defaults to ``None``.</span>

<span class="sd">                - ``tags``: A dictionary of key-value pairs representing additional tags</span>
<span class="sd">                  to be set for the deployed model. Defaults to ``None``.</span>

<span class="sd">            endpoint: (optional) Endpoint containing the deployment to update. Currently unsupported</span>

<span class="sd">        .. code-block:: python</span>
<span class="sd">            :caption: Python example</span>

<span class="sd">            from mlflow.deployments import get_deploy_client</span>

<span class="sd">            vpc_config = {</span>
<span class="sd">                &quot;SecurityGroupIds&quot;: [</span>
<span class="sd">                    &quot;sg-123456abc&quot;,</span>
<span class="sd">                ],</span>
<span class="sd">                &quot;Subnets&quot;: [</span>
<span class="sd">                    &quot;subnet-123456abc&quot;,</span>
<span class="sd">                ],</span>
<span class="sd">            }</span>
<span class="sd">            data_capture_config = {</span>
<span class="sd">                &quot;EnableCapture&quot;: True,</span>
<span class="sd">                &quot;InitalSamplingPercentage&quot;: 100,</span>
<span class="sd">                &quot;DestinationS3Uri&quot;: &quot;s3://my-bucket/path&quot;,</span>
<span class="sd">                &quot;CaptureOptions&quot;: [{&quot;CaptureMode&quot;: &quot;Output&quot;}],</span>
<span class="sd">            }</span>
<span class="sd">            config = dict(</span>
<span class="sd">                assume_role_arn=&quot;arn:aws:123:role/assumed_role&quot;,</span>
<span class="sd">                execution_role_arn=&quot;arn:aws:456:role/execution_role&quot;,</span>
<span class="sd">                bucket_name=&quot;my-s3-bucket&quot;,</span>
<span class="sd">                image_url=&quot;1234.dkr.ecr.us-east-1.amazonaws.com/mlflow-test:1.23.1&quot;,</span>
<span class="sd">                region_name=&quot;us-east-1&quot;,</span>
<span class="sd">                mode=&quot;replace&quot;,</span>
<span class="sd">                archive=False,</span>
<span class="sd">                instance_type=&quot;ml.m5.4xlarge&quot;,</span>
<span class="sd">                instance_count=1,</span>
<span class="sd">                synchronous=True,</span>
<span class="sd">                timeout_seconds=300,</span>
<span class="sd">                variant_name=&quot;prod-variant-1&quot;,</span>
<span class="sd">                vpc_config=vpc_config,</span>
<span class="sd">                data_capture_config=data_capture_config,</span>
<span class="sd">                env={&quot;DISABLE_NGINX&quot;: &quot;true&quot;, &quot;GUNICORN_CMD_ARGS&quot;: &#39;&quot;--timeout 60&quot;&#39;},</span>
<span class="sd">                tags={&quot;training_timestamp&quot;: &quot;2022-11-01T05:12:26&quot;},</span>
<span class="sd">            )</span>
<span class="sd">            client = get_deploy_client(&quot;sagemaker&quot;)</span>
<span class="sd">            client.update_deployment(</span>
<span class="sd">                &quot;my-deployment&quot;,</span>
<span class="sd">                model_uri=&quot;/mlruns/0/abc/model&quot;,</span>
<span class="sd">                flavor=&quot;python_function&quot;,</span>
<span class="sd">                config=config,</span>
<span class="sd">            )</span>
<span class="sd">        .. code-block:: bash</span>
<span class="sd">            :caption:  Command-line example</span>

<span class="sd">            mlflow deployments update --target sagemaker:/us-east-1/arn:aws:123:role/assumed_role \\</span>
<span class="sd">                    --name my-deployment \\</span>
<span class="sd">                    --model-uri /mlruns/0/abc/model \\</span>
<span class="sd">                    --flavor python_function\\</span>
<span class="sd">                    -C execution_role_arn=arn:aws:456:role/execution_role \\</span>
<span class="sd">                    -C bucket_name=my-s3-bucket \\</span>
<span class="sd">                    -C image_url=1234.dkr.ecr.us-east-1.amazonaws.com/mlflow-test:1.23.1 \\</span>
<span class="sd">                    -C region_name=us-east-1 \\</span>
<span class="sd">                    -C mode=replace \\</span>
<span class="sd">                    -C archive=False \\</span>
<span class="sd">                    -C instance_type=ml.m5.4xlarge \\</span>
<span class="sd">                    -C instance_count=1 \\</span>
<span class="sd">                    -C synchronous=True \\</span>
<span class="sd">                    -C timeout_seconds=300 \\</span>
<span class="sd">                    -C variant_name=prod-variant-1 \\</span>
<span class="sd">                    -C vpc_config=&#39;{&quot;SecurityGroupIds&quot;: [&quot;sg-123456abc&quot;], \\</span>
<span class="sd">                    &quot;Subnets&quot;: [&quot;subnet-123456abc&quot;]}&#39; \\</span>
<span class="sd">                    -C data_capture_config=&#39;{&quot;EnableCapture&quot;: True, \\</span>
<span class="sd">                    &quot;InitalSamplingPercentage&quot;: 100, &quot;DestinationS3Uri&quot;: &quot;s3://my-bucket/path&quot;, \\</span>
<span class="sd">                    &quot;CaptureOptions&quot;: [{&quot;CaptureMode&quot;: &quot;Output&quot;}]}&#39;</span>
<span class="sd">                    -C env=&#39;{&quot;DISABLE_NGINX&quot;: &quot;true&quot;, &quot;GUNICORN_CMD_ARGS&quot;: &quot;\&quot;--timeout 60\&quot;&quot;}&#39; \\</span>
<span class="sd">                    -C tags=&#39;{&quot;training_timestamp&quot;: &quot;2022-11-01T05:12:26&quot;}&#39; \\</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">final_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_deployment_config</span><span class="p">(</span><span class="n">create_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_apply_custom_config</span><span class="p">(</span><span class="n">final_config</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">model_uri</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;A model_uri must be provided when updating a SageMaker deployment&quot;</span><span class="p">,</span>
                <span class="n">error_code</span><span class="o">=</span><span class="n">INVALID_PARAMETER_VALUE</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">DEPLOYMENT_MODE_ADD</span><span class="p">,</span> <span class="n">DEPLOYMENT_MODE_REPLACE</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Invalid mode `</span><span class="si">{</span><span class="n">final_config</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">` for deployment&quot;</span>
                    <span class="s2">&quot; to a pre-existing application&quot;</span>
                <span class="p">),</span>
                <span class="n">error_code</span><span class="o">=</span><span class="n">INVALID_PARAMETER_VALUE</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">app_name</span><span class="p">,</span> <span class="n">flavor</span> <span class="o">=</span> <span class="n">_deploy</span><span class="p">(</span>
            <span class="n">app_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">model_uri</span><span class="o">=</span><span class="n">model_uri</span><span class="p">,</span>
            <span class="n">flavor</span><span class="o">=</span><span class="n">flavor</span><span class="p">,</span>
            <span class="n">execution_role_arn</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;execution_role_arn&quot;</span><span class="p">],</span>
            <span class="n">assume_role_arn</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;assume_role_arn&quot;</span><span class="p">],</span>
            <span class="n">bucket</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;bucket&quot;</span><span class="p">],</span>
            <span class="n">image_url</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;image_url&quot;</span><span class="p">],</span>
            <span class="n">region_name</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;region_name&quot;</span><span class="p">],</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">],</span>
            <span class="n">archive</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;archive&quot;</span><span class="p">],</span>
            <span class="n">instance_type</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;instance_type&quot;</span><span class="p">],</span>
            <span class="n">instance_count</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;instance_count&quot;</span><span class="p">],</span>
            <span class="n">vpc_config</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;vpc_config&quot;</span><span class="p">],</span>
            <span class="n">data_capture_config</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;data_capture_config&quot;</span><span class="p">],</span>
            <span class="n">synchronous</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;synchronous&quot;</span><span class="p">],</span>
            <span class="n">timeout_seconds</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;timeout_seconds&quot;</span><span class="p">],</span>
            <span class="n">variant_name</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;variant_name&quot;</span><span class="p">],</span>
            <span class="n">async_inference_config</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;async_inference_config&quot;</span><span class="p">],</span>
            <span class="n">serverless_config</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;serverless_config&quot;</span><span class="p">],</span>
            <span class="n">env</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;env&quot;</span><span class="p">],</span>
            <span class="n">tags</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;tags&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">app_name</span><span class="p">,</span> <span class="s2">&quot;flavor&quot;</span><span class="p">:</span> <span class="n">flavor</span><span class="p">}</span></div>

<div class="viewcode-block" id="SageMakerDeploymentClient.delete_deployment"><a class="viewcode-back" href="../../python_api/mlflow.sagemaker.html#mlflow.sagemaker.SageMakerDeploymentClient.delete_deployment">[docs]</a>    <span class="k">def</span> <span class="nf">delete_deployment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete a SageMaker application.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: Name of the deployed application.</span>
<span class="sd">            config: Configuration parameters. The supported parameters are:</span>

<span class="sd">                - ``assume_role_arn``: The name of an IAM role to be assumed to delete</span>
<span class="sd">                  the SageMaker deployment.</span>

<span class="sd">                - ``region_name``: Name of the AWS region in which the application</span>
<span class="sd">                  is deployed. Defaults to ``us-west-2`` or the region provided in</span>
<span class="sd">                  the `target_uri`.</span>

<span class="sd">                - ``archive``: If `True`, resources associated with the specified</span>
<span class="sd">                  application, such as its associated models and endpoint configuration,</span>
<span class="sd">                  are preserved. If `False`, these resources are deleted. In order to use</span>
<span class="sd">                  ``archive=False``, ``delete()`` must be executed synchronously with</span>
<span class="sd">                  ``synchronous=True``. Defaults to ``False``.</span>

<span class="sd">                - ``synchronous``: If `True`, this function blocks until the deletion process</span>
<span class="sd">                  succeeds or encounters an irrecoverable failure. If `False`, this function</span>
<span class="sd">                  returns immediately after starting the deletion process. It will not wait</span>
<span class="sd">                  for the deletion process to complete; in this case, the caller is</span>
<span class="sd">                  responsible for monitoring the status of the deletion process via native</span>
<span class="sd">                  SageMaker APIs or the AWS console. Defaults to ``True``.</span>

<span class="sd">                - ``timeout_seconds``: If `synchronous` is `True`, the deletion process</span>
<span class="sd">                  returns after the specified number of seconds if no definitive result</span>
<span class="sd">                  (success or failure) is achieved. Once the function returns, the caller</span>
<span class="sd">                  is responsible for monitoring the status of the deletion process via native</span>
<span class="sd">                  SageMaker APIs or the AWS console. If `synchronous` is False, this</span>
<span class="sd">                  parameter is ignored. Defaults to ``300``.</span>

<span class="sd">            endpoint: (optional) Endpoint containing the deployment to delete. Currently unsupported</span>

<span class="sd">        .. code-block:: python</span>
<span class="sd">            :caption: Python example</span>

<span class="sd">            from mlflow.deployments import get_deploy_client</span>

<span class="sd">            config = dict(</span>
<span class="sd">                assume_role_arn=&quot;arn:aws:123:role/assumed_role&quot;,</span>
<span class="sd">                region_name=&quot;us-east-1&quot;,</span>
<span class="sd">                archive=False,</span>
<span class="sd">                synchronous=True,</span>
<span class="sd">                timeout_seconds=300,</span>
<span class="sd">            )</span>
<span class="sd">            client = get_deploy_client(&quot;sagemaker&quot;)</span>
<span class="sd">            client.delete_deployment(&quot;my-deployment&quot;, config=config)</span>

<span class="sd">        .. code-block:: bash</span>
<span class="sd">            :caption: Command-line example</span>

<span class="sd">            mlflow deployments delete --target sagemaker \\</span>
<span class="sd">                    --name my-deployment \\</span>
<span class="sd">                    -C assume_role_arn=arn:aws:123:role/assumed_role \\</span>
<span class="sd">                    -C region_name=us-east-1 \\</span>
<span class="sd">                    -C archive=False \\</span>
<span class="sd">                    -C synchronous=True \\</span>
<span class="sd">                    -C timeout_seconds=300</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">final_config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;region_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_name</span><span class="p">,</span>
            <span class="s2">&quot;archive&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;synchronous&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;timeout_seconds&quot;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
            <span class="s2">&quot;assume_role_arn&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">assumed_role_arn</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">config</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_apply_custom_config</span><span class="p">(</span><span class="n">final_config</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

        <span class="n">_delete</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">region_name</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;region_name&quot;</span><span class="p">],</span>
            <span class="n">assume_role_arn</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;assume_role_arn&quot;</span><span class="p">],</span>
            <span class="n">archive</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;archive&quot;</span><span class="p">],</span>
            <span class="n">synchronous</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;synchronous&quot;</span><span class="p">],</span>
            <span class="n">timeout_seconds</span><span class="o">=</span><span class="n">final_config</span><span class="p">[</span><span class="s2">&quot;timeout_seconds&quot;</span><span class="p">],</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="SageMakerDeploymentClient.list_deployments"><a class="viewcode-back" href="../../python_api/mlflow.sagemaker.html#mlflow.sagemaker.SageMakerDeploymentClient.list_deployments">[docs]</a>    <span class="k">def</span> <span class="nf">list_deployments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List deployments. This method returns a list of dictionaries that describes each deployment.</span>

<span class="sd">        If a region name needs to be specified, the plugin must be initialized</span>
<span class="sd">        with the AWS region in the ``target_uri`` such as ``sagemaker:/us-east-1``.</span>

<span class="sd">        To assume an IAM role, the plugin must be initialized</span>
<span class="sd">        with the AWS region and the role ARN in the ``target_uri`` such as</span>
<span class="sd">        ``sagemaker:/us-east-1/arn:aws:1234:role/assumed_role``.</span>

<span class="sd">        Args:</span>
<span class="sd">            endpoint: (optional) List deployments in the specified endpoint. Currently unsupported</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list of dictionaries corresponding to deployments.</span>

<span class="sd">        .. code-block:: python</span>
<span class="sd">            :caption: Python example</span>

<span class="sd">            from mlflow.deployments import get_deploy_client</span>

<span class="sd">            client = get_deploy_client(&quot;sagemaker:/us-east-1/arn:aws:123:role/assumed_role&quot;)</span>
<span class="sd">            client.list_deployments()</span>

<span class="sd">        .. code-block:: bash</span>
<span class="sd">            :caption: Command-line example</span>

<span class="sd">            mlflow deployments list --target sagemaker:/us-east-1/arn:aws:1234:role/assumed_role</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">boto3</span>

        <span class="n">assume_role_credentials</span> <span class="o">=</span> <span class="n">_assume_role_and_get_credentials</span><span class="p">(</span>
            <span class="n">assume_role_arn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assumed_role_arn</span>
        <span class="p">)</span>

        <span class="n">sage_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span>
            <span class="s2">&quot;sagemaker&quot;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">region_name</span><span class="p">,</span> <span class="o">**</span><span class="n">assume_role_credentials</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">sage_client</span><span class="o">.</span><span class="n">list_endpoints</span><span class="p">()[</span><span class="s2">&quot;Endpoints&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="SageMakerDeploymentClient.get_deployment"><a class="viewcode-back" href="../../python_api/mlflow.sagemaker.html#mlflow.sagemaker.SageMakerDeploymentClient.get_deployment">[docs]</a>    <span class="k">def</span> <span class="nf">get_deployment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a dictionary describing the specified deployment.</span>

<span class="sd">        If a region name needs to be specified, the plugin must be initialized</span>
<span class="sd">        with the AWS region in the ``target_uri`` such as ``sagemaker:/us-east-1``.</span>

<span class="sd">        To assume an IAM role, the plugin must be initialized</span>
<span class="sd">        with the AWS region and the role ARN in the ``target_uri`` such as</span>
<span class="sd">        ``sagemaker:/us-east-1/arn:aws:1234:role/assumed_role``.</span>

<span class="sd">        A :py:class:`mlflow.exceptions.MlflowException` will also be thrown when an error occurs</span>
<span class="sd">        while retrieving the deployment.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: Name of deployment to retrieve</span>
<span class="sd">            endpoint: (optional) Endpoint containing the deployment to get. Currently unsupported</span>

<span class="sd">        Returns:</span>
<span class="sd">            A dictionary that describes the specified deployment</span>

<span class="sd">        .. code-block:: python</span>
<span class="sd">            :caption: Python example</span>

<span class="sd">            from mlflow.deployments import get_deploy_client</span>

<span class="sd">            client = get_deploy_client(&quot;sagemaker:/us-east-1/arn:aws:123:role/assumed_role&quot;)</span>
<span class="sd">            client.get_deployment(&quot;my-deployment&quot;)</span>

<span class="sd">        .. code-block:: bash</span>
<span class="sd">            :caption: Command-line example</span>

<span class="sd">            mlflow deployments get --target sagemaker:/us-east-1/arn:aws:1234:role/assumed_role \\</span>
<span class="sd">                --name my-deployment</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">boto3</span>

        <span class="n">assume_role_credentials</span> <span class="o">=</span> <span class="n">_assume_role_and_get_credentials</span><span class="p">(</span>
            <span class="n">assume_role_arn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assumed_role_arn</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">sage_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span>
                <span class="s2">&quot;sagemaker&quot;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">region_name</span><span class="p">,</span> <span class="o">**</span><span class="n">assume_role_credentials</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">sage_client</span><span class="o">.</span><span class="n">describe_endpoint</span><span class="p">(</span><span class="n">EndpointName</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;There was an error while retrieving the deployment: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="SageMakerDeploymentClient.predict"><a class="viewcode-back" href="../../python_api/mlflow.sagemaker.html#mlflow.sagemaker.SageMakerDeploymentClient.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">deployment_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">inputs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">endpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute predictions from the specified deployment using the provided PyFunc input.</span>

<span class="sd">        The input/output types of this method match the :ref:`MLflow PyFunc prediction</span>
<span class="sd">        interface &lt;pyfunc-inference-api&gt;`.</span>

<span class="sd">        If a region name needs to be specified, the plugin must be initialized</span>
<span class="sd">        with the AWS region in the ``target_uri`` such as ``sagemaker:/us-east-1``.</span>

<span class="sd">        To assume an IAM role, the plugin must be initialized</span>
<span class="sd">        with the AWS region and the role ARN in the ``target_uri`` such as</span>
<span class="sd">        ``sagemaker:/us-east-1/arn:aws:1234:role/assumed_role``.</span>

<span class="sd">        Args:</span>
<span class="sd">            deployment_name: Name of the deployment to predict against.</span>
<span class="sd">            inputs: Input data (or arguments) to pass to the deployment or model endpoint for</span>
<span class="sd">                inference. For a complete list of supported input types, see</span>
<span class="sd">                :ref:`pyfunc-inference-api`.</span>
<span class="sd">            endpoint: Endpoint to predict against. Currently unsupported</span>
<span class="sd">            params: Optional parameters to invoke the endpoint with.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A PyFunc output, such as a Pandas DataFrame, Pandas Series, or NumPy array.</span>
<span class="sd">            For a complete list of supported output types, see :ref:`pyfunc-inference-api`.</span>

<span class="sd">        .. code-block:: python</span>
<span class="sd">            :caption: Python example</span>

<span class="sd">            import pandas as pd</span>
<span class="sd">            from mlflow.deployments import get_deploy_client</span>

<span class="sd">            df = pd.DataFrame(data=[[1, 2, 3]], columns=[&quot;feat1&quot;, &quot;feat2&quot;, &quot;feat3&quot;])</span>
<span class="sd">            client = get_deploy_client(&quot;sagemaker:/us-east-1/arn:aws:123:role/assumed_role&quot;)</span>
<span class="sd">            client.predict(&quot;my-deployment&quot;, df)</span>

<span class="sd">        .. code-block:: bash</span>
<span class="sd">            :caption: Command-line example</span>

<span class="sd">            cat &gt; ./input.json &lt;&lt;- input</span>
<span class="sd">            {&quot;feat1&quot;: {&quot;0&quot;: 1}, &quot;feat2&quot;: {&quot;0&quot;: 2}, &quot;feat3&quot;: {&quot;0&quot;: 3}}</span>
<span class="sd">            input</span>

<span class="sd">            mlflow deployments predict \\</span>
<span class="sd">                --target sagemaker:/us-east-1/arn:aws:1234:role/assumed_role \\</span>
<span class="sd">                --name my-deployment \\</span>
<span class="sd">                --input-path ./input.json</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">boto3</span>

        <span class="n">assume_role_credentials</span> <span class="o">=</span> <span class="n">_assume_role_and_get_credentials</span><span class="p">(</span>
            <span class="n">assume_role_arn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assumed_role_arn</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">sage_client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span>
                <span class="s2">&quot;sagemaker-runtime&quot;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">region_name</span><span class="p">,</span> <span class="o">**</span><span class="n">assume_role_credentials</span>
            <span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">sage_client</span><span class="o">.</span><span class="n">invoke_endpoint</span><span class="p">(</span>
                <span class="n">EndpointName</span><span class="o">=</span><span class="n">deployment_name</span><span class="p">,</span>
                <span class="n">Body</span><span class="o">=</span><span class="n">dump_input_data</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">inputs_key</span><span class="o">=</span><span class="s2">&quot;instances&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">),</span>
                <span class="n">ContentType</span><span class="o">=</span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">response_body</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;Body&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">PredictionsResponse</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">response_body</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MlflowException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;There was an error while getting model prediction: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="SageMakerDeploymentClient.explain"><a class="viewcode-back" href="../../python_api/mlflow.sagemaker.html#mlflow.sagemaker.SageMakerDeploymentClient.explain">[docs]</a>    <span class="k">def</span> <span class="nf">explain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deployment_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        *This function has not been implemented and will be coming in the future.*</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;This function is not implemented yet.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SageMakerDeploymentClient.create_endpoint"><a class="viewcode-back" href="../../python_api/mlflow.sagemaker.html#mlflow.sagemaker.SageMakerDeploymentClient.create_endpoint">[docs]</a>    <span class="k">def</span> <span class="nf">create_endpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an endpoint with the specified target. By default, this method should block until</span>
<span class="sd">        creation completes (i.e. until it&#39;s possible to create a deployment within the endpoint).</span>
<span class="sd">        In the case of conflicts (e.g. if it&#39;s not possible to create the specified endpoint</span>
<span class="sd">        due to conflict with an existing endpoint), raises a</span>
<span class="sd">        :py:class:`mlflow.exceptions.MlflowException`. See target-specific plugin documentation</span>
<span class="sd">        for additional detail on support for asynchronous creation and other configuration.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: Unique name to use for endpoint. If another endpoint exists with the same</span>
<span class="sd">                        name, raises a :py:class:`mlflow.exceptions.MlflowException`.</span>
<span class="sd">            config: (optional) Dict containing target-specific configuration for the endpoint.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict corresponding to created endpoint, which must contain the &#39;name&#39; key.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;This function is not implemented yet.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SageMakerDeploymentClient.update_endpoint"><a class="viewcode-back" href="../../python_api/mlflow.sagemaker.html#mlflow.sagemaker.SageMakerDeploymentClient.update_endpoint">[docs]</a>    <span class="k">def</span> <span class="nf">update_endpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the endpoint with the specified name. You can update any target-specific attributes</span>
<span class="sd">        of the endpoint (via `config`). By default, this method should block until the update</span>
<span class="sd">        completes (i.e. until it&#39;s possible to create a deployment within the endpoint). See</span>
<span class="sd">        target-specific plugin documentation for additional detail on support for asynchronous</span>
<span class="sd">        update and other configuration.</span>

<span class="sd">        Args:</span>
<span class="sd">            endpoint: Unique name of endpoint to update</span>
<span class="sd">            config: (optional) dict containing target-specific configuration for the endpoint</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;This function is not implemented yet.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SageMakerDeploymentClient.delete_endpoint"><a class="viewcode-back" href="../../python_api/mlflow.sagemaker.html#mlflow.sagemaker.SageMakerDeploymentClient.delete_endpoint">[docs]</a>    <span class="k">def</span> <span class="nf">delete_endpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete the endpoint from the specified target. Deletion should be idempotent (i.e. deletion</span>
<span class="sd">        should not fail if retried on a non-existent deployment).</span>

<span class="sd">        Args:</span>
<span class="sd">            endpoint: Name of endpoint to delete</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;This function is not implemented yet.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SageMakerDeploymentClient.list_endpoints"><a class="viewcode-back" href="../../python_api/mlflow.sagemaker.html#mlflow.sagemaker.SageMakerDeploymentClient.list_endpoints">[docs]</a>    <span class="k">def</span> <span class="nf">list_endpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List endpoints in the specified target. This method is expected to return an</span>
<span class="sd">        unpaginated list of all endpoints (an alternative would be to return a dict with</span>
<span class="sd">        an &#39;endpoints&#39; field containing the actual endpoints, with plugins able to specify</span>
<span class="sd">        other fields, e.g. a next_page_token field, in the returned dictionary for pagination,</span>
<span class="sd">        and to accept a `pagination_args` argument to this method for passing</span>
<span class="sd">        pagination-related args).</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list of dicts corresponding to endpoints. Each dict is guaranteed to</span>
<span class="sd">            contain a &#39;name&#39; key containing the endpoint name. The other fields of</span>
<span class="sd">            the returned dictionary and their types may vary across targets.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;This function is not implemented yet.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SageMakerDeploymentClient.get_endpoint"><a class="viewcode-back" href="../../python_api/mlflow.sagemaker.html#mlflow.sagemaker.SageMakerDeploymentClient.get_endpoint">[docs]</a>    <span class="k">def</span> <span class="nf">get_endpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a dictionary describing the specified endpoint, throwing a</span>
<span class="sd">        py:class:`mlflow.exception.MlflowException` if no endpoint exists with the provided</span>
<span class="sd">        name.</span>
<span class="sd">        The dict is guaranteed to contain an &#39;name&#39; key containing the endpoint name.</span>
<span class="sd">        The other fields of the returned dictionary and their types may vary across targets.</span>

<span class="sd">        Args:</span>
<span class="sd">            endpoint: Name of endpoint to fetch</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;This function is not implemented yet.&quot;</span><span class="p">)</span></div></div>


<span class="k">class</span> <span class="nc">_SageMakerOperation</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_check_fn</span><span class="p">,</span> <span class="n">cleanup_fn</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_check_fn</span> <span class="o">=</span> <span class="n">status_check_fn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_fn</span> <span class="o">=</span> <span class="n">cleanup_fn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">_SageMakerOperationStatus</span><span class="p">(</span><span class="n">_SageMakerOperationStatus</span><span class="o">.</span><span class="n">STATE_IN_PROGRESS</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_up</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">await_completion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="p">):</span>
        <span class="n">iteration</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">begin</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">timeout_seconds</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_check_fn</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">status</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">_SageMakerOperationStatus</span><span class="o">.</span><span class="n">STATE_IN_PROGRESS</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">iteration</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Log the progress status roughly every 20 seconds</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>

                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                <span class="n">iteration</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>
                <span class="k">return</span> <span class="n">status</span>

        <span class="n">duration_seconds</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">begin</span>
        <span class="k">return</span> <span class="n">_SageMakerOperationStatus</span><span class="o">.</span><span class="n">timed_out</span><span class="p">(</span><span class="n">duration_seconds</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clean_up</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">_SageMakerOperationStatus</span><span class="o">.</span><span class="n">STATE_SUCCEEDED</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot clean up an operation that has not succeeded! Current operation state:&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">state</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_up</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_up</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`clean_up()` has already been executed for this operation!&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_fn</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">_SageMakerOperationStatus</span><span class="p">:</span>
    <span class="n">STATE_SUCCEEDED</span> <span class="o">=</span> <span class="s2">&quot;succeeded&quot;</span>
    <span class="n">STATE_FAILED</span> <span class="o">=</span> <span class="s2">&quot;failed&quot;</span>
    <span class="n">STATE_IN_PROGRESS</span> <span class="o">=</span> <span class="s2">&quot;in progress&quot;</span>
    <span class="n">STATE_TIMED_OUT</span> <span class="o">=</span> <span class="s2">&quot;timed_out&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">in_progress</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;The operation is still in progress.&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">_SageMakerOperationStatus</span><span class="o">.</span><span class="n">STATE_IN_PROGRESS</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">timed_out</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">duration_seconds</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">_SageMakerOperationStatus</span><span class="o">.</span><span class="n">STATE_TIMED_OUT</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Timed out after waiting </span><span class="si">{</span><span class="n">duration_seconds</span><span class="si">}</span><span class="s2"> seconds for the operation to&quot;</span>
            <span class="s2">&quot; complete. This operation may still be in progress. Please check the AWS&quot;</span>
            <span class="s2">&quot; console for more information.&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">failed</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">_SageMakerOperationStatus</span><span class="o">.</span><span class="n">STATE_FAILED</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">succeeded</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">_SageMakerOperationStatus</span><span class="o">.</span><span class="n">STATE_SUCCEEDED</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
</pre></div>

              </div>
            </div>
            <footer>
  

  <hr/>

  <div role="contentinfo">
      <p class="copyright">
          &copy; MLflow Project, a Series of LF Projects, LLC. All rights reserved.
      </p>

  </div> 

</footer>
          </div>
        </div>
      </section>
    </main>
  </page>

  


  
  <script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
      URL_ROOT:'../../',
      VERSION:'2.17.1.dev0',
      COLLAPSE_INDEX:false,
      FILE_SUFFIX:'.html',
      LINK_SUFFIX: '.html',
      HAS_SOURCE:  true
    };
  </script>

  

  <script type="text/javascript" src="../../_static/js/clipboard.min.js"></script>
  <script type="text/javascript" src="../../_static/js/jquery.waypoints.min.js"></script>

  
  
  
  <script type="text/javascript">var CLIPPY_SVG_PATH = "../../_static/clippy.svg";</script>
  <script type="text/javascript" src="../../_static/js/custom.js"></script>
  

  
  
  <script type="text/javascript">
    jQuery(function () {
      SphinxRtdTheme.StickyNav.enable();
    });

  </script>
  

  
  <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function() {
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
        }
        // Get the code block designator class entries
        const allHighlights = document.querySelectorAll('.highlight');
        // Disable copyable links for notebook cell numbering and for cell outputs
        const highlights = Array.from(allHighlights).filter(highlight => !highlight.closest('.highlight-none') && 
            !highlight.closest('.nboutput'));
    
        highlights.forEach(function(highlight) {
            const copyIcon = document.createElement('span');
            copyIcon.classList.add('copy-icon');
            copyIcon.innerHTML = '&#xf0ea;';

            copyIcon.addEventListener('click', function() {
                const code = highlight.querySelector('pre').textContent;
                copyToClipboard(code);

                // Flash effect on click
                this.style.color = '#0194E2';
                setTimeout(() => {
                    this.style.color = ''; 
                }, 100);

                // Display "Code copied to clipboard" near the clicked icon
                const message = document.createElement('span');
                message.textContent = "Copied!";
                message.classList.add('copy-message'); 

                // Append the message to the icon
                this.appendChild(message);

                setTimeout(() => {
                    this.removeChild(message);
                }, 500);
            });

            highlight.appendChild(copyIcon);
        });
    });
  </script>


<script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function() {
        // Force download for notebook-download-btn
        const downloadButtons = document.querySelectorAll('.notebook-download-btn');
        downloadButtons.forEach(function(button) {
            button.addEventListener('click', function(event) {
                event.preventDefault(); // Prevent default behavior

                // Fetch the raw content of the notebook from GitHub
                fetch(button.href)
                    .then(response => response.blob())
                    .then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.style.display = 'none';
                        link.href = url;
                        const filename = button.href.split('/').pop();
                        link.download = filename; 

                        document.body.appendChild(link);
                        link.click();

                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(link);
                    })
                    .catch(err => console.error('Error fetching the notebook:', err));
            });
        });
    });
</script> 
</body>
</html>